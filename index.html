<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß Realtime (‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        /* Navbar */
        .navbar { background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .brand { font-size: 1.2rem; font-weight: bold; color: #1a73e8; cursor: pointer; }
        .nav-menu { display: flex; gap: 15px; align-items: center; }
        .nav-item { cursor: pointer; color: #555; font-size: 0.95rem; }
        .nav-item:hover { color: #1a73e8; }
        .btn-logout { color: #d93025; cursor: pointer; font-weight: bold; border: 1px solid #d93025; padding: 5px 10px; border-radius: 4px; }

        /* Auth Page */
        .auth-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .link-text { color: #1a73e8; cursor: pointer; font-size: 0.9rem; margin-top: 15px; display: block; }
        .admin-code-area { background: #f9f9f9; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.8rem; color: #666; text-align: left; }

        /* General UI */
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #1a73e8; margin: 0; }
        .btn-primary { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
        .tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; }
        .tag.movie { background: #e8f0fe; color: #1a73e8; }
        .tag.event { background: #fce8e6; color: #d93025; }

        /* Admin Controls */
        .admin-actions { display: flex; gap: 5px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: none; color: white; flex: 1; }
        .btn-edit { background: #f39c12; } .btn-del { background: #e74c3c; } 
        .admin-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #e8f0fe; padding: 15px; border-radius: 8px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: 600; }

        /* Seat Styles */
        .screen { background: #444; color: white; text-align: center; padding: 5px; margin: 20px 0; border-radius: 5px; box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
        .seat-map { display: grid; justify-content: center; gap: 10px; margin: 20px 0; overflow-x: auto; padding-bottom: 10px; }
        .seat { 
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white;
            transition: all 0.2s; position: relative;
        }
        .seat.available { background-color: #fff; border: 2px solid #28a745; color: #28a745; }
        .seat.available:hover { background-color: #28a745; color: white; }
        .seat.booked { background-color: #dc3545; border: 2px solid #dc3545; cursor: not-allowed; opacity: 0.6; }
        .seat.selecting { background-color: #ffc107; border: 2px solid #ffc107; color: #333; cursor: not-allowed; animation: pulse 1.5s infinite; }
        .seat.blocked { background-color: #e2e6ea; border: 2px solid #ced4da; color: #adb5bd; cursor: not-allowed; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Modal & Helpers */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .hidden { display: none !important; }
        .nav-back { margin-bottom: 20px; cursor: pointer; color: #555; font-weight: bold; }
        .legend { display: flex; gap: 15px; font-size: 0.9rem; justify-content: center; margin-top: 20px; flex-wrap: wrap;}
        .legend-item { display: flex; align-items: center; gap: 5px; } .dot { width: 15px; height: 15px; border-radius: 3px; }
    </style>
</head>
<body>

<nav class="navbar hidden" id="main-nav">
    <div class="brand" onclick="goHome()">üéüÔ∏è TicketSystem</div>
    <div class="nav-menu">
        <span class="nav-item" onclick="goHome()">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        <span class="nav-item" onclick="showProfile()">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</span>
        <span id="nav-admin-users" class="nav-item hidden" onclick="showUserManagement()" style="color:#d93025;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
        <span class="btn-logout" onclick="doLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
    </div>
</nav>

<div class="container">

    <div id="page-auth" class="auth-container">
        <h2 id="auth-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <form id="auth-form" onsubmit="handleAuth(event)">
            <input type="email" id="auth-email" class="auth-input" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
            <input type="password" id="auth-pass" class="auth-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
            
            <div id="register-fields" class="hidden">
                <input type="text" id="reg-name" class="auth-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                <input type="tel" id="reg-phone" class="auth-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                <input type="text" id="reg-idcard" class="auth-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)" maxlength="13">
                <div class="admin-code-area">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
                    <input type="text" id="reg-admin-code" class="auth-input" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Admin" style="margin-top:5px;">
                    <small>* ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ "ADMIN999" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</small>
                </div>
            </div>

            <button type="submit" class="btn-primary" id="btn-auth-submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
        <span class="link-text" id="toggle-auth" onclick="toggleAuthMode()">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
    </div>

    <div id="page-home" class="hidden">
        <div id="admin-panel-home" class="admin-bar hidden">
            <span>üîß <b>Admin Dashboard</b></span>
            <div>
                <button class="btn-sm" style="background:#2ecc71; padding:8px 15px;" onclick="openAdminModal('movie')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á</button>
                <button class="btn-sm" style="background:#2ecc71; padding:8px 15px;" onclick="openAdminModal('event')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</button>
            </div>
        </div>

        <header><h1>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á</h1></header>
        <div id="movie-list" class="grid-container" style="margin-bottom: 30px;"></div>
        <div id="event-list" class="grid-container"></div>
    </div>

    <div id="page-profile" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
        <div class="card" style="margin-bottom:20px;">
            <form onsubmit="updateUserProfile(event)">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label> <input type="text" id="p-name" class="auth-input">
                <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</label> <input type="tel" id="p-phone" class="auth-input">
                <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</label> <input type="text" id="p-idcard" class="auth-input" readonly style="background:#eee; color:#777;">
                <button type="submit" class="btn-primary" style="width:auto; margin-top:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </form>
        </div>
        <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
        <table id="history-table">
            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead>
            <tbody id="history-list"></tbody>
        </table>
    </div>

    <div id="page-users" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
        <table>
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>Role</th></tr></thead>
            <tbody id="user-list-admin"></tbody>
        </table>
    </div>

    <div id="page-movie" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2 id="m-title" style="text-align:center;">Title</h2>
        <div class="screen">‡∏à‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</div>
        <div id="seat-map" class="seat-map"></div>
        <div class="legend">
            <div class="legend-item"><div class="dot" style="border:2px solid #28a745;"></div> ‡∏ß‡πà‡∏≤‡∏á</div>
            <div class="legend-item"><div class="dot" style="background:#ffc107;"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
            <div class="legend-item"><div class="dot" style="background:#dc3545;"></div> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
            <div class="legend-item"><div class="dot" style="background:#e2e6ea;"></div> ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á</div>
        </div>
    </div>

    <div id="page-event" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <div style="text-align:center; background:white; padding:30px; border-radius:12px;">
            <h2 id="e-title">Event Title</h2>
            <p>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="e-remaining" style="font-weight:bold; color:#d93025;">-</span> / <span id="e-capacity">-</span></p>
            <button id="btn-event-book" class="btn-primary" style="max-width: 200px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>
    </div>

</div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="cancelSelection()">&times;</span>
        <h3 id="modal-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
        <p id="modal-subtitle" style="color:#666; margin-bottom: 20px;">-</p>
        <div style="background:#f9f9f9; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.9rem;">
            <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="conf-name"></span></p>
            <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <span id="conf-phone"></span></p>
            <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <span id="conf-email"></span></p>
        </div>
        <button onclick="submitBooking()" class="btn-primary" style="background:#28a745;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
    </div>
</div>

<div id="admin-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAdminModal()">&times;</span>
        <h3 id="adm-title-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <form onsubmit="saveAdminItem(event)">
            <input type="hidden" id="adm-id">
            <input type="hidden" id="adm-type">
            
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label><input type="text" id="adm-title" class="auth-input" required>
            <label>‡πÄ‡∏£‡∏¥‡πà‡∏°:</label><input type="datetime-local" id="adm-start" class="auth-input" required>
            <label>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label><input type="datetime-local" id="adm-end" class="auth-input" required>

            <div id="adm-movie-fields" class="hidden">
                <div style="display:flex; gap:10px;">
                    <div style="width:50%"><label>‡πÅ‡∏ñ‡∏ß:</label><input type="number" id="adm-rows" class="auth-input"></div>
                    <div style="width:50%"><label>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡πÅ‡∏ñ‡∏ß:</label><input type="number" id="adm-cols" class="auth-input"></div>
                </div>
                <label>Blocked (ex: A1,A2):</label><input type="text" id="adm-blocked" class="auth-input">
            </div>

            <div id="adm-event-fields" class="hidden">
                <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ (-1=‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î):</label><input type="number" id="adm-cap" class="auth-input">
            </div>

            <button type="submit" class="btn-primary" style="background:#2ecc71;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, push, set, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        databaseURL: "https://booking-system-c1ebd-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Global State
    let currentUser = null;
    let userRole = 'user'; // 'admin' or 'user'
    let userData = {};
    let isRegistering = false;
    let allData = {};

    let currentType = ''; 
    let currentId = '';
    let selectedTarget = '';
    let currentConfig = null;
    let tempSeatRef = null;

    // --- 1. Authentication & Routing ---
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            // Logged In -> Fetch User Data
            onValue(ref(db, 'users/' + user.uid), (snap) => {
                userData = snap.val() || {};
                userRole = userData.role || 'user';
                renderNavbar();
                // If on auth page, go home. Else stay (to prevent refresh loop, simplified here)
                if(!document.getElementById('page-auth').classList.contains('hidden')) {
                    goHome();
                }
            });
            // Fetch Main Data
            onValue(ref(db, '/'), (snapshot) => {
                allData = snapshot.val() || {};
                renderHomeList();
            });
        } else {
            // Logged Out
            showPage('page-auth');
            document.getElementById('main-nav').classList.add('hidden');
        }
    });

    window.toggleAuthMode = () => {
        isRegistering = !isRegistering;
        document.getElementById('auth-title').innerText = isRegistering ? "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà" : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
        document.getElementById('btn-auth-submit').innerText = isRegistering ? "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
        document.getElementById('toggle-auth').innerText = isRegistering ? "‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
        document.getElementById('register-fields').classList.toggle('hidden');
    }

    window.handleAuth = (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;

        if(isRegistering) {
            createUserWithEmailAndPassword(auth, email, pass).then((cred) => {
                const code = document.getElementById('reg-admin-code').value;
                const role = (code === 'ADMIN999') ? 'admin' : 'user';
                const newUserData = {
                    name: document.getElementById('reg-name').value,
                    phone: document.getElementById('reg-phone').value,
                    idCard: document.getElementById('reg-idcard').value,
                    email: email,
                    role: role
                };
                set(ref(db, 'users/' + cred.user.uid), newUserData);
            }).catch(err => alert(err.message));
        } else {
            signInWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
        }
    };

    window.doLogout = () => signOut(auth);

    function renderNavbar() {
        document.getElementById('main-nav').classList.remove('hidden');
        if(userRole === 'admin') document.getElementById('nav-admin-users').classList.remove('hidden');
        else document.getElementById('nav-admin-users').classList.add('hidden');
    }

    // --- 2. Views & Navigation ---
    function showPage(pid) {
        ['page-auth', 'page-home', 'page-movie', 'page-event', 'page-profile', 'page-users'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(pid).classList.remove('hidden');
    }

    window.goHome = () => {
        if(currentType === 'movie' && tempSeatRef) cancelSelection();
        showPage('page-home');
        renderHomeList();
    }

    // --- 3. Home & Listings (User + Admin Actions) ---
    function renderHomeList() {
        const mList = document.getElementById('movie-list');
        const eList = document.getElementById('event-list');
        mList.innerHTML = ''; eList.innerHTML = '';

        if(userRole === 'admin') document.getElementById('admin-panel-home').classList.remove('hidden');

        if(allData.movies) Object.keys(allData.movies).forEach(k => mList.appendChild(createCard(k, allData.movies[k].config, 'movie')));
        if(allData.events) Object.keys(allData.events).forEach(k => eList.appendChild(createCard(k, allData.events[k].config, 'event')));
    }

    function createCard(id, data, type) {
        if(!data) return document.createElement('div');
        const div = document.createElement('div');
        div.className = 'card';
        
        let adminHtml = '';
        if(userRole === 'admin') {
            adminHtml = `
                <div class="admin-actions">
                    <button class="btn-sm btn-edit" onclick="editItem('${id}','${type}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn-sm btn-del" onclick="deleteItem('${id}','${type}')">‡∏•‡∏ö</button>
                </div>
            `;
        }

        div.innerHTML = `
            <span class="tag ${type}">${type==='movie'?'‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå':'‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå'}</span>
            <h3>${data.title}</h3>
            <p>üìÖ ${new Date(data.start).toLocaleString()}</p>
            ${adminHtml}
        `;
        // Click on card body to book, avoid admin buttons
        div.onclick = (e) => {
            if(e.target.tagName !== 'BUTTON') {
                if(type === 'movie') openMoviePage(id);
                else openEventPage(id);
            }
        }
        return div;
    }

    // --- 4. User Profile & History ---
    window.showProfile = () => {
        showPage('page-profile');
        document.getElementById('p-name').value = userData.name || '';
        document.getElementById('p-phone').value = userData.phone || '';
        document.getElementById('p-idcard').value = userData.idCard || '';

        const hList = document.getElementById('history-list');
        hList.innerHTML = '';
        const history = userData.history || {};
        if(Object.keys(history).length === 0) {
            hList.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</td></tr>';
        } else {
            Object.values(history).reverse().forEach(h => {
                hList.innerHTML += `<tr>
                    <td>${new Date(h.timestamp).toLocaleDateString()}</td>
                    <td>${h.itemTitle}</td>
                    <td>${h.detail}</td>
                </tr>`;
            });
        }
    }

    window.updateUserProfile = (e) => {
        e.preventDefault();
        update(ref(db, `users/${currentUser.uid}`), {
            name: document.getElementById('p-name').value,
            phone: document.getElementById('p-phone').value
        }).then(() => alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
    }

    // --- 5. Admin: User Management & CRUD ---
    window.showUserManagement = () => {
        showPage('page-users');
        onValue(ref(db, 'users'), (snap) => {
            const list = document.getElementById('user-list-admin');
            list.innerHTML = '';
            snap.forEach(child => {
                const u = child.val();
                list.innerHTML += `<tr><td>${u.name}</td><td>${u.email}</td><td>${u.phone}</td><td><span class="tag ${u.role==='admin'?'event':'movie'}">${u.role}</span></td></tr>`;
            });
        });
    }

    window.openAdminModal = (type) => {
        document.getElementById('admin-modal').classList.add('active');
        document.getElementById('adm-id').value = '';
        document.getElementById('adm-type').value = type;
        document.getElementById('adm-title-text').innerText = `‡πÄ‡∏û‡∏¥‡πà‡∏° ${type}`;
        
        document.querySelectorAll('#admin-modal input:not([type=hidden])').forEach(i => i.value = '');
        
        if(type === 'movie') {
            document.getElementById('adm-movie-fields').classList.remove('hidden');
            document.getElementById('adm-event-fields').classList.add('hidden');
        } else {
            document.getElementById('adm-movie-fields').classList.add('hidden');
            document.getElementById('adm-event-fields').classList.remove('hidden');
        }
    }

    window.closeAdminModal = () => document.getElementById('admin-modal').classList.remove('active');

    window.editItem = (id, type) => {
        window.openAdminModal(type);
        document.getElementById('adm-title-text').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        document.getElementById('adm-id').value = id;
        
        const data = (type==='movie' ? allData.movies[id].config : allData.events[id].config);
        document.getElementById('adm-title').value = data.title;
        document.getElementById('adm-start').value = data.start;
        document.getElementById('adm-end').value = data.end;

        if(type==='movie') {
            document.getElementById('adm-rows').value = data.rows;
            document.getElementById('adm-cols').value = data.cols;
            document.getElementById('adm-blocked').value = data.blocked || '';
        } else {
            document.getElementById('adm-cap').value = data.capacity;
        }
    }

    window.deleteItem = (id, type) => {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ")) {
            remove(ref(db, `${type==='movie'?'movies':'events'}/${id}`));
        }
    }

    window.saveAdminItem = (e) => {
        e.preventDefault();
        const id = document.getElementById('adm-id').value;
        const type = document.getElementById('adm-type').value;
        const isNew = (id === '');
        
        const payload = {
            title: document.getElementById('adm-title').value,
            start: document.getElementById('adm-start').value,
            end: document.getElementById('adm-end').value
        };

        if(type === 'movie') {
            payload.rows = parseInt(document.getElementById('adm-rows').value);
            payload.cols = parseInt(document.getElementById('adm-cols').value);
            payload.blocked = document.getElementById('adm-blocked').value;
        } else {
            payload.capacity = parseInt(document.getElementById('adm-cap').value);
        }

        const targetRef = isNew 
            ? push(ref(db, type === 'movie' ? 'movies' : 'events'))
            : ref(db, `${type === 'movie' ? 'movies' : 'events'}/${id}`);
        
        const updateData = isNew ? { config: payload } : { config: payload };
        if(isNew && type === 'event') updateData.currentBooked = 0;

        (isNew ? set(targetRef, updateData) : update(targetRef, { config: payload }))
            .then(() => { closeAdminModal(); });
    }

    // --- 6. Booking Logic (Modified for Auth) ---
    window.openMoviePage = (id) => {
        currentType = 'movie'; currentId = id; showPage('page-movie');
        onValue(ref(db, `movies/${id}/config`), (snap) => {
            currentConfig = snap.val();
            document.getElementById('m-title').innerText = currentConfig.title;
            renderSeatsBase(currentConfig);
        });
        onValue(ref(db, `movies/${id}`), (snap) => {
            const data = snap.val() || {};
            updateSeatStatus(data.bookings || {}, data.temp_selections || {});
        });
    }

    function renderSeatsBase(conf) {
        const map = document.getElementById('seat-map');
        map.innerHTML = '';
        map.style.gridTemplateColumns = `repeat(${conf.cols}, 1fr)`;
        for(let r=0; r<conf.rows; r++) {
            const rowLabel = String.fromCharCode(65 + r);
            for(let c=1; c<=conf.cols; c++) {
                const seatId = `${rowLabel}${c}`;
                const seat = document.createElement('div');
                seat.className = 'seat available';
                seat.id = `seat-${seatId}`;
                seat.innerText = seatId;
                
                if(conf.blocked && conf.blocked.includes(seatId)) {
                    seat.classList.add('blocked'); seat.classList.remove('available');
                } else {
                    seat.onclick = () => selectSeat(seatId);
                }
                map.appendChild(seat);
            }
        }
    }

    function updateSeatStatus(bookings, temps) {
        document.querySelectorAll('.seat').forEach(s => {
            const sid = s.id.replace('seat-', '');
            if(s.classList.contains('blocked')) return;
            s.className = 'seat available'; s.onclick = () => selectSeat(sid);

            if(bookings[sid]) {
                s.className = 'seat booked'; s.onclick = null;
            } else if(temps[sid]) {
                if (Date.now() - temps[sid].timestamp < 5 * 60 * 1000) {
                    s.className = 'seat selecting'; s.onclick = null;
                }
            }
        });
    }

    window.selectSeat = (seatId) => {
        if(!checkTime(currentConfig.start, currentConfig.end)) return;
        const tempRef = ref(db, `movies/${currentId}/temp_selections/${seatId}`);
        
        runTransaction(tempRef, (curr) => {
            if (curr === null || Date.now() - curr.timestamp > 5 * 60 * 1000) {
                return { timestamp: Date.now(), user_uid: currentUser.uid };
            }
            return;
        }).then((res) => {
            if (res.committed) {
                selectedTarget = seatId;
                tempSeatRef = tempRef;
                onDisconnect(tempRef).remove();
                openBookingModal(`‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: ${seatId}`);
            } else { alert("‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß"); }
        });
    }

    window.openEventPage = (id) => {
        currentType = 'event'; currentId = id; showPage('page-event');
        onValue(ref(db, `events/${id}`), (snap) => {
            const d = snap.val(); if(!d) return;
            currentConfig = d.config;
            const cap = d.config.capacity;
            const cur = d.currentBooked || 0;
            
            document.getElementById('e-title').innerText = currentConfig.title;
            document.getElementById('e-remaining').innerText = cap==-1 ? '‚àû' : (cap - cur);
            document.getElementById('e-capacity').innerText = cap==-1 ? '‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î' : cap;

            const btn = document.getElementById('btn-event-book');
            if(cap!=-1 && cur>=cap) { btn.disabled=true; btn.innerText="‡πÄ‡∏ï‡πá‡∏°"; btn.style.background="#ccc"; }
            else { 
                btn.disabled=false; btn.innerText="‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô"; btn.style.background="#1a73e8"; 
                btn.onclick=()=> {
                    if(!checkTime(currentConfig.start, currentConfig.end)) return;
                    openBookingModal("‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô");
                }
            }
        });
    }

    function openBookingModal(detail) {
        document.getElementById('modal-subtitle').innerText = detail;
        document.getElementById('conf-name').innerText = userData.name;
        document.getElementById('conf-phone').innerText = userData.phone;
        document.getElementById('conf-email').innerText = userData.email;
        document.getElementById('booking-modal').classList.add('active');
    }

    window.cancelSelection = () => {
        document.getElementById('booking-modal').classList.remove('active');
        if(currentType === 'movie' && tempSeatRef) {
            remove(tempSeatRef);
            onDisconnect(tempSeatRef).cancel();
            tempSeatRef = null; selectedTarget = '';
        }
    }

    window.submitBooking = () => {
        const bookingData = {
            uid: currentUser.uid,
            name: userData.name,
            phone: userData.phone,
            email: userData.email,
            idCard: userData.idCard,
            timestamp: Date.now()
        };

        if(currentType === 'movie') {
            set(ref(db, `movies/${currentId}/bookings/${selectedTarget}`), bookingData)
                .then(() => {
                    if(tempSeatRef) remove(tempSeatRef);
                    saveHistory(currentConfig.title, `‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ${selectedTarget}`);
                    cancelSelection(); 
                    alert("‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                });
        } else {
            const eventRef = ref(db, `events/${currentId}`);
            runTransaction(eventRef, (data) => {
                if(data) {
                    if(data.config.capacity != -1 && (data.currentBooked||0) >= data.config.capacity) return;
                    data.currentBooked = (data.currentBooked || 0) + 1;
                }
                return data;
            }).then((res) => {
                if(res.committed) {
                    push(ref(db, `events/${currentId}/bookings`), bookingData);
                    saveHistory(currentConfig.title, "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô");
                    cancelSelection(); 
                    alert("‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                } else { alert("‚ùå ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß"); }
            });
        }
    }

    function saveHistory(title, detail) {
        push(ref(db, `users/${currentUser.uid}/history`), {
            itemTitle: title, detail: detail, timestamp: Date.now()
        });
    }

    function checkTime(s, e) {
        const n = new Date();
        if(n < new Date(s)) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á"); return false; }
        if(n > new Date(e)) { alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß"); return false; }
        return true;
    }
</script>

</body>
</html>
