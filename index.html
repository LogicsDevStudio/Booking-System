<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß Realtime (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        /* Navbar */
        .navbar { background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; overflow-x: auto; }
        .brand { font-size: 1.2rem; font-weight: bold; color: #1a73e8; cursor: pointer; white-space: nowrap; margin-right: 20px; }
        .nav-menu { display: flex; gap: 15px; align-items: center; white-space: nowrap; }
        .nav-item { cursor: pointer; color: #555; font-size: 0.95rem; }
        .nav-item:hover { color: #1a73e8; }
        .btn-logout { color: #d93025; cursor: pointer; font-weight: bold; border: 1px solid #d93025; padding: 5px 10px; border-radius: 4px; }

        /* Auth Page */
        .auth-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: 'Sarabun'; }
        .link-text { color: #1a73e8; cursor: pointer; font-size: 0.9rem; margin-top: 15px; display: block; }
        .admin-code-area { background: #f9f9f9; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.8rem; color: #666; text-align: left; }

        /* General UI */
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #1a73e8; margin: 0; }
        .btn-primary { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-secondary { padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s;}
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; height: 250px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; background: #eee;}
        .tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; font-weight: bold;}
        .tag.movie { background: #e8f0fe; color: #1a73e8; }
        .tag.event { background: #fce8e6; color: #d93025; }

        /* Detail Header Section */
        .item-details { display: flex; gap: 20px; background: #fff; padding: 20px; border-radius: 12px; margin-top: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .item-details img { width: 220px; height: 320px; object-fit: cover; border-radius: 8px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1);}
        .item-info { flex: 1; min-width: 250px; }
        .item-info p { margin: 8px 0; }

        /* Admin Controls */
        .admin-actions { display: flex; gap: 5px; margin-top: auto; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: none; color: white; flex: 1; margin-right: 2px;}
        .btn-edit { background: #f39c12; } .btn-del { background: #e74c3c; } 
        .admin-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #e8f0fe; padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px;}

        /* Schedule List Styles */
        .schedule-item { background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .schedule-info { flex: 1; }
        .schedule-stats { font-size: 0.9em; color: #666; background: #f8f9fa; padding: 5px 10px; border-radius: 4px; margin-right: 10px; display:inline-block; margin-bottom:5px;}
        .stat-val { font-weight: bold; color: #333; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: 600; }

        /* Seat Styles */
        .screen { background: #444; color: white; text-align: center; padding: 5px; margin: 20px 0; border-radius: 5px; box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
        .seat-map { display: grid; justify-content: center; gap: 10px; margin: 20px 0; overflow-x: auto; padding-bottom: 10px; }
        .seat { 
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white;
            transition: all 0.2s; position: relative;
        }
        .seat.available { background-color: #fff; border: 2px solid #28a745; color: #28a745; }
        .seat.available:hover { background-color: #28a745; color: white; }
        .seat.booked { background-color: #dc3545; border: 2px solid #dc3545; cursor: not-allowed; opacity: 0.6; }
        .seat.selecting { background-color: #ffc107; border: 2px solid #ffc107; color: #333; cursor: not-allowed; animation: pulse 1.5s infinite; }
        .seat.blocked { background-color: #e2e6ea; border: 2px solid #ced4da; color: #adb5bd; cursor: not-allowed; }
        .seat.pending { background-color: #f39c12; border: 2px solid #e67e22; color: white; cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Modal & Helpers */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .hidden { display: none !important; }
        .nav-back { margin-bottom: 20px; cursor: pointer; color: #555; font-weight: bold; }
        .legend { display: flex; gap: 15px; font-size: 0.9rem; justify-content: center; margin-top: 20px; flex-wrap: wrap;}
        .legend-item { display: flex; align-items: center; gap: 5px; } .dot-legend { width: 15px; height: 15px; border-radius: 3px; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: 'Sarabun'; }
        .modal-buttons { margin-top: 20px; text-align: right; }

        /* Payment & Ticket UI */
        .payment-qr-container { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 15px; }
        .payment-qr-container img { width: 200px; height: 200px; object-fit: contain; margin: 10px 0; }
        .timer-text { font-size: 1.5rem; font-weight: bold; color: #e74c3c; margin: 5px 0; animation: pulse 1s infinite; }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏´‡∏ô‡πâ‡∏≤ Scan */
        #qr-reader { width: 100%; border-radius: 8px; overflow: hidden; margin: 0 auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .scan-msg { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; text-align: center; font-size: 1.1rem;}
        .scan-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .scan-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* E-Ticket Design */
        #eticket-modal .modal-content { background: transparent; box-shadow: none; max-width: 750px; padding: 0; }
        #eticket-modal .close-btn { color: white; background: #333; border-radius: 50%; width: 35px; height: 35px; text-align: center; line-height: 35px; right: -10px; top: -15px; opacity: 1; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .ticket-card { display: flex; background: #fff; border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); overflow: hidden; position: relative; width: 100%; margin: 0 auto; text-align: left; border: none; padding: 0; }
        .ticket-card::before, .ticket-card::after { display: none; }
        .ticket-left { flex: 2; padding: 30px; background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%); color: white; position: relative; }
        .t-subtitle { font-size: 0.9rem; color: #bbdefb; margin-bottom: 5px; font-weight: 600; letter-spacing: 1px; }
        .t-title-main { font-size: 1.8rem; font-weight: bold; margin-bottom: 25px; text-transform: uppercase; line-height: 1.3;}
        .t-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .t-label { font-size: 0.8rem; color: #90caf9; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px;}
        .t-value { font-size: 1.1rem; font-weight: bold; color: white;}
        .t-value.highlight { color: #ffc107; font-size: 1.4rem; }
        .ticket-right { flex: 1; min-width: 220px; padding: 30px; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border-left: 3px dashed #ccc; }
        .ticket-right::before, .ticket-right::after { content: ''; position: absolute; left: -16px; width: 30px; height: 30px; background: rgba(0,0,0,0.5); border-radius: 50%; }
        .ticket-right::before { top: -15px; } .ticket-right::after { bottom: -15px; }
        .ticket-qr img { width: 160px; height: 160px; border: 1px solid #eee; padding: 8px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .scan-text { color: #1a73e8; font-weight: bold; margin-bottom: 15px; font-size: 1.3rem; letter-spacing: 2px; }
        .watermark-used { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-25deg); font-size: 4rem; color: rgba(220, 53, 69, 0.85); border: 8px solid rgba(220, 53, 69, 0.85); padding: 15px 40px; border-radius: 20px; z-index: 100; pointer-events: none; font-weight: 900; text-transform: uppercase; letter-spacing: 8px; text-shadow: 3px 3px 0px #fff, -3px -3px 0px #fff, 3px -3px 0px #fff, -3px 3px 0px #fff; box-shadow: inset 0 0 20px rgba(220, 53, 69, 0.5), 0 0 20px rgba(220, 53, 69, 0.5); }
        @media (max-width: 600px) {
            .ticket-card { flex-direction: column; }
            .ticket-right { border-left: none; border-top: 3px dashed #ccc; padding: 40px 20px 20px 20px; }
            .ticket-right::before { top: -16px; left: -15px; }
            .ticket-right::after { top: -16px; left: auto; right: -15px; bottom: auto;}
            .watermark-used { font-size: 2.5rem; padding: 10px 20px; }
        }

        /* üåü ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Banner Slider üåü */
        #banner-slider-container {
            position: relative;
            width: 100%;
            max-height: 350px;
            overflow: hidden;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #banner-slider-track {
            display: flex;
            transition: transform 0.5s ease-in-out;
            width: 100%;
        }
        .banner-slide {
            flex: 0 0 100%;
            box-sizing: border-box;
        }
        .banner-slide img {
            width: 100%;
            height: 350px;
            object-fit: cover;
            display: block;
            transition: transform 0.3s;
        }
        .banner-slide a:hover img {
            transform: scale(1.02);
        }
        .banner-dots-wrapper {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 10;
        }
        .slider-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin: 0 5px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .slider-dot.active {
            background: #fff;
            transform: scale(1.2);
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á */
        .filter-bar {
            display: flex; gap: 15px; flex-wrap: wrap; 
            margin-bottom: 25px; background: #fff; 
            padding: 20px; border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            align-items: flex-end;
        }
        .filter-item { flex: 1; min-width: 200px; }
        .filter-item label { display: block; font-weight: bold; font-size: 0.9rem; color: #555; margin-bottom: 8px; }
        .filter-item select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-family: 'Sarabun'; cursor: pointer; outline: none;}
    </style>
</head>
<body>

<nav class="navbar hidden" id="main-nav">
    <div class="brand" onclick="goHome()">üéüÔ∏è TicketSystem</div>
    <div class="nav-menu">
        <span class="nav-item" onclick="goHome()">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        <span id="nav-profile" class="nav-item hidden" onclick="showProfile()">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
        <span id="nav-admin-scan" class="nav-item hidden" onclick="showScanPage()" style="color:#d93025; font-weight:bold;">üì∑ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</span>
        <span id="nav-admin-orders" class="nav-item hidden" onclick="showOrderManagement()" style="color:#d93025;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
        <span id="nav-admin-users" class="nav-item hidden" onclick="showUserManagement()" style="color:#d93025;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
        <span id="nav-admin-tickets" class="nav-item hidden" onclick="showTicketTypesManagement()" style="color:#d93025;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</span>
        <span id="nav-login" class="nav-item" onclick="showPage('page-auth')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
        <span id="nav-logout" class="btn-logout hidden" onclick="doLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
    </div>
</nav>

<div class="container">

    <div id="page-auth" class="auth-container">
        <h2 id="auth-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <form id="auth-form" onsubmit="handleAuth(event)">
            <input type="email" id="auth-email" class="auth-input" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
            <input type="password" id="auth-pass" class="auth-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
            
            <div id="forgot-password-link" style="text-align: right; margin-top: -10px; margin-bottom: 15px;">
                <a href="javascript:void(0)" onclick="showForgotPasswordModal()" style="font-size: 0.85rem; color: #1a73e8; text-decoration: none; font-weight: 600;">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a>
            </div>

            <div id="register-fields" class="hidden">
                <input type="text" id="reg-name" class="auth-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                <input type="tel" id="reg-phone" class="auth-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                <input type="text" id="reg-idcard" class="auth-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)" maxlength="13">
                <div class="admin-code-area">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
                    <input type="text" id="reg-admin-code" class="auth-input" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Admin" style="margin-top:5px;">
                    <small>* ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ "ADMIN999" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</small>
                </div>
            </div>
            <button type="submit" class="btn-primary" id="btn-auth-submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
        <span class="link-text" id="toggle-auth" onclick="toggleAuthMode()">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
    </div>

    <div id="page-home" class="hidden">
        <div id="admin-panel-home" class="admin-bar hidden">
            <span>üîß <b>Admin Dashboard</b></span>
            <div>
                <button class="btn-sm" style="background:#8e44ad; padding:8px 15px;" onclick="showBannerManagement()">üñºÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</button>
                <button class="btn-sm" style="background:#2ecc71; padding:8px 15px;" onclick="openItemModal('movie')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                <button class="btn-sm" style="background:#2ecc71; padding:8px 15px;" onclick="openItemModal('event')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <div id="banner-slider-container" class="hidden">
            <div id="banner-slider-track"></div>
            <div class="banner-dots-wrapper" id="banner-slider-dots"></div>
        </div>

        <h1 style="margin-bottom: 15px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á</h1>

        <div class="filter-bar">
            <div class="filter-item">
                <label>üìç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà / ‡πÇ‡∏£‡∏á‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</label>
                <select id="filter-location" onchange="applyFilters()">
                    <option value="">-- ‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>
                </select>
            </div>
            <div class="filter-item">
                <label>üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                <select id="filter-category" onchange="applyFilters()">
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏´‡∏ô‡∏±‡∏á/‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå)</option>
                    <option value="movie">üé¨ ‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</option>
                    <option value="event">üé§ ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</option>
                </select>
            </div>
            <div class="filter-item">
                <label>üîΩ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                <select id="filter-sort" onchange="applyFilters()">
                    <option value="closest">‡∏£‡∏≠‡∏ö‡∏â‡∏≤‡∏¢/‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                    <option value="newest">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏Å‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î)</option>
                    <option value="priceAsc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏±‡πã‡∏ß (‡∏ï‡πà‡∏≥‡πÑ‡∏õ‡∏™‡∏π‡∏á)</option>
                    <option value="priceDesc">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏±‡πã‡∏ß (‡∏™‡∏π‡∏á‡πÑ‡∏õ‡∏ï‡πà‡∏≥)</option>
                </select>
            </div>
        </div>

        <div id="items-grid" class="grid-container" style="margin-bottom: 30px;"></div>
    </div>

    <div id="page-detail" class="hidden">
        <button class="btn-secondary" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        
        <div class="item-details" id="detail-header">
            </div>

        <div id="admin-panel-detail" class="admin-bar hidden">
            <span>üîß <b>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ö (Admin)</b></span>
            <div>
                <button class="btn-sm btn-edit" style="padding:8px 15px;" onclick="editCurrentItem()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å</button>
                <button class="btn-sm" style="background:#2ecc71; padding:8px 15px;" onclick="openRoundModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
                <button class="btn-sm btn-del" style="padding:8px 15px; margin-left: 5px;" onclick="deleteCurrentItem()">üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>

        <div id="schedule-section">
            <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö <span id="schedule-type-text"></span></h3>
            <div class="schedule-list" id="schedule-list"></div>
        </div>
        
        <div id="movie-seat-section" class="hidden">
            <div style="margin: 10px 0; display:flex; align-items:center; gap:15px;">
                <button class="btn-sm" onclick="backToSchedule()" style="background:#6c757d">‚¨Ö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏∑‡πà‡∏ô</button>
                <span style="font-weight:bold; font-size:1.1rem;">‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤: <span id="seat-round-time" style="color:#1a73e8;"></span></span>
            </div>
            <div class="screen">‡∏à‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå / ‡πÄ‡∏ß‡∏ó‡∏µ</div>
            <div class="seat-map" id="seat-map"></div>
            <div class="legend">
                <div class="legend-item"><div class="dot-legend" style="border:2px solid #28a745;"></div> ‡∏ß‡πà‡∏≤‡∏á</div>
                <div class="legend-item"><div class="dot-legend" style="background:#f39c12;"></div> ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
                <div class="legend-item"><div class="dot-legend" style="background:#dc3545;"></div> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
                <div class="legend-item"><div class="dot-legend" style="background:#e2e6ea;"></div> ‡∏õ‡∏¥‡∏î</div>
            </div>
        </div>

        <div id="event-booking-section" class="hidden">
             <div style="margin: 10px 0; display:flex; align-items:center; gap:15px;">
                <button class="btn-sm" onclick="backToSchedule()" style="background:#6c757d">‚¨Ö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏∑‡πà‡∏ô</button>
                <span style="font-weight:bold; font-size:1.1rem;">‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤: <span id="e-round-time" style="color:#d93025;"></span></span>
            </div>
            <div class="card" style="cursor:default; text-align:center;">
                <h3 style="margin-top:0;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                <p style="font-size:1.1rem;">‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="e-remaining" style="color:#d93025; font-weight:bold; font-size:1.3rem;"></span> / <span id="e-capacity"></span></p>
                <button id="btn-event-book" class="btn-primary" style="width:100%; max-width:300px; margin-top:15px;">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
            </div>
        </div>
    </div>

    <div id="page-profile" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
        <div class="card" style="margin-bottom:20px; cursor:default;">
            <form onsubmit="updateUserProfile(event)">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label> <input type="text" id="p-name" class="auth-input">
                <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</label> <input type="tel" id="p-phone" class="auth-input">
                <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</label> <input type="text" id="p-idcard" class="auth-input" readonly style="background:#eee; color:#777;">
                <button type="submit" class="btn-primary" style="width:auto; margin-top:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </form>
        </div>
        <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
        <table id="history-table">
            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody id="history-list"></tbody>
        </table>
    </div>

    <div id="page-scan" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2 style="text-align: center; color: #1a73e8;">üì∑ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (Scan QR Code)</h2>
        <div style="max-width: 500px; margin: 0 auto;">
            <div id="qr-reader"></div>
            <div id="scan-result" style="display:none;"></div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn-secondary" onclick="restartScanner()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>
    </div>

    <div id="page-orders" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2>üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</th>
                        <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
                        <th>‡∏™‡∏•‡∏¥‡∏õ</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</th>
                    </tr>
                </thead>
                <tbody id="all-orders-list"></tbody>
            </table>
        </div>
    </div>

    <div id="page-users" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>ID Card</th><th>Role</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="user-list-admin"></tbody>
            </table>
        </div>
    </div>

    <div id="page-ticket-types" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <h2 style="margin:0;">üé´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</h2>
            <button class="btn-sm" style="background:#2ecc71; padding:10px 20px; font-size:1rem;" onclick="openTicketTypeModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</button>
        </div>
        <div style="overflow-x:auto; margin-top:20px;">
            <table>
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="ticket-types-list"></tbody>
            </table>
        </div>
    </div>

    <div id="page-banners" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <h2 style="margin:0;">üñºÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ (Slide)</h2>
            <button class="btn-sm" style="background:#2ecc71; padding:10px 20px; font-size:1rem;" onclick="openBannerFormModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <div style="overflow-x:auto; margin-top:20px;">
            <table>
                <thead><tr><th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th><th>‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå (URL)</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="banners-list-admin"></tbody>
            </table>
        </div>
    </div>

</div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <div id="booking-form-section">
            <span class="close-btn" onclick="cancelSelection()">&times;</span>
            <h3>1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</h3>
            <p id="modal-subtitle" style="margin-bottom: 15px; font-weight: bold; color: #1a73e8; font-size:1.1rem;"></p>
            <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="inp-conf-name" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠"></div>
            <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="inp-conf-phone" placeholder="08x-xxx-xxxx"></div>
            <div class="form-group"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="inp-conf-email" placeholder="email@example.com"></div>
            <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" id="inp-conf-idcard" placeholder="‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å"></div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="cancelSelection()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-primary" onclick="proceedToPayment()" style="width:auto; margin-left:10px;">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
        </div>
        <div id="payment-section" class="hidden">
            <h3 style="color: #1a73e8; text-align: center;">2. ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡πÅ‡∏Å‡∏ô QR Code)</h3>
            <div class="payment-qr-container">
                <p style="font-size: 1.2rem; margin:0;">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
                <p style="font-size: 2rem; color:#28a745; font-weight:bold; margin:5px 0;">‡∏ø<span id="pay-amount">0</span></p>
                <img id="pay-qrcode" alt="PromptPay QR">
                <p style="color:#e74c3c; font-weight:bold; margin-top:10px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</p>
                <div class="timer-text" id="pay-countdown">10:00</div>
            </div>
            <div class="form-group">
                <label>‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)</label>
                <input type="url" id="inp-slip-url" placeholder="https://...">
            </div>
            <div class="modal-buttons" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <button class="btn-secondary" onclick="cancelSelection()" style="background:#dc3545;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <div>
                    <button class="btn-secondary" onclick="payLater()" style="background:#f39c12; color:white; border:none; margin-right:5px;">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</button>
                    <button class="btn-primary" onclick="confirmPayment()" style="width:auto; margin:0;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏•‡∏¥‡∏õ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pay-later-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('pay-later-modal').classList.remove('active')">&times;</span>
        <h3 style="color: #f39c12; text-align: center;">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
        <div class="payment-qr-container">
            <p style="font-size: 1.2rem; margin:0;">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
            <p style="font-size: 2rem; color:#28a745; font-weight:bold; margin:5px 0;">‡∏ø<span id="pl-amount">0</span></p>
            <img id="pl-qrcode" alt="PromptPay QR">
            <p style="color:#e74c3c; font-weight:bold; margin-top:10px;">*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏ô‡∏≤‡∏ó‡∏µ*</p>
        </div>
        <div class="form-group">
            <label>‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)</label>
            <input type="url" id="pl-slip-url" placeholder="https://...">
        </div>
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="document.getElementById('pay-later-modal').classList.remove('active')">‡∏õ‡∏¥‡∏î</button>
            <button class="btn-primary" onclick="submitPayLater()" style="width:auto;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏•‡∏¥‡∏õ</button>
        </div>
    </div>
</div>

<div id="eticket-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('eticket-modal').classList.remove('active')">&times;</span>
        <div id="ticket-content" class="ticket-card">
            <div id="t-watermark" class="watermark-used hidden">CHECKED IN</div>
            <div class="ticket-left">
                <div class="t-subtitle">üéüÔ∏è OFFICIAL E-TICKET</div>
                <div class="t-title-main" id="t-title">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                <div class="t-grid">
                    <div>
                        <div class="t-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (Name)</div>
                        <div class="t-value" id="t-name"></div>
                    </div>
                    <div>
                        <div class="t-label">‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£ (Seat)</div>
                        <div class="t-value highlight" id="t-seat"></div>
                    </div>
                    <div>
                        <div class="t-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)</div>
                        <div class="t-value" id="t-date"></div>
                    </div>
                    <div>
                        <div class="t-label">‡πÄ‡∏ß‡∏•‡∏≤ (Time)</div>
                        <div class="t-value" id="t-time"></div>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <div class="t-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Location)</div>
                        <div class="t-value" id="t-location"></div>
                    </div>
                </div>
            </div>
            <div class="ticket-right">
                <div class="scan-text">SCAN HERE</div>
                <div class="ticket-qr">
                    <img id="t-qrcode" alt="Ticket QR">
                </div>
                <div style="font-size: 0.85rem; color: #888; margin-top: 15px; text-align: center;">
                    ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏™‡∏î‡∏á QR Code ‡∏ô‡∏µ‡πâ<br>‡πÅ‡∏Å‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô
                </div>
            </div>
        </div>

        <div class="modal-buttons" style="display:flex; justify-content:center; gap:15px; margin-top:30px;">
            <button class="btn-primary" onclick="downloadTicketPDF()" style="background:#8e44ad; width:100%; font-size: 1.1rem; padding: 12px; border-radius: 8px; box-shadow: 0 4px 15px rgba(142,68,173,0.3);">üì• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF (Download)</button>
        </div>
    </div>
</div>

<div id="forgot-password-modal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <span class="close-btn" onclick="document.getElementById('forgot-password-modal').classList.remove('active')">&times;</span>
        <h3 style="margin-top: 0; color: #1a73e8;">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
        <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        </p>
        <div class="form-group" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)</label>
            <input type="email" id="reset-email" class="form-control" placeholder="example@email.com" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        </div>
        <button class="btn-primary" onclick="handleForgotPassword()" style="width: 100%; padding: 12px; font-size: 1rem; border-radius: 5px; cursor: pointer; background: #1a73e8; color: white; border: none;">
            ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        </button>
    </div>
</div>

<div id="banner-form-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close-btn" onclick="document.getElementById('banner-form-modal').classList.remove('active')">&times;</span>
        <h3 style="margin-top:0; color:#1a73e8;" id="bf-modal-title">üñºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</h3>
        <form onsubmit="saveBannerData(event)">
            <input type="hidden" id="bf-id">
            <div class="form-group">
                <label>URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå:</label>
                <input type="url" id="bf-image" class="auth-input" placeholder="https://..." required>
            </div>
            <div class="form-group">
                <label>URL ‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö):</label>
                <input type="url" id="bf-link" class="auth-input" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
                <select id="bf-active" class="auth-input">
                    <option value="true">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÅ‡∏™‡∏î‡∏á)</option>
                    <option value="false">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ã‡πà‡∏≠‡∏ô)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="document.getElementById('banner-form-modal').classList.remove('active')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="btn-primary" style="width:auto; background:#2ecc71;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </form>
    </div>
</div>

<div id="item-main-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('item-main-modal').classList.remove('active')">&times;</span>
        <h3 id="im-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <form onsubmit="saveMainItem(event)">
            <input type="hidden" id="im-id">
            <input type="hidden" id="im-type">
            <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label><input type="text" id="im-title" required></div>
            <div class="form-group"><label>URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÇ‡∏õ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå):</label><input type="url" id="im-image" placeholder="https://..." required></div>
            <div class="form-group"><label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</label><textarea id="im-detail" rows="3"></textarea></div>
            <div class="form-group"><label>‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏¢‡πÜ ‡πÄ‡∏ä‡πà‡∏ô 10-12 ‡∏ï.‡∏Ñ.):</label><input type="text" id="im-dates" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10-12 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 2026"></div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="document.getElementById('item-main-modal').classList.remove('active')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="btn-primary" style="width:auto; background:#2ecc71;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å</button>
            </div>
        </form>
    </div>
</div>

<div id="item-round-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('item-round-modal').classList.remove('active')">&times;</span>
        <h3 id="rd-modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ö</h3>
        <form onsubmit="saveRoundItem(event)">
            <input type="hidden" id="rd-id">
            <div class="form-group"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà / ‡πÇ‡∏£‡∏á‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå:</label><input type="text" id="rd-location" required></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£:</label><select id="rd-ticket-type" onchange="updatePriceFromTypeRound()" required><option value="">-- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option></select></div>
                <div class="form-group" style="flex:1"><label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó):</label><input type="number" id="rd-price" required></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á:</label><input type="datetime-local" id="rd-book-start" required></div>
                <div class="form-group" style="flex:1"><label>‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏≠‡∏á:</label><input type="datetime-local" id="rd-book-end" required></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á:</label><input type="datetime-local" id="rd-show-start" required></div>
                <div class="form-group" style="flex:1"><label>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label><input type="datetime-local" id="rd-show-end" required></div>
            </div>

            <div id="rd-movie-fields" class="hidden" style="background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:15px;">
                <div style="display:flex; gap:10px;">
                    <div class="form-group" style="flex:1"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß (A, B...):</label><input type="number" id="rd-rows"></div>
                    <div class="form-group" style="flex:1"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡πÅ‡∏ñ‡∏ß:</label><input type="number" id="rd-cols"></div>
                </div>
                <div class="form-group"><label>‡∏õ‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (Blocked ex: A1,A2):</label><input type="text" id="rd-blocked"></div>
            </div>

            <div id="rd-event-fields" class="hidden" style="background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:15px;">
                <div class="form-group"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ (-1=‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î):</label><input type="number" id="rd-cap"></div>
            </div>

            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="document.getElementById('item-round-modal').classList.remove('active')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="btn-primary" style="width:auto; background:#f39c12;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö</button>
            </div>
        </form>
    </div>
</div>

<div id="ticket-type-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('ticket-type-modal').classList.remove('active')">&times;</span>
        <h3 id="tt-modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</h3>
        <form onsubmit="saveTicketType(event)">
            <input type="hidden" id="tt-id">
            <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£ (‡πÄ‡∏ä‡πà‡∏ô VIP, Normal):</label><input type="text" id="tt-name" required></div>
            <div class="form-group"><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó):</label><input type="number" id="tt-price" required min="0"></div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="document.getElementById('ticket-type-modal').classList.remove('active')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="btn-primary" style="width:auto;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </form>
    </div>
</div>

<div id="user-edit-modal" class="modal">
    <div class="modal-content">
        <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
        <input type="hidden" id="edit-u-uid">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="edit-u-name"></div>
        <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" id="edit-u-phone"></div>
        <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input type="text" id="edit-u-idcard"></div>
        <div class="form-group">
            <label>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Role)</label>
            <select id="edit-u-role" style="width:100%; padding:10px; margin-top:5px; border-radius:6px; border:1px solid #ddd; font-family:'Sarabun';">
                <option value="user">User (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
                <option value="admin">Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</option>
            </select>
        </div>
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="document.getElementById('user-edit-modal').classList.remove('active')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn-primary" onclick="saveUserAdmin()" style="width:auto; margin-left:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, push, set, remove, onDisconnect, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAJGlD_kNVgRHVAdmUUgZAerrjX8nJbMJE",
        authDomain: "booking-system-c1ebd.firebaseapp.com",
        databaseURL: "https://booking-system-c1ebd-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "booking-system-c1ebd",
        storageBucket: "booking-system-c1ebd.firebasestorage.app",
        messagingSenderId: "140390358651",
        appId: "1:140390358651:web:cf9dc2624697c4d93f0cde"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUser = null;
    let userRole = 'guest';
    let userData = {};
    let isRegistering = false;
    let allData = {}; 
    let guestId = localStorage.getItem('guest_uid') || ('guest_' + Date.now());
    localStorage.setItem('guest_uid', guestId);

    // üåü State ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà üåü
    let currentType = ''; 
    let currentItemId = ''; 
    let currentRoundId = '';
    let selectedTarget = '';
    let currentRoundConfig = null;
    let tempSeatRef = null;
    let paymentTimerInterval = null; 
    let payLaterData = null; 
    let html5QrcodeScanner = null;

    let bannerInterval = null;
    let currentBannerIndex = 0;
    let lastBannerDataString = "";

    const PROMPTPAY_NUMBER = "0812345678"; 

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            onValue(ref(db, 'users/' + user.uid), (snap) => {
                userData = snap.val() || {};
                userRole = userData.role || 'user';
                updateNavbarUI(true);
                if(!document.getElementById('page-auth').classList.contains('hidden')) window.goHome();
                checkAdminPages();
            });
        } else {
            userRole = 'guest'; userData = {}; updateNavbarUI(false);
            if(!document.getElementById('page-auth').classList.contains('hidden')) {} else { window.goHome(); }
        }
    });

    function checkAdminPages() {
        if(!document.getElementById('page-users').classList.contains('hidden')) window.showUserManagement();
        if(!document.getElementById('page-ticket-types').classList.contains('hidden')) window.showTicketTypesManagement();
        if(!document.getElementById('page-orders').classList.contains('hidden')) window.showOrderManagement();
        if(!document.getElementById('page-banners').classList.contains('hidden')) window.showBannerManagement();
    }

    onValue(ref(db, '/'), (snapshot) => {
        allData = snapshot.val() || {};
        window.renderHomeList();
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Detail Page ‡πÅ‡∏ö‡∏ö Realtime ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
        if(!document.getElementById('page-detail').classList.contains('hidden') && currentItemId) {
            if(!document.getElementById('schedule-section').classList.contains('hidden')) {
                window.openDetailPage(currentItemId, currentType, false);
            } 
            else if (currentRoundId) {
                const itemData = allData[currentType + 's'][currentItemId] || {};
                const roundData = itemData.rounds ? itemData.rounds[currentRoundId] : {};
                if(currentType === 'movie') {
                    updateSeatStatus(roundData.bookings || {}, roundData.temp_selections || {});
                } else {
                    const cap = currentRoundConfig.capacity;
                    const cur = roundData.currentBooked || 0;
                    document.getElementById('e-remaining').innerText = cap == -1 ? '‚àû' : (cap - cur);
                }
            }
        }

        checkAdminPages();
        if(!document.getElementById('page-profile').classList.contains('hidden')) window.showProfile();
    });

    setInterval(() => {
        const now = Date.now();
        const expireTime = 10 * 60 * 1000; 
        ['movie', 'event'].forEach(type => {
            if(allData[type + 's']) {
                Object.entries(allData[type + 's']).forEach(([itemId, item]) => {
                    if(item.rounds) {
                        Object.entries(item.rounds).forEach(([rId, rData]) => {
                            if(rData.bookings) {
                                Object.entries(rData.bookings).forEach(([bookingKey, b]) => {
                                    if(b.paymentStatus === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' && (now - b.timestamp > expireTime)) {
                                        remove(ref(db, `${type}s/${itemId}/rounds/${rId}/bookings/${bookingKey}`)).then(() => {
                                            if(type === 'event') {
                                                runTransaction(ref(db, `events/${itemId}/rounds/${rId}/currentBooked`), (c) => (c || 1) - 1);
                                            }
                                        });
                                    }
                                });
                            }
                            if(type === 'movie' && rData.temp_selections) {
                                Object.entries(rData.temp_selections).forEach(([seatId, t]) => {
                                    if(now - t.timestamp > expireTime) { 
                                        remove(ref(db, `movies/${itemId}/rounds/${rId}/temp_selections/${seatId}`)); 
                                    }
                                });
                            }
                        });
                    }
                });
            }
        });
    }, 15000);

    function updateNavbarUI(isLoggedIn) {
        document.getElementById('main-nav').classList.remove('hidden');
        if(userRole === 'admin') {
            document.getElementById('nav-admin-scan').classList.remove('hidden');
            document.getElementById('nav-admin-orders').classList.remove('hidden');
            document.getElementById('nav-admin-users').classList.remove('hidden');
            document.getElementById('nav-admin-tickets').classList.remove('hidden');
        } else {
            document.getElementById('nav-admin-scan').classList.add('hidden');
            document.getElementById('nav-admin-orders').classList.add('hidden');
            document.getElementById('nav-admin-users').classList.add('hidden');
            document.getElementById('nav-admin-tickets').classList.add('hidden');
        }

        if(isLoggedIn) {
            document.getElementById('nav-profile').classList.remove('hidden');
            document.getElementById('nav-logout').classList.remove('hidden');
            document.getElementById('nav-login').classList.add('hidden');
        } else {
            document.getElementById('nav-profile').classList.add('hidden');
            document.getElementById('nav-logout').classList.add('hidden');
            document.getElementById('nav-login').classList.remove('hidden');
        }
    }

    // --- Views ---
    window.showPage = (pid) => {
        if(pid !== 'page-scan' && html5QrcodeScanner) {
            html5QrcodeScanner.clear().then(() => { html5QrcodeScanner = null; }).catch(err => { html5QrcodeScanner = null; });
        }
        ['page-auth', 'page-home', 'page-detail', 'page-profile', 'page-users', 'page-ticket-types', 'page-orders', 'page-scan', 'page-banners'].forEach(id => {
            const el = document.getElementById(id); if(el) el.classList.add('hidden');
        });
        const target = document.getElementById(pid); if(target) target.classList.remove('hidden');
    }

    window.goHome = () => {
        if(currentType === 'movie' && tempSeatRef) cancelSelection();
        window.showPage('page-home');
        window.renderHomeList();
    }

    // --- QR Code Scanner Logic ---
    window.showScanPage = () => {
        if(userRole !== 'admin') return;
        window.showPage('page-scan');
        const resDiv = document.getElementById('scan-result');
        resDiv.style.display = 'none'; resDiv.className = 'scan-msg'; resDiv.innerHTML = '';

        if(!html5QrcodeScanner) {
            html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: {width: 250, height: 250} }, false);
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }
    };

    window.restartScanner = () => {
        document.getElementById('scan-result').style.display = 'none';
        if(html5QrcodeScanner) html5QrcodeScanner.resume(); else window.showScanPage();
    }

    function onScanSuccess(decodedText, decodedResult) {
        const parts = decodedText.split('|');
        const resDiv = document.getElementById('scan-result');
        
        // TICKET|type|itemId|roundId|bookingKey|userName
        if(parts[0] !== 'TICKET' || parts.length < 6) {
            resDiv.innerHTML = "‚ùå QR Code ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ";
            resDiv.className = 'scan-msg scan-error'; resDiv.style.display = 'block';
            return;
        }

        if(html5QrcodeScanner) html5QrcodeScanner.pause(true);

        const type = parts[1];
        const itemId = parts[2];
        const roundId = parts[3];
        const bookingKey = parts[4];
        const name = parts[5];

        const path = `${type}s/${itemId}/rounds/${roundId}/bookings/${bookingKey}`;
        
        get(ref(db, path)).then((snap) => {
            if(snap.exists()) {
                const b = snap.val();
                if(b.paymentStatus !== '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' && b.paymentStatus !== '‡∏ü‡∏£‡∏µ') {
                    resDiv.innerHTML = `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ<br>‡∏ï‡∏±‡πã‡∏ß‡∏Ç‡∏≠‡∏á <b>${name}</b><br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${b.paymentStatus}</b>`;
                    resDiv.className = 'scan-msg scan-error'; resDiv.style.display = 'block';
                    return;
                }
                
                if(b.isCheckedIn) {
                    resDiv.innerHTML = `‚ö†Ô∏è ‡∏ï‡∏±‡πã‡∏ß‡πÉ‡∏ö‡∏ô‡∏µ‡πâ <b>‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!</b><br>‡∏ä‡∏∑‡πà‡∏≠: ${name}<br>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(b.checkInTime).toLocaleString()}`;
                    resDiv.className = 'scan-msg scan-error'; resDiv.style.display = 'block';
                } else {
                    update(ref(db, path), { isCheckedIn: true, checkInTime: Date.now() }).then(() => {
                        resDiv.innerHTML = `‚úÖ <b>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</b><br>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì <b>${name}</b><br>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡∏£‡∏´‡∏±‡∏™: ${bookingKey}`;
                        resDiv.className = 'scan-msg scan-success'; resDiv.style.display = 'block';
                    });
                }
            } else {
                resDiv.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß)";
                resDiv.className = 'scan-msg scan-error'; resDiv.style.display = 'block';
            }
        }).catch((err) => {
            resDiv.innerHTML = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            resDiv.className = 'scan-msg scan-error'; resDiv.style.display = 'block';
        });
    }

    function onScanFailure(error) { }


    // --- ‡∏£‡∏∞‡∏ö‡∏ö Slide Banners ---
    function buildBannerSlider() {
        const bannerContainer = document.getElementById('banner-slider-container');
        const track = document.getElementById('banner-slider-track');
        const dotsWrapper = document.getElementById('banner-slider-dots');

        let activeBanners = [];
        if (allData.settings && allData.settings.banners) {
            Object.entries(allData.settings.banners).forEach(([id, b]) => {
                if (b.isActive === true || b.isActive === 'true') activeBanners.push({id, ...b});
            });
        }

        const currentDataString = JSON.stringify(activeBanners);
        if(currentDataString === lastBannerDataString) return; 
        lastBannerDataString = currentDataString;

        clearInterval(bannerInterval);
        track.innerHTML = ''; dotsWrapper.innerHTML = '';

        if (activeBanners.length > 0) {
            bannerContainer.classList.remove('hidden');
            
            activeBanners.forEach((b, index) => {
                const slide = document.createElement('div');
                slide.className = 'banner-slide';
                const imgContent = `<img src="${b.imageUrl}" alt="Banner">`;
                
                if (b.linkUrl && b.linkUrl.trim() !== '') {
                    slide.innerHTML = `<a href="${b.linkUrl}" target="_blank">${imgContent}</a>`;
                } else {
                    slide.innerHTML = imgContent;
                }
                track.appendChild(slide);

                const dot = document.createElement('div');
                dot.className = `slider-dot ${index === 0 ? 'active' : ''}`;
                dot.onclick = () => window.goToSlide(index);
                dotsWrapper.appendChild(dot);
            });

            currentBannerIndex = 0;
            updateSliderPosition();

            if (activeBanners.length > 1) {
                bannerInterval = setInterval(() => {
                    currentBannerIndex = (currentBannerIndex + 1) % activeBanners.length;
                    updateSliderPosition();
                }, 4000); 
            }
        } else {
            bannerContainer.classList.add('hidden');
        }
    }

    function updateSliderPosition() {
        const track = document.getElementById('banner-slider-track');
        const dots = document.querySelectorAll('.slider-dot');
        if(!track) return;
        track.style.transform = `translateX(-${currentBannerIndex * 100}%)`;
        dots.forEach((d, i) => {
            if(i === currentBannerIndex) d.classList.add('active');
            else d.classList.remove('active');
        });
    }

    window.goToSlide = (index) => {
        currentBannerIndex = index;
        updateSliderPosition();
        
        clearInterval(bannerInterval);
        const totalSlides = document.querySelectorAll('.banner-slide').length;
        if(totalSlides > 1) {
            bannerInterval = setInterval(() => {
                currentBannerIndex = (currentBannerIndex + 1) % totalSlides;
                updateSliderPosition();
            }, 4000);
        }
    }

    // üåü --- ‡∏£‡∏∞‡∏ö‡∏ö Filter ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á --- üåü
    window.applyFilters = () => { window.renderHomeList(); };

    window.renderHomeList = () => {
        const gridList = document.getElementById('items-grid');
        if(!gridList) return;
        gridList.innerHTML = '';

        const adminPanel = document.getElementById('admin-panel-home');
        if(adminPanel) {
            if(userRole === 'admin') adminPanel.classList.remove('hidden');
            else adminPanel.classList.add('hidden');
        }

        buildBannerSlider(); 

        const filterLocation = document.getElementById('filter-location')?.value || '';
        const filterCategory = document.getElementById('filter-category')?.value || 'all';
        const filterSort = document.getElementById('filter-sort')?.value || 'closest';

        const allLocations = new Set();
        let allItemsList = [];

        // üåü ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
        const processItems = (dataObj, type) => {
            if (!dataObj) return;
            Object.entries(dataObj).forEach(([id, item]) => {
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏°‡∏µ info)
                if (item.info) {
                    let minPrice = Infinity;
                    let earliestStart = Infinity;
                    let validRoundCount = 0;
                    
                    if (item.rounds) {
                        Object.values(item.rounds).forEach(r => {
                            if(!r.config) return;
                            
                            const loc = r.config.location || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà';
                            allLocations.add(loc);

                            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
                            if (filterLocation && loc !== filterLocation) return;

                            validRoundCount++;
                            const p = parseFloat(r.config.price) || 0;
                            const t = new Date(r.config.showStart).getTime();
                            
                            if(p < minPrice) minPrice = p;
                            if(t > 0 && t < earliestStart) earliestStart = t;
                        });
                    }

                    // üåü ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏´‡∏≤‡πÄ‡∏•‡∏¢"
                    if (validRoundCount === 0) {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô User ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏•‡∏¢ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á)
                        if (userRole !== 'admin') return; 
                        
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÅ‡∏•‡πâ‡∏ß "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" ‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå
                        // (‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Admin ‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÑ‡∏î‡πâ)
                        if (filterLocation !== '') return; 
                    }

                    allItemsList.push({
                        id: id,
                        type: type,
                        info: item.info,
                        roundCount: validRoundCount, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô Filter ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                        minPrice: minPrice === Infinity ? 0 : minPrice,
                        earliestStart: earliestStart === Infinity ? Number.MAX_SAFE_INTEGER : earliestStart
                    });
                }
                // üåü ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ info)
                else if (item.config) {
                    const loc = item.config.location || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà';
                    allLocations.add(loc);
                    
                    if (filterLocation && loc !== filterLocation) return;
                    
                    const p = parseFloat(item.config.price) || 0;
                    const t = new Date(item.config.start).getTime();
                    
                    allItemsList.push({
                        id: id,
                        type: type,
                        info: item.config, // ‡πÉ‡∏ä‡πâ config ‡πÅ‡∏ó‡∏ô info ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
                        roundCount: 1, 
                        minPrice: p,
                        earliestStart: t || Number.MAX_SAFE_INTEGER
                    });
                }
            });
        };

        processItems(allData.movies, 'movie');
        processItems(allData.events, 'event');

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
        const locSelect = document.getElementById('filter-location');
        if(locSelect) {
            locSelect.innerHTML = '<option value="">-- ‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>';
            Array.from(allLocations).sort().forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc; opt.innerText = loc;
                if(loc === filterLocation) opt.selected = true;
                locSelect.appendChild(opt);
            });
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
        let filtered = allItemsList.filter(item => filterCategory === 'all' || item.type === filterCategory);

        // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á
        filtered.sort((a, b) => {
            if (filterSort === 'closest') return a.earliestStart - b.earliestStart; // ‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            if (filterSort === 'newest') { // ‡πÑ‡∏Å‡∏•‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                const aT = a.earliestStart === Number.MAX_SAFE_INTEGER ? 0 : a.earliestStart;
                const bT = b.earliestStart === Number.MAX_SAFE_INTEGER ? 0 : b.earliestStart;
                return bT - aT;
            }
            if (filterSort === 'priceAsc') return a.minPrice - b.minPrice; // ‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            if (filterSort === 'priceDesc') return b.minPrice - a.minPrice; // ‡πÅ‡∏û‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            return 0;
        });

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        if(filtered.length === 0) {
            gridList.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding: 40px; color:#777; font-size:1.1rem; background:white; border-radius:12px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>`;
        } else {
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.onclick = () => openDetailPage(item.id, item.type);
                
                const imgUrl = item.info.image || 'https://via.placeholder.com/300x400';
                const tagText = item.type === 'movie' ? 'üé¨ ‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå' : 'üé§ ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå';
                
                // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ start ‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πâ showDates
                let dateText = item.info.showDates || '‡∏î‡∏π‡∏£‡∏≠‡∏ö‡∏â‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô';
                if(!item.info.showDates && item.info.start) {
                    dateText = new Date(item.info.start).toLocaleDateString('th-TH');
                }
                
                div.innerHTML = `
                    <img src="${imgUrl}" alt="${item.info.title}">
                    <span class="tag ${item.type}">${tagText}</span>
                    <h3 style="margin:5px 0;">${item.info.title}</h3>
                    <p style="font-size:0.85rem; color:#888; margin:5px 0;">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <b>${dateText}</b></p>
                    <p style="font-size:1rem; color:#d93025; font-weight:bold; margin:5px 0;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏ø${item.minPrice}</p>
                    <p style="margin-top:auto; padding-top:10px; font-size:0.9rem; color:#666;">‡∏°‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á <strong>${item.roundCount}</strong> ‡∏£‡∏≠‡∏ö</p>
                `;
                gridList.appendChild(div);
            });
        }
    }


    // üåü --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏ö (Detail Page) --- üåü
    window.openDetailPage = (itemId, type, switchPage = true) => {
        currentItemId = itemId;
        currentType = type;
        if(switchPage) window.showPage('page-detail');

        document.getElementById('movie-seat-section').classList.add('hidden');
        document.getElementById('event-booking-section').classList.add('hidden');
        document.getElementById('schedule-section').classList.remove('hidden');

        document.getElementById('schedule-type-text').innerText = type === 'movie' ? '‡∏â‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå' : '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
        
        const dataNode = allData[type + 's'] ? allData[type + 's'][itemId] : null;
        if(!dataNode) return goHome();

        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (info) ‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ (config)
        const info = dataNode.info || dataNode.config;
        if(!info) return goHome();

        document.getElementById('detail-header').innerHTML = `
            <img src="${info.image || 'https://via.placeholder.com/300x400'}" alt="Poster">
            <div class="item-info">
                <h2 style="margin-top:0; color:${type==='movie'?'#1a73e8':'#d93025'};">${info.title}</h2>
                <p>üìÖ <strong>‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${info.showDates || '-'}</p>
                <p style="color:#555; white-space:pre-wrap; font-size:0.95rem; margin-top:10px;">${info.detail || ''}</p>
            </div>
        `;

        const adminPanelDetail = document.getElementById('admin-panel-detail');
        if(userRole === 'admin') adminPanelDetail.classList.remove('hidden');
        else adminPanelDetail.classList.add('hidden');

        const list = document.getElementById('schedule-list');
        list.innerHTML = '';

        let roundsArr = [];
        const locFilter = document.getElementById('filter-location')?.value || '';

        if(dataNode.rounds) {
            Object.entries(dataNode.rounds).forEach(([rId, rData]) => {
                if(rData.config) {
                    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å)
                    if(locFilter && rData.config.location !== locFilter) return;
                    roundsArr.push({ id: rId, ...rData });
                }
            });
        } 
        // üåü ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ üåü
        else if (dataNode.config) {
            if(!locFilter || dataNode.config.location === locFilter) {
                roundsArr.push({
                    id: 'old-data',
                    config: {
                        ...dataNode.config,
                        showStart: dataNode.config.start,
                        showEnd: dataNode.config.end,
                        bookStart: dataNode.config.start,
                        bookEnd: dataNode.config.end
                    },
                    bookings: dataNode.bookings || {},
                    temp_selections: dataNode.temp_selections || {},
                    currentBooked: dataNode.currentBooked || 0
                });
            }
        }
        
        roundsArr.sort((a,b) => new Date(a.config.showStart) - new Date(b.config.showStart));

        if(roundsArr.length === 0) {
            list.innerHTML = '<p style="color:#777; text-align:center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≠‡∏ö</p>';
            return;
        }

        const now = Date.now();

        roundsArr.forEach(r => {
            const conf = r.config;
            const sStart = new Date(conf.showStart).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });
            let sEnd = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            if(conf.showEnd) sEnd = new Date(conf.showEnd).toLocaleTimeString('th-TH', { timeStyle: 'short' });
            
            const bStart = new Date(conf.bookStart).getTime();
            const bEnd = new Date(conf.bookEnd).getTime();
            
            let statsHtml = '';
            let btnDisabled = '';
            let btnText = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ';
            let btnStyle = '';

            if (type === 'movie') {
                let blocked = [];
                if (conf.blocked) blocked = Array.isArray(conf.blocked) ? conf.blocked : String(conf.blocked).split(',').filter(x=>x.trim());
                const total = (conf.rows * conf.cols) - blocked.length;
                const booked = r.bookings ? Object.keys(r.bookings).length : 0;
                let selecting = 0;
                if(r.temp_selections) {
                    Object.values(r.temp_selections).forEach(t => { if(now - t.timestamp < 10*60*1000) selecting++; });
                }
                const available = total - booked - selecting;
                
                statsHtml = `
                    <span class="schedule-stats"><span style="color:green">${available}</span> ‡∏ß‡πà‡∏≤‡∏á</span>
                    <span class="schedule-stats"><span style="color:red">${booked}</span> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                `;
            } else {
                const cap = conf.capacity;
                const cur = r.currentBooked || 0;
                const remain = cap == -1 ? '‚àû' : (cap - cur);
                const isFull = (cap != -1 && cur >= cap);
                
                statsHtml = `
                    <span class="schedule-stats">‡∏ß‡πà‡∏≤‡∏á: <span style="color:green">${remain}</span></span>
                    <span class="schedule-stats">‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${cap == -1 ? '‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î' : cap}</span>
                `;

                if(isFull && userRole !== 'admin') {
                    btnDisabled = 'disabled'; btnText = '‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß'; btnStyle = 'background:#ccc;';
                }
            }

            if (userRole !== 'admin') {
                if (now < bStart) { btnDisabled = 'disabled'; btnText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î'; btnStyle = 'background:#ccc;'; }
                else if (now > bEnd) { btnDisabled = 'disabled'; btnText = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á'; btnStyle = 'background:#ccc;'; }
            } else {
                if (now < bStart) btnText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î (Admin)';
                else if (now > bEnd) btnText = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (Admin)';
            }

            let adminTools = '';
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏£‡∏≠‡∏ö ‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏Ñ)
            if (userRole === 'admin' && r.id !== 'old-data') {
                adminTools = `
                    <div style="margin-top:10px; display:flex; gap:5px;">
                        <button class="btn-sm btn-edit" onclick="editRoundItem('${r.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≠‡∏ö</button>
                        <button class="btn-sm btn-del" onclick="deleteRoundItem('${r.id}')">‡∏•‡∏ö</button>
                    </div>
                `;
            } else if (userRole === 'admin' && r.id === 'old-data') {
                 adminTools = `<div style="margin-top:10px; font-size:0.8rem; color:#f39c12;">‚ö†Ô∏è ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≠‡∏ö‡πÑ‡∏î‡πâ</div>`;
            }

            list.innerHTML += `
                <div class="schedule-item">
                    <div class="schedule-info">
                        <strong style="font-size:1.1rem; color:${type==='movie'?'#1a73e8':'#d93025'};">üïí ${sStart} - ${sEnd}</strong>
                        <div style="font-size:0.9rem; color:#555; margin:5px 0;">üìç ${conf.location} | üéüÔ∏è ${conf.ticketType} | üí∞ ‡∏ø${conf.price}</div>
                        <div>${statsHtml}</div>
                        ${adminTools}
                    </div>
                    <button class="btn-primary" ${btnDisabled} style="max-width:150px; ${btnStyle}" onclick="selectShowtime('${r.id}')">${btnText}</button>
                </div>
            `;
        });
    }

    // üåü --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á --- üåü
    window.checkTime = (bS, bE) => {
        if(userRole === 'admin') return true; 
        const n = Date.now();
        if(n < new Date(bS).getTime()) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á"); return false; }
        if(n > new Date(bE).getTime()) { alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß"); return false; }
        return true;
    }

    window.selectShowtime = (roundId) => {
        currentRoundId = roundId;
        
        let roundData = {};
        if (roundId === 'old-data') {
            const oldConf = allData[currentType + 's'][currentItemId];
            roundData = {
                config: { ...oldConf.config, showStart: oldConf.config.start, showEnd: oldConf.config.end, bookStart: oldConf.config.start, bookEnd: oldConf.config.end },
                bookings: oldConf.bookings || {}, temp_selections: oldConf.temp_selections || {}, currentBooked: oldConf.currentBooked || 0
            };
        } else {
            roundData = allData[currentType + 's'][currentItemId].rounds[roundId];
        }
        
        currentRoundConfig = roundData.config;

        if(!window.checkTime(currentRoundConfig.bookStart, currentRoundConfig.bookEnd) && userRole !== 'admin') return;

        document.getElementById('schedule-section').classList.add('hidden');

        if(currentType === 'movie') {
            document.getElementById('movie-seat-section').classList.remove('hidden');
            document.getElementById('seat-round-time').innerText = new Date(currentRoundConfig.showStart).toLocaleString();
            renderSeatsBase(currentRoundConfig);
            updateSeatStatus(roundData.bookings || {}, roundData.temp_selections || {});
        } else {
            document.getElementById('event-booking-section').classList.remove('hidden');
            document.getElementById('e-round-time').innerText = new Date(currentRoundConfig.showStart).toLocaleString();
            const cap = currentRoundConfig.capacity;
            const cur = roundData.currentBooked || 0;
            document.getElementById('e-remaining').innerText = cap == -1 ? '‚àû' : (cap - cur);
            document.getElementById('e-capacity').innerText = cap == -1 ? '‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î' : cap;
            
            const btn = document.getElementById('btn-event-book');
            const isFull = (cap != -1 && cur >= cap);
            if(isFull && userRole !== 'admin') { 
                btn.disabled=true; btn.innerText="‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß"; btn.style.background="#ccc"; 
            } else { 
                btn.disabled=false; 
                btn.innerText = (isFull && userRole==='admin') ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏ô (Admin)" : "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£";
                btn.style.background = (isFull && userRole==='admin') ? "#f39c12" : "#1a73e8"; 
                btn.onclick = () => window.openBookingModal("‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô");
            }
        }
    }

    window.backToSchedule = () => {
        if(tempSeatRef) cancelSelection();
        currentRoundId = '';
        window.openDetailPage(currentItemId, currentType, false);
    }

    function renderSeatsBase(conf) {
        const map = document.getElementById('seat-map');
        map.innerHTML = '';
        map.style.gridTemplateColumns = `repeat(${conf.cols}, 1fr)`;
        let blockedList = [];
        if (conf.blocked) blockedList = Array.isArray(conf.blocked) ? conf.blocked : String(conf.blocked).split(',').map(x => x.trim());

        for(let r=0; r<conf.rows; r++) {
            const rowL = String.fromCharCode(65 + r);
            for(let c=1; c<=conf.cols; c++) {
                const seatId = `${rowL}${c}`;
                const seat = document.createElement('div');
                seat.className = 'seat available';
                seat.id = `seat-${seatId}`;
                seat.innerText = seatId;
                if(blockedList.includes(seatId)) { seat.classList.add('blocked'); seat.classList.remove('available'); } 
                else { seat.onclick = () => window.selectSeat(seatId); }
                map.appendChild(seat);
            }
        }
    }

    function updateSeatStatus(bookings, temps) {
        const myUid = currentUser ? currentUser.uid : guestId;
        document.querySelectorAll('.seat').forEach(s => {
            const sid = s.id.replace('seat-', '');
            if(s.classList.contains('blocked')) return;
            s.className = 'seat available'; 
            s.onclick = () => window.selectSeat(sid);

            if(bookings[sid]) {
                if(bookings[sid].paymentStatus === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' && bookings[sid].uid === myUid) {
                    s.className = 'seat pending';
                    s.onclick = () => window.openPayLaterModal(currentType, currentItemId, currentRoundId, sid, currentRoundConfig.price);
                } else { s.className = 'seat booked'; s.onclick = null; }
            } else if(temps[sid]) {
                if (Date.now() - temps[sid].timestamp < 10 * 60 * 1000) { s.className = 'seat selecting'; s.onclick = null; }
            }
        });
    }

    window.selectSeat = (seatId) => {
        // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏ü‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°
        const isOldData = (currentRoundId === 'old-data');
        const tempPath = isOldData 
            ? `${currentType}s/${currentItemId}/temp_selections/${seatId}` 
            : `${currentType}s/${currentItemId}/rounds/${currentRoundId}/temp_selections/${seatId}`;

        const tempRef = ref(db, tempPath);
        const userIdToUse = currentUser ? currentUser.uid : guestId;
        
        runTransaction(tempRef, (curr) => {
            if (curr === null || Date.now() - curr.timestamp > 10 * 60 * 1000) {
                return { timestamp: Date.now(), user_uid: userIdToUse };
            }
            return; 
        }).then((res) => {
            if (res.committed) {
                selectedTarget = seatId;
                tempSeatRef = tempRef;
                onDisconnect(tempRef).remove();
                window.openBookingModal(`‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: ${seatId}`);
            } else alert("‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö");
        });
    }

    window.openBookingModal = (detail) => {
        document.getElementById('booking-form-section').classList.remove('hidden');
        document.getElementById('payment-section').classList.add('hidden');
        document.getElementById('inp-slip-url').value = '';
        clearInterval(paymentTimerInterval);

        document.getElementById('modal-subtitle').innerText = detail;
        const modal = document.getElementById('booking-modal');
        if(currentUser) {
            document.getElementById('inp-conf-name').value = userData.name || '';
            document.getElementById('inp-conf-phone').value = userData.phone || '';
            document.getElementById('inp-conf-email').value = userData.email || currentUser.email;
            document.getElementById('inp-conf-idcard').value = userData.idCard || '';
            
            document.getElementById('inp-conf-name').readOnly = true;
            document.getElementById('inp-conf-phone').readOnly = true;
            document.getElementById('inp-conf-email').readOnly = true;
            document.getElementById('inp-conf-idcard').readOnly = true;
             ['name','phone','email','idcard'].forEach(k => document.getElementById(`inp-conf-${k}`).style.backgroundColor = '#f0f0f0');
        } else {
            document.getElementById('inp-conf-name').value = '';
            document.getElementById('inp-conf-phone').value = '';
            document.getElementById('inp-conf-email').value = '';
            document.getElementById('inp-conf-idcard').value = '';
             ['name','phone','email','idcard'].forEach(k => {
                 const el = document.getElementById(`inp-conf-${k}`);
                 el.readOnly = false;
                 el.style.backgroundColor = '#fff';
             });
        }
        modal.classList.add('active');
    }

    window.cancelSelection = () => {
        clearInterval(paymentTimerInterval);
        document.getElementById('booking-modal').classList.remove('active');
        if(currentType === 'movie' && tempSeatRef) {
            remove(tempSeatRef);
            onDisconnect(tempSeatRef).cancel();
            tempSeatRef = null; selectedTarget = '';
        }
    }

    window.proceedToPayment = () => {
        const bName = document.getElementById('inp-conf-name').value.trim();
        const bPhone = document.getElementById('inp-conf-phone').value.trim();
        const bEmail = document.getElementById('inp-conf-email').value.trim();
        if(!bName || !bPhone || !bEmail) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }

        const isOldData = (currentRoundId === 'old-data');
        let existingBookings = {};

        if (isOldData) {
            existingBookings = allData[currentType + 's'][currentItemId].bookings || {};
        } else {
            existingBookings = allData[currentType + 's'][currentItemId].rounds[currentRoundId].bookings || {};
        }

        let isDup = false;
        Object.values(existingBookings).forEach(b => {
            if(b.email === bEmail) isDup = true;
            if(currentUser && b.uid === currentUser.uid && b.uid !== 'guest') isDup = true;
        });

        if(isDup) {
            if(userRole === 'admin') {
                if(!confirm("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏à‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß (Admin) ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            } else {
                alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏≥‡∏Å‡∏±‡∏î 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö)");
                return;
            }
        }

        const price = parseInt(currentRoundConfig.price) || 0;
        if(price === 0) {
            processFinalBooking("");
            return;
        }

        document.getElementById('booking-form-section').classList.add('hidden');
        document.getElementById('payment-section').classList.remove('hidden');
        document.getElementById('pay-amount').innerText = price;
        document.getElementById('pay-qrcode').src = `https://promptpay.io/${PROMPTPAY_NUMBER}/${price}.png`;

        startPaymentTimer(10 * 60); 
    }

    function startPaymentTimer(durationInSeconds) {
        clearInterval(paymentTimerInterval);
        let timer = durationInSeconds, minutes, seconds;
        const display = document.getElementById('pay-countdown');
        
        paymentTimerInterval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            display.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(paymentTimerInterval);
                alert("‚è≥ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
                window.cancelSelection();
            }
        }, 1000);
    }

    window.confirmPayment = () => {
        const slipUrl = document.getElementById('inp-slip-url').value.trim();
        if(!slipUrl) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (URL)"); return; }
        processFinalBooking(slipUrl);
    }

    window.payLater = () => {
        processFinalBooking("", "‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");
    }

    function processFinalBooking(slipUrl, customStatus = null) {
        clearInterval(paymentTimerInterval);

        const bName = document.getElementById('inp-conf-name').value.trim();
        const bPhone = document.getElementById('inp-conf-phone').value.trim();
        const bEmail = document.getElementById('inp-conf-email').value.trim();
        const bIdCard = document.getElementById('inp-conf-idcard').value.trim();

        let status = customStatus;
        if(!status) status = slipUrl ? '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : '‡∏ü‡∏£‡∏µ';

        const bookingData = {
            uid: currentUser ? currentUser.uid : 'guest', 
            name: bName, phone: bPhone, email: bEmail, idCard: bIdCard, timestamp: Date.now(),
            slipUrl: slipUrl, paymentStatus: status, isCheckedIn: false 
        };

        const isOldData = (currentRoundId === 'old-data');
        const basePath = isOldData 
            ? `${currentType}s/${currentItemId}` 
            : `${currentType}s/${currentItemId}/rounds/${currentRoundId}`;

        if(currentType === 'movie') {
            set(ref(db, `${basePath}/bookings/${selectedTarget}`), bookingData).then(() => {
                if(tempSeatRef) remove(tempSeatRef);
                window.cancelSelection(); 
                if(status === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô') alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ");
                else alert("‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π E-Ticket ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á");
                window.backToSchedule(); 
            });
        } else {
            const eventRoundRef = ref(db, basePath);
            runTransaction(eventRoundRef, (data) => {
                if(data) {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ config.capacity ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô data.config | ‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô data.config ‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö
                    const cap = data.config.capacity;
                    if(cap != -1 && (data.currentBooked||0) >= cap) return;
                    data.currentBooked = (data.currentBooked || 0) + 1;
                } return data;
            }).then((res) => {
                if(res.committed) {
                    push(ref(db, `${basePath}/bookings`), bookingData);
                    window.cancelSelection(); 
                    if(status === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô') alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ");
                    else alert("‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π E-Ticket ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á");
                    window.backToSchedule(); 
                } else alert("‚ùå ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            });
        }
    }

    // --- PAY LATER & E-TICKET ---
    window.openPayLaterModal = (type, itemId, roundId, bookingKey, price) => {
        payLaterData = { type, itemId, roundId, bookingKey };
        document.getElementById('pl-amount').innerText = price;
        document.getElementById('pl-qrcode').src = `https://promptpay.io/${PROMPTPAY_NUMBER}/${price}.png`;
        document.getElementById('pl-slip-url').value = '';
        document.getElementById('pay-later-modal').classList.add('active');
    };

    window.submitPayLater = () => {
        const slipUrl = document.getElementById('pl-slip-url').value.trim();
        if(!slipUrl) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏™‡∏•‡∏¥‡∏õ"); return; }

        const { type, itemId, roundId, bookingKey } = payLaterData;
        const isOldData = (roundId === 'old-data');
        const path = isOldData 
            ? `${type}s/${itemId}/bookings/${bookingKey}` 
            : `${type}s/${itemId}/rounds/${roundId}/bookings/${bookingKey}`;

        update(ref(db, path), { slipUrl: slipUrl, paymentStatus: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', timestamp: Date.now() }).then(() => {
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö");
            document.getElementById('pay-later-modal').classList.remove('active');
            if(!document.getElementById('page-profile').classList.contains('hidden')) window.showProfile();
        });
    };

    window.viewTicket = (title, location, dateStr, timeStr, seatLabel, userName, qrData, isCheckedIn) => {
        document.getElementById('t-title').innerText = title;
        document.getElementById('t-location').innerText = location || '-';
        document.getElementById('t-date').innerText = dateStr;
        document.getElementById('t-time').innerText = timeStr;
        document.getElementById('t-seat').innerText = seatLabel;
        document.getElementById('t-name').innerText = userName;
        document.getElementById('t-qrcode').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrData)}`;
        
        const wm = document.getElementById('t-watermark');
        if(isCheckedIn === 'true' || isCheckedIn === true) wm.classList.remove('hidden'); else wm.classList.add('hidden');
        document.getElementById('eticket-modal').classList.add('active');
    };

    window.downloadTicketPDF = () => {
        const element = document.getElementById('ticket-content');
        const style = document.createElement('style');
        style.innerHTML = `.ticket-right::before, .ticket-right::after { background: #ffffff !important; }`;
        element.appendChild(style);

        const opt = {
            margin: 0.5, filename: 'E-Ticket-' + document.getElementById('t-name').innerText + '.pdf',
            image: { type: 'jpeg', quality: 1 }, html2canvas: { scale: 3, useCORS: true, backgroundColor: null }, 
            jsPDF: { unit: 'in', format: 'a5', orientation: 'landscape' } 
        };
        html2pdf().set(opt).from(element).save().then(() => { element.removeChild(style); });
    };
    
    // --- Profile & History ---
    window.showProfile = () => {
        if(!currentUser) return; 
        window.showPage('page-profile');
        document.getElementById('p-name').value = userData.name || '';
        document.getElementById('p-phone').value = userData.phone || '';
        document.getElementById('p-idcard').value = userData.idCard || '';

        const hList = document.getElementById('history-list');
        hList.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</td></tr>';
        
        const myHistory = [];
        const myEmail = currentUser.email;

        ['movie', 'event'].forEach(type => {
            const dataObj = allData[type + 's'];
            if(dataObj) {
                Object.entries(dataObj).forEach(([itemId, item]) => {
                    const title = item.info ? item.info.title : (item.config ? item.config.title : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠');
                    
                    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                    if(item.rounds) {
                        Object.entries(item.rounds).forEach(([rId, rData]) => {
                            if(rData.bookings) {
                                Object.entries(rData.bookings).forEach(([bookingKey, b]) => {
                                    if(b.email === myEmail) {
                                        myHistory.push({ 
                                            timestamp: b.timestamp, itemTitle: title, 
                                            detail: type==='movie' ? `‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ${bookingKey}` : '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô', 
                                            slip: b.slipUrl, status: b.paymentStatus, type: type, itemId: itemId, roundId: rId, bookingKey: bookingKey, 
                                            price: rData.config.price || 0, location: rData.config.location, userName: b.name, eventDate: rData.config.showStart,
                                            isCheckedIn: b.isCheckedIn
                                        });
                                    }
                                });
                            }
                        });
                    }

                    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ rounds ‡πÅ‡∏ï‡πà‡∏°‡∏µ bookings)
                    if (item.bookings) {
                        Object.entries(item.bookings).forEach(([bookingKey, b]) => {
                            if(b.email === myEmail) {
                                myHistory.push({ 
                                    timestamp: b.timestamp, itemTitle: title, 
                                    detail: type==='movie' ? `‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ${bookingKey} (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)` : '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)', 
                                    slip: b.slipUrl, status: b.paymentStatus, type: type, itemId: itemId, roundId: 'old-data', bookingKey: bookingKey, 
                                    price: item.config.price || 0, location: item.config.location, userName: b.name, eventDate: item.config.start,
                                    isCheckedIn: b.isCheckedIn
                                });
                            }
                        });
                    }
                });
            }
        });

        myHistory.sort((a,b) => b.timestamp - a.timestamp);
        hList.innerHTML = '';
        if(myHistory.length === 0) {
            hList.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ</td></tr>';
        } else {
            myHistory.forEach(h => {
                let actionHtml = '';
                if (h.status === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô') {
                    const timeLeftMin = Math.floor((10 * 60 * 1000 - (Date.now() - h.timestamp)) / 60000);
                    if (timeLeftMin >= 0) {
                        actionHtml = `<button class="btn-sm" style="background:#f39c12; color:white; margin-top:5px; font-weight:bold;" onclick="openPayLaterModal('${h.type}', '${h.itemId}', '${h.roundId}', '${h.bookingKey}', ${h.price})">üí∞ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (${timeLeftMin} ‡∏ô‡∏≤‡∏ó‡∏µ)</button>`;
                    } else {
                        actionHtml = `<span style="color:red; font-size:0.8rem; display:block; margin-top:5px;">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>`;
                    }
                } else {
                    const qrDataStr = `TICKET|${h.type}|${h.itemId}|${h.roundId}|${h.bookingKey}|${h.userName}`;
                    const dateStr = h.eventDate ? new Date(h.eventDate).toLocaleDateString() : '-';
                    const timeStr = h.eventDate ? new Date(h.eventDate).toLocaleTimeString([], {timeStyle: 'short'}) : '-';
                    actionHtml = `
                        <button class="btn-sm" style="background:#8e44ad; color:white; margin-top:5px; font-weight:bold;" 
                        onclick="viewTicket('${h.itemTitle}', '${h.location || ''}', '${dateStr}', '${timeStr}', '${h.detail}', '${h.userName}', '${qrDataStr}', ${h.isCheckedIn ? true : false})">
                        üé´ ‡∏î‡∏π E-Ticket</button>
                    `;
                    if (h.slip) actionHtml += `<a href="${h.slip}" target="_blank" style="font-size:0.8rem; color:#1a73e8; display:block; margin-top:5px;">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>`;
                }

                let badgeColor = h.status === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' ? '#f39c12' : (h.status === '‡∏ü‡∏£‡∏µ' ? '#2ecc71' : '#17a2b8');
                let checkInBadge = h.isCheckedIn ? `<br><span style="color:#2ecc71; font-size:0.8rem; font-weight:bold;">(‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß)</span>` : `<br><span style="color:#e74c3c; font-size:0.8rem;">(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)</span>`;
                if(h.status === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô') checkInBadge = '';

                hList.innerHTML += `<tr>
                    <td>${new Date(h.timestamp).toLocaleDateString()} <br><small>${new Date(h.timestamp).toLocaleTimeString()}</small></td>
                    <td>${h.itemTitle} <br><small style="color:#666;">${h.detail}</small></td>
                    <td><span style="background:${badgeColor}; color:white; padding:3px 8px; border-radius:10px; font-size:0.8rem;">${h.status || '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß'}</span>${checkInBadge}<div style="margin-top:5px;">${actionHtml}</div></td>
                </tr>`;
            });
        }
    }

    // --- Admin: Order Management ---
    window.showOrderManagement = () => {
        if(userRole !== 'admin') return;
        window.showPage('page-orders');
        const tbody = document.getElementById('all-orders-list');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
        
        let allBookings = [];
        ['movie', 'event'].forEach(type => {
            const dataObj = allData[type + 's'];
            if(dataObj) {
                Object.entries(dataObj).forEach(([itemId, item]) => {
                    const title = item.info ? item.info.title : (item.config ? item.config.title : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠');
                    
                    // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                    if(item.rounds) {
                        Object.entries(item.rounds).forEach(([rId, rData]) => {
                            if(rData.bookings) {
                                Object.entries(rData.bookings).forEach(([bookingKey, b]) => {
                                    allBookings.push({
                                        path: `${type}s/${itemId}/rounds/${rId}/bookings/${bookingKey}`,
                                        title: title, seat: type==='movie'?`‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: ${bookingKey}`:'‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°',
                                        data: b, type: type, itemId: itemId, roundId: rId
                                    });
                                });
                            }
                        });
                    }

                    // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤
                    if(item.bookings) {
                        Object.entries(item.bookings).forEach(([bookingKey, b]) => {
                            allBookings.push({
                                path: `${type}s/${itemId}/bookings/${bookingKey}`,
                                title: title + " (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)", seat: type==='movie'?`‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: ${bookingKey}`:'‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°',
                                data: b, type: type, itemId: itemId, roundId: 'old-data'
                            });
                        });
                    }
                });
            }
        });
        
        allBookings.sort((a,b) => b.data.timestamp - a.data.timestamp);
        tbody.innerHTML = '';
        if(allBookings.length === 0) return tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
        
        allBookings.forEach(order => {
            const b = order.data;
            const dDate = new Date(b.timestamp).toLocaleString();
            const slipLink = b.slipUrl ? `<a href="${b.slipUrl}" target="_blank" style="color:#1a73e8; font-weight:bold;">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>` : '-';
            
            let selectHtml = `<select onchange="updateOrderStatus('${order.path}', this.value, '${order.type}', '${order.itemId}', '${order.roundId}')" style="padding:5px; border-radius:4px; border:1px solid #ddd; font-family:'Sarabun';">`;
            ['‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß', '‡∏ü‡∏£‡∏µ', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'].forEach(opt => selectHtml += `<option value="${opt}" ${b.paymentStatus === opt ? 'selected' : ''}>${opt}</option>`);
            selectHtml += `</select>`;

            let checkInStatus = b.isCheckedIn ? `<span style="color:#2ecc71; font-weight:bold;">‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>` : `<span style="color:#e74c3c;">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</span>`;
            
            tbody.innerHTML += `<tr><td>${dDate}</td><td><b>${order.title}</b><br><small style="color:#666;">${order.seat}</small></td><td>${b.name}<br><small>${b.phone}</small></td><td>${slipLink}</td><td>${selectHtml}</td><td>${checkInStatus}</td></tr>`;
        });
    };

    window.updateOrderStatus = (path, newStatus, type, itemId, roundId) => {
        if(userRole !== 'admin') return;
        if(newStatus === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') {
            if(confirm("‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                remove(ref(db, path)).then(() => {
                    if(type === 'event') {
                        const eventPath = roundId === 'old-data' 
                            ? `events/${itemId}/currentBooked` 
                            : `events/${itemId}/rounds/${roundId}/currentBooked`;
                        runTransaction(ref(db, eventPath), (c) => (c || 1) - 1);
                    }
                    alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                });
            } else { if(!document.getElementById('page-orders').classList.contains('hidden')) window.showOrderManagement(); }
        } else {
            const updates = { paymentStatus: newStatus };
            if (newStatus === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô') { updates.timestamp = Date.now(); alert("‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà 10 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß"); }
            update(ref(db, path), updates);
        }
    };

    // üåü --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å / ‡∏£‡∏≠‡∏ö (Parent-Child Forms) --- üåü

    window.openItemModal = (type) => {
        if(userRole !== 'admin') return;
        document.getElementById('item-main-modal').classList.add('active');
        document.getElementById('im-id').value = '';
        document.getElementById('im-type').value = type;
        document.getElementById('im-modal-title').innerText = `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${type==='movie'?'‡∏´‡∏ô‡∏±‡∏á':'‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå'} (‡πÉ‡∏´‡∏°‡πà)`;
        document.querySelectorAll('#item-main-modal input:not([type=hidden]), #item-main-modal textarea').forEach(i => i.value = '');
    }

    window.editCurrentItem = () => {
        if(userRole !== 'admin') return;
        document.getElementById('item-main-modal').classList.add('active');
        document.getElementById('im-id').value = currentItemId;
        document.getElementById('im-type').value = currentType;
        document.getElementById('im-modal-title').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å";
        
        // ‡∏î‡∏∂‡∏á info (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ config ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        const info = allData[currentType + 's'][currentItemId].info || allData[currentType + 's'][currentItemId].config;
        document.getElementById('im-title').value = info.title || '';
        document.getElementById('im-image').value = info.image || '';
        document.getElementById('im-detail').value = info.detail || '';
        document.getElementById('im-dates').value = info.showDates || '';
    }

    window.saveMainItem = (e) => {
        e.preventDefault();
        if(userRole !== 'admin') return;
        const id = document.getElementById('im-id').value;
        const type = document.getElementById('im-type').value;
        const isNew = (id === '');
        
        const payload = { 
            title: document.getElementById('im-title').value, 
            image: document.getElementById('im-image').value,
            detail: document.getElementById('im-detail').value,
            showDates: document.getElementById('im-dates').value
        };

        if (isNew) {
            const targetRef = push(ref(db, `${type}s`));
            set(targetRef, { info: payload }).then(() => {
                document.getElementById('item-main-modal').classList.remove('active');
                goHome();
            });
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÄ‡∏£‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á node .info ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢ (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
            const targetRef = ref(db, `${type}s/${id}/info`);
            update(targetRef, payload).then(() => {
                document.getElementById('item-main-modal').classList.remove('active');
            });
        }
    }

    window.deleteCurrentItem = () => {
        if(userRole !== 'admin') return;
        if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? (‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á/‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏¥‡πâ‡∏á)`)) {
            remove(ref(db, `${currentType}s/${currentItemId}`)).then(() => { goHome(); });
        }
    }

    window.openRoundModal = () => {
        if(userRole !== 'admin') return;
        document.getElementById('item-round-modal').classList.add('active');
        document.getElementById('rd-id').value = '';
        document.getElementById('rd-modal-title').innerText = `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà`;
        document.querySelectorAll('#item-round-modal input:not([type=hidden])').forEach(i => i.value = '');
        populateTicketTypeDropdownRound('');
        
        if(currentType === 'movie') { document.getElementById('rd-movie-fields').classList.remove('hidden'); document.getElementById('rd-event-fields').classList.add('hidden'); } 
        else { document.getElementById('rd-movie-fields').classList.add('hidden'); document.getElementById('rd-event-fields').classList.remove('hidden'); }
    }

    window.editRoundItem = (roundId) => {
        if(userRole !== 'admin') return;
        window.openRoundModal();
        document.getElementById('rd-modal-title').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≠‡∏ö";
        document.getElementById('rd-id').value = roundId;
        const conf = allData[currentType + 's'][currentItemId].rounds[roundId].config;
        
        document.getElementById('rd-location').value = conf.location || '';
        document.getElementById('rd-price').value = conf.price || '';
        document.getElementById('rd-book-start').value = conf.bookStart || '';
        document.getElementById('rd-book-end').value = conf.bookEnd || '';
        document.getElementById('rd-show-start').value = conf.showStart || '';
        document.getElementById('rd-show-end').value = conf.showEnd || '';

        populateTicketTypeDropdownRound(conf.ticketType || '');

        if(currentType === 'movie') { 
            document.getElementById('rd-rows').value = conf.rows || ''; 
            document.getElementById('rd-cols').value = conf.cols || ''; 
            document.getElementById('rd-blocked').value = conf.blocked || ''; 
        } else { 
            document.getElementById('rd-cap').value = conf.capacity || ''; 
        }
    }

    window.saveRoundItem = (e) => {
        e.preventDefault();
        if(userRole !== 'admin') return;
        const rId = document.getElementById('rd-id').value;
        const isNew = (rId === '');
        
        const payload = { 
            location: document.getElementById('rd-location').value,
            ticketType: document.getElementById('rd-ticket-type').value,
            price: document.getElementById('rd-price').value,
            bookStart: document.getElementById('rd-book-start').value, 
            bookEnd: document.getElementById('rd-book-end').value,
            showStart: document.getElementById('rd-show-start').value,
            showEnd: document.getElementById('rd-show-end').value
        };

        if(currentType === 'movie') { 
            payload.rows = parseInt(document.getElementById('rd-rows').value); 
            payload.cols = parseInt(document.getElementById('rd-cols').value); 
            payload.blocked = document.getElementById('rd-blocked').value; 
        } else { 
            payload.capacity = parseInt(document.getElementById('rd-cap').value); 
        }
        
        const path = `${currentType}s/${currentItemId}/rounds`;
        
        if(isNew) {
            const targetRef = push(ref(db, path));
            const saveObj = { config: payload };
            if(currentType === 'event') saveObj.currentBooked = 0;
            set(targetRef, saveObj).then(() => { document.getElementById('item-round-modal').classList.remove('active'); });
        } else {
            const targetRef = ref(db, `${path}/${rId}/config`);
            update(targetRef, payload).then(() => { document.getElementById('item-round-modal').classList.remove('active'); });
        }
    }

    window.deleteRoundItem = (rId) => {
        if(userRole !== 'admin') return;
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢)")) {
            remove(ref(db, `${currentType}s/${currentItemId}/rounds/${rId}`));
        }
    }

    function populateTicketTypeDropdownRound(val) {
        const select = document.getElementById('rd-ticket-type');
        select.innerHTML = '<option value="" data-price="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£ --</option>';
        if(allData.ticketTypes) {
            Object.values(allData.ticketTypes).forEach(t => {
                select.innerHTML += `<option value="${t.name}" data-price="${t.price}" ${t.name===val?'selected':''}>${t.name} (‡∏ø${t.price})</option>`;
            });
        }
        if(val && !select.querySelector(`option[value="${val}"]`)) {
            select.innerHTML += `<option value="${val}" data-price="" selected>${val} (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)</option>`;
        }
    }
    window.updatePriceFromTypeRound = () => {
        const select = document.getElementById('rd-ticket-type');
        const p = select.options[select.selectedIndex].getAttribute('data-price');
        if(p) document.getElementById('rd-price').value = p;
    }


    // --- Ticket Types Management ---
    window.showTicketTypesManagement = () => {
        if(userRole !== 'admin') return;
        window.showPage('page-ticket-types');
        const list = document.getElementById('ticket-types-list');
        list.innerHTML = '';
        if (allData.ticketTypes) {
            Object.entries(allData.ticketTypes).forEach(([id, t]) => {
                list.innerHTML += `<tr><td>${t.name}</td><td>‡∏ø${t.price}</td><td><button class="btn-sm btn-edit" onclick="openTicketTypeModal('${id}', '${t.name}', ${t.price})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn-sm btn-del" onclick="deleteTicketType('${id}')">‡∏•‡∏ö</button></td></tr>`;
            });
        } else list.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</td></tr>';
    }
    window.openTicketTypeModal = (id = '', name = '', price = '') => {
        if(userRole !== 'admin') return;
        document.getElementById('tt-modal-title').innerText = id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£';
        document.getElementById('tt-id').value = id;
        document.getElementById('tt-name').value = name;
        document.getElementById('tt-price').value = price;
        document.getElementById('ticket-type-modal').classList.add('active');
    }
    window.saveTicketType = (e) => {
        e.preventDefault(); if(userRole !== 'admin') return;
        const id = document.getElementById('tt-id').value;
        const targetRef = id ? ref(db, `ticketTypes/${id}`) : push(ref(db, 'ticketTypes'));
        set(targetRef, { name: document.getElementById('tt-name').value, price: parseInt(document.getElementById('tt-price').value) }).then(() => {
            document.getElementById('ticket-type-modal').classList.remove('active');
        });
    }
    window.deleteTicketType = (id) => {
        if(userRole !== 'admin') return;
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ?")) remove(ref(db, `ticketTypes/${id}`));
    }

    // --- Banner Management ---
    window.showBannerManagement = () => {
        if(userRole !== 'admin') return;
        window.showPage('page-banners');
        const list = document.getElementById('banners-list-admin');
        list.innerHTML = '';
        if (allData.settings && allData.settings.banners) {
            Object.entries(allData.settings.banners).forEach(([id, b]) => {
                const statusBadge = (b.isActive === true || b.isActive === 'true') ? '<span style="color:#2ecc71; font-weight:bold;">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>' : '<span style="color:#e74c3c;">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>';
                list.innerHTML += `<tr><td><img src="${b.imageUrl}" style="width:100px; height:50px; object-fit:cover; border-radius:4px;"></td><td><a href="${b.linkUrl}" target="_blank" style="color:#1a73e8;">${b.linkUrl ? '‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå' : '-'}</a></td><td>${statusBadge}</td><td><button class="btn-sm btn-edit" onclick="openBannerFormModal('${id}', '${b.imageUrl}', '${b.linkUrl || ''}', '${b.isActive}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn-sm btn-del" onclick="deleteBanner('${id}')">‡∏•‡∏ö</button></td></tr>`;
            });
        } else list.innerHTML = '<tr><td colspan="4" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
    }
    window.openBannerFormModal = (id = '', imgUrl = '', linkUrl = '', isActive = 'true') => {
        if(userRole !== 'admin') return;
        document.getElementById('bf-modal-title').innerText = id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà';
        document.getElementById('bf-id').value = id;
        document.getElementById('bf-image').value = imgUrl;
        document.getElementById('bf-link').value = linkUrl;
        document.getElementById('bf-active').value = isActive === 'false' ? 'false' : 'true';
        document.getElementById('banner-form-modal').classList.add('active');
    }
    window.saveBannerData = (e) => {
        e.preventDefault(); if(userRole !== 'admin') return;
        const id = document.getElementById('bf-id').value;
        const targetRef = id ? ref(db, `settings/banners/${id}`) : push(ref(db, 'settings/banners'));
        set(targetRef, { imageUrl: document.getElementById('bf-image').value, linkUrl: document.getElementById('bf-link').value, isActive: document.getElementById('bf-active').value === 'true' }).then(() => {
            document.getElementById('banner-form-modal').classList.remove('active');
        });
    }
    window.deleteBanner = (id) => {
        if(userRole !== 'admin') return;
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?")) remove(ref(db, `settings/banners/${id}`));
    }

    // --- Auth & Users Management ---
    window.handleAuth = (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;

        if(isRegistering) {
            createUserWithEmailAndPassword(auth, email, pass).then((cred) => {
                const code = document.getElementById('reg-admin-code').value;
                set(ref(db, 'users/' + cred.user.uid), {
                    name: document.getElementById('reg-name').value,
                    phone: document.getElementById('reg-phone').value,
                    idCard: document.getElementById('reg-idcard').value,
                    email: email, role: (code === 'ADMIN999') ? 'admin' : 'user'
                });
            }).catch(err => alert("Error: " + err.message));
        } else {
            signInWithEmailAndPassword(auth, email, pass).then(()=>window.goHome()).catch(err => alert("Error: " + err.message));
        }
    };
    
    window.doLogout = () => { signOut(auth).then(()=>window.goHome()); };
    window.toggleAuthMode = () => {
        isRegistering = !isRegistering;
        document.getElementById('auth-title').innerText = isRegistering ? "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà" : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
        document.getElementById('btn-auth-submit').innerText = isRegistering ? "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
        document.getElementById('toggle-auth').innerText = isRegistering ? "‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
        document.getElementById('register-fields').classList.toggle('hidden');
        const fpLink = document.getElementById('forgot-password-link');
        if (fpLink) { if (isRegistering) fpLink.classList.add('hidden'); else fpLink.classList.remove('hidden'); }
    }
    window.updateUserProfile = (e) => {
        e.preventDefault();
        update(ref(db, `users/${currentUser.uid}`), { name: document.getElementById('p-name').value, phone: document.getElementById('p-phone').value }).then(() => alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
    }
    window.showForgotPasswordModal = () => document.getElementById('forgot-password-modal').classList.add('active');
    window.handleForgotPassword = () => {
        const email = document.getElementById('reset-email').value.trim();
        if (!email) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
        sendPasswordResetEmail(auth, email).then(() => {
            alert(`‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
            document.getElementById('forgot-password-modal').classList.remove('active');
        }).catch((error) => alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message));
    };
    
    window.showUserManagement = () => {
        if(userRole !== 'admin') return;
        window.showPage('page-users');
        onValue(ref(db, 'users'), (snap) => {
            const list = document.getElementById('user-list-admin');
            list.innerHTML = '';
            snap.forEach(child => {
                const u = child.val();
                list.innerHTML += `<tr><td>${u.name || '-'}</td><td>${u.email}</td><td>${u.phone || '-'}</td><td>${u.idCard || '-'}</td><td><span class="tag ${u.role==='admin'?'event':'movie'}">${u.role}</span></td><td><button class="btn-sm btn-edit" onclick="editUserAdmin('${child.key}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn-sm btn-del" onclick="deleteUserAdmin('${child.key}')">‡∏•‡∏ö</button></td></tr>`;
            });
        });
    }
    window.editUserAdmin = (uid) => {
        onValue(ref(db, 'users/' + uid), (snap) => {
            const u = snap.val();
            document.getElementById('edit-u-uid').value = uid; document.getElementById('edit-u-name').value = u.name || '';
            document.getElementById('edit-u-phone').value = u.phone || ''; document.getElementById('edit-u-idcard').value = u.idCard || '';
            document.getElementById('edit-u-role').value = u.role || 'user'; document.getElementById('user-edit-modal').classList.add('active');
        }, { onlyOnce: true });
    }
    window.saveUserAdmin = () => {
        const uid = document.getElementById('edit-u-uid').value;
        update(ref(db, 'users/' + uid), { name: document.getElementById('edit-u-name').value, phone: document.getElementById('edit-u-phone').value, idCard: document.getElementById('edit-u-idcard').value, role: document.getElementById('edit-u-role').value }).then(() => { 
            document.getElementById('user-edit-modal').classList.remove('active'); alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); 
        });
    }
    window.deleteUserAdmin = (uid) => { if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) remove(ref(db, 'users/' + uid)); }
</script>

</body>
</html>
