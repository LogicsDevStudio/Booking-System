<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß Realtime (Lock ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 900px; margin: 30px auto; padding: 20px; }
        
        header { text-align: center; margin-bottom: 30px; }
        h1 { color: #1a73e8; margin: 0; }
        p.subtitle { color: #666; font-size: 0.9rem; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; }
        .tag.movie { background: #e8f0fe; color: #1a73e8; }
        .tag.event { background: #fce8e6; color: #d93025; }

        .nav-back { display: none; margin-bottom: 20px; cursor: pointer; color: #555; font-weight: bold; }
        
        /* Seat Styles */
        .screen { background: #444; color: white; text-align: center; padding: 5px; margin: 20px 0; border-radius: 5px; box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
        .seat-map { display: grid; justify-content: center; gap: 10px; margin: 20px 0; overflow-x: auto; padding-bottom: 10px; }
        .seat { 
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white;
            transition: all 0.2s; position: relative;
        }
        
        /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≤‡∏á‡πÜ */
        .seat.available { background-color: #fff; border: 2px solid #28a745; color: #28a745; }
        .seat.available:hover { background-color: #28a745; color: white; }
        
        .seat.booked { background-color: #dc3545; border: 2px solid #dc3545; cursor: not-allowed; opacity: 0.6; }
        
        /* ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
        .seat.selecting { 
            background-color: #ffc107; border: 2px solid #ffc107; color: #333; 
            cursor: not-allowed; animation: pulse 1.5s infinite; 
        }
        
        .seat.blocked { background-color: #e2e6ea; border: 2px solid #ced4da; color: #adb5bd; cursor: not-allowed; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; position: relative; }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-confirm { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        #page-home, #page-movie, #page-event { display: none; }
        .active-page { display: block !important; }

        .legend { display: flex; gap: 15px; font-size: 0.9rem; justify-content: center; margin-top: 20px; flex-wrap: wrap;}
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 15px; height: 15px; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üéüÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£ Realtime</h1>
    </header>

    <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>

    <div id="page-home" class="active-page">
        <div id="movie-list" class="grid-container" style="margin-bottom: 30px;"></div>
        <div id="event-list" class="grid-container"></div>
    </div>

    <div id="page-movie">
        <h2 id="m-title" style="text-align:center;">Title</h2>
        <div class="screen">‡∏à‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</div>
        <div id="seat-map" class="seat-map"></div>
        
        <div class="legend">
            <div class="legend-item"><div class="dot" style="border:2px solid #28a745;"></div> ‡∏ß‡πà‡∏≤‡∏á</div>
            <div class="legend-item"><div class="dot" style="background:#ffc107;"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
            <div class="legend-item"><div class="dot" style="background:#dc3545;"></div> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
            <div class="legend-item"><div class="dot" style="background:#e2e6ea;"></div> ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á</div>
        </div>
    </div>

    <div id="page-event">
        <div style="text-align:center; background:white; padding:30px; border-radius:12px;">
            <h2 id="e-title">Event Title</h2>
            <p>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="e-remaining" style="font-weight:bold; color:#d93025;">-</span> / <span id="e-capacity">-</span></p>
            <button id="btn-event-book" class="btn-confirm" style="max-width: 200px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>
    </div>
</div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="cancelSelection()">&times;</span>
        <h3 id="modal-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
        <p id="modal-subtitle" style="color:#666; margin-bottom: 20px;">-</p>
        
        <form id="booking-form" onsubmit="submitBooking(event)">
            <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="fname" required></div>
            <div class="form-group"><label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="lname" required></div>
            <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="phone" required></div>
            <div class="form-group"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="email" required></div>
            <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input type="text" id="idcard" maxlength="13" required></div>
            <button type="submit" class="btn-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, push, set, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
    const firebaseConfig = {
        databaseURL: "https://booking-system-c1ebd-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global Vars
    let currentType = ''; 
    let currentId = '';
    let selectedTarget = ''; // seatId or 'ticket'
    let currentConfig = null;
    let tempSeatRef = null; // ‡πÄ‡∏Å‡πá‡∏ö Reference ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà Lock ‡πÑ‡∏ß‡πâ

    // --- 1. Load Data ---
    onValue(ref(db, '/'), (snapshot) => {
        const data = snapshot.val() || {};
        renderHome(data);
    });

    function renderHome(data) {
        const mList = document.getElementById('movie-list');
        const eList = document.getElementById('event-list');
        mList.innerHTML = ''; eList.innerHTML = '';

        if(data.movies) Object.keys(data.movies).forEach(k => mList.appendChild(createCard(k, data.movies[k].config, 'movie')));
        if(data.events) Object.keys(data.events).forEach(k => eList.appendChild(createCard(k, data.events[k].config, 'event')));
    }

    function createCard(id, data, type) {
        if(!data) return document.createElement('div');
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <span class="tag ${type}">${type==='movie'?'‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå':'‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå'}</span>
            <h3>${data.title}</h3>
            <p>üìÖ ${data.start}</p>
        `;
        div.onclick = () => {
            if(type === 'movie') openMoviePage(id);
            else openEventPage(id);
        }
        return div;
    }

    // --- 2. Movie Logic (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô Temp Selection) ---
    window.openMoviePage = (id) => {
        currentType = 'movie'; currentId = id;
        switchPage('page-movie');

        // Load Config
        onValue(ref(db, `movies/${id}/config`), (snap) => {
            currentConfig = snap.val();
            document.getElementById('m-title').innerText = currentConfig.title;
            renderSeatsBase(currentConfig);
        });

        // Listen to Bookings AND Temp Selections
        onValue(ref(db, `movies/${id}`), (snap) => {
            const data = snap.val() || {};
            const bookings = data.bookings || {};
            const temps = data.temp_selections || {}; // Node ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"
            updateSeatStatus(bookings, temps);
        });
    }

    function renderSeatsBase(conf) {
        const map = document.getElementById('seat-map');
        map.innerHTML = '';
        map.style.gridTemplateColumns = `repeat(${conf.cols}, 1fr)`;
        
        for(let r=0; r<conf.rows; r++) {
            const rowLabel = String.fromCharCode(65 + r);
            for(let c=1; c<=conf.cols; c++) {
                const seatId = `${rowLabel}${c}`;
                const seat = document.createElement('div');
                seat.className = 'seat available'; // Default
                seat.id = `seat-${seatId}`;
                seat.innerText = seatId;
                
                if(conf.blocked && conf.blocked.includes(seatId)) {
                    seat.classList.add('blocked');
                    seat.classList.remove('available');
                } else {
                    seat.onclick = () => selectSeat(seatId);
                }
                map.appendChild(seat);
            }
        }
    }

    function updateSeatStatus(bookings, temps) {
        document.querySelectorAll('.seat').forEach(s => {
            const sid = s.id.replace('seat-', '');
            if(s.classList.contains('blocked')) return;

            // Reset First
            s.className = 'seat available';
            s.onclick = () => selectSeat(sid);

            // 1. Check if Booked (‡∏™‡∏µ‡πÅ‡∏î‡∏á)
            if(bookings[sid]) {
                s.className = 'seat booked';
                s.onclick = null;
                return;
            }

            // 2. Check if Selecting (‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)
            if(temps[sid]) {
                const now = Date.now();
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á)
                if (now - temps[sid].timestamp < 5 * 60 * 1000) {
                    s.className = 'seat selecting';
                    s.onclick = null; // ‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≠‡∏ô
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ß‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°
                    if(selectedTarget === sid && document.getElementById('booking-modal').classList.contains('active')) {
                        // This is me
                    }
                    return;
                }
            }
        });
    }

    // --- 3. Temp Selection Logic (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ---
    window.selectSeat = (seatId) => {
        if(!checkTime(currentConfig.start, currentConfig.end)) return;

        // ‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á temp_selections
        const tempRef = ref(db, `movies/${currentId}/temp_selections/${seatId}`);
        
        runTransaction(tempRef, (currentData) => {
            if (currentData === null) {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -> ‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                return { timestamp: Date.now(), user_token: Math.random() };
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (5 ‡∏ô‡∏≤‡∏ó‡∏µ)
                if (Date.now() - currentData.timestamp > 5 * 60 * 1000) {
                    return { timestamp: Date.now(), user_token: Math.random() }; // ‡∏ó‡∏±‡∏ö‡πÄ‡∏•‡∏¢
                }
                return; // ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà Abort
            }
        }).then((result) => {
            if (result.committed) {
                // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: Lock ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß -> ‡πÄ‡∏õ‡∏¥‡∏î Modal
                selectedTarget = seatId;
                tempSeatRef = tempRef; 
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ onDisconnect: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏•‡∏ö Temp ‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                onDisconnect(tempRef).remove();

                openModal(`‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: ${seatId}`);
            } else {
                alert("‚ö†Ô∏è ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö");
            }
        });
    }

    // --- 4. Cancel Logic (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Modal) ---
    window.cancelSelection = () => {
        const modal = document.getElementById('booking-modal');
        modal.classList.remove('active');
        document.getElementById('booking-form').reset();

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö Temp ‡∏≠‡∏≠‡∏Å
        if(currentType === 'movie' && tempSeatRef) {
            remove(tempSeatRef);
            onDisconnect(tempSeatRef).cancel(); // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å onDisconnect
            tempSeatRef = null;
            selectedTarget = '';
        }
    };

    // --- 5. Submit Booking ---
    window.submitBooking = (e) => {
        e.preventDefault();
        const userData = {
            firstName: document.getElementById('fname').value,
            lastName: document.getElementById('lname').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            idCard: document.getElementById('idcard').value,
            timestamp: Date.now()
        };

        if(currentType === 'movie') {
            // ‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å Temp -> Bookings
            const bookingRef = ref(db, `movies/${currentId}/bookings/${selectedTarget}`);
            set(bookingRef, userData)
                .then(() => {
                    // ‡∏•‡∏ö Temp ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡πâ‡∏ß
                    if(tempSeatRef) remove(tempSeatRef);
                    closeModalSuccess();
                    alert("‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                })
                .catch((err) => alert("Error: " + err.message));

        } else {
            // Logic ‡∏à‡∏≠‡∏á Event (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            const eventRef = ref(db, `events/${currentId}`);
            runTransaction(eventRef, (data) => {
                if(data) {
                    if(data.config.capacity != -1 && (data.currentBooked||0) >= data.config.capacity) return;
                    data.currentBooked = (data.currentBooked || 0) + 1;
                }
                return data;
            }).then((res) => {
                if(res.committed) {
                    push(ref(db, `events/${currentId}/bookings`), userData);
                    closeModalSuccess();
                    alert("‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                } else {
                    alert("‚ùå ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß");
                }
            });
        }
    };

    // --- Helpers ---
    function openModal(text) {
        document.getElementById('modal-subtitle').innerText = text;
        document.getElementById('booking-modal').classList.add('active');
    }

    function closeModalSuccess() {
        document.getElementById('booking-modal').classList.remove('active');
        document.getElementById('booking-form').reset();
        // Reset ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Temp ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á remove(tempSeatRef) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô submit ‡πÅ‡∏•‡πâ‡∏ß
        if(tempSeatRef) onDisconnect(tempSeatRef).cancel();
        tempSeatRef = null;
        selectedTarget = '';
    }

    window.openEventPage = (id) => {
        currentType = 'event'; currentId = id; switchPage('page-event');
        onValue(ref(db, `events/${id}`), (snap) => {
            const d = snap.val();
            if(!d) return;
            currentConfig = d.config;
            const cap = d.config.capacity;
            const cur = d.currentBooked || 0;
            document.getElementById('e-title').innerText = currentConfig.title;
            document.getElementById('e-remaining').innerText = cap==-1 ? '‚àû' : (cap - cur);
            document.getElementById('e-capacity').innerText = cap==-1 ? '‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î' : cap;
            
            const btn = document.getElementById('btn-event-book');
            if(cap!=-1 && cur>=cap) { btn.disabled=true; btn.innerText="‡πÄ‡∏ï‡πá‡∏°"; btn.style.background="#ccc"; }
            else { btn.disabled=false; btn.innerText="‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô"; btn.style.background="#28a745"; btn.onclick=()=>openModal(d.config.title); }
        });
    }

    window.switchPage = (pid) => {
        document.querySelectorAll('.active-page').forEach(e=>e.classList.remove('active-page'));
        document.getElementById(pid).classList.add('active-page');
        document.querySelector('.nav-back').style.display = (pid==='page-home') ? 'none' : 'block';
    }
    window.goHome = () => { 
        if(currentType === 'movie' && tempSeatRef) cancelSelection(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Temp ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
        switchPage('page-home'); 
    }
    function checkTime(s, e) {
        const n = new Date();
        if(n < new Date(s)) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î"); return false; }
        if(n > new Date(e)) { alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤"); return false; }
        return true;
    }
</script>

</body>
</html>
