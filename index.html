<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß Realtime (‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        /* Navbar */
        .navbar { background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .brand { font-size: 1.2rem; font-weight: bold; color: #1a73e8; cursor: pointer; }
        .nav-menu { display: flex; gap: 15px; align-items: center; }
        .nav-item { cursor: pointer; color: #555; font-size: 0.95rem; }
        .nav-item:hover { color: #1a73e8; }
        .btn-logout { color: #d93025; cursor: pointer; font-weight: bold; border: 1px solid #d93025; padding: 5px 10px; border-radius: 4px; }

        /* Auth Page */
        .auth-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .link-text { color: #1a73e8; cursor: pointer; font-size: 0.9rem; margin-top: 15px; display: block; }
        .admin-code-area { background: #f9f9f9; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.8rem; color: #666; text-align: left; }

        /* General UI */
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #1a73e8; margin: 0; }
        .btn-primary { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
        .tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; }
        .tag.movie { background: #e8f0fe; color: #1a73e8; }
        .tag.event { background: #fce8e6; color: #d93025; }

        /* Admin Controls */
        .admin-actions { display: flex; gap: 5px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: none; color: white; flex: 1; }
        .btn-edit { background: #f39c12; } .btn-del { background: #e74c3c; } 
        .admin-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #e8f0fe; padding: 15px; border-radius: 8px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: 600; }

        /* Seat Styles */
        .screen { background: #444; color: white; text-align: center; padding: 5px; margin: 20px 0; border-radius: 5px; box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
        .seat-map { display: grid; justify-content: center; gap: 10px; margin: 20px 0; overflow-x: auto; padding-bottom: 10px; }
        .seat { 
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white;
            transition: all 0.2s; position: relative;
        }
        .seat.available { background-color: #fff; border: 2px solid #28a745; color: #28a745; }
        .seat.available:hover { background-color: #28a745; color: white; }
        .seat.booked { background-color: #dc3545; border: 2px solid #dc3545; cursor: not-allowed; opacity: 0.6; }
        .seat.selecting { background-color: #ffc107; border: 2px solid #ffc107; color: #333; cursor: not-allowed; animation: pulse 1.5s infinite; }
        .seat.blocked { background-color: #e2e6ea; border: 2px solid #ced4da; color: #adb5bd; cursor: not-allowed; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Modal & Helpers */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .hidden { display: none !important; }
        .nav-back { margin-bottom: 20px; cursor: pointer; color: #555; font-weight: bold; }
        .legend { display: flex; gap: 15px; font-size: 0.9rem; justify-content: center; margin-top: 20px; flex-wrap: wrap;}
        .legend-item { display: flex; align-items: center; gap: 5px; } .dot { width: 15px; height: 15px; border-radius: 3px; }
    </style>
</head>
<body>

<nav id="main-nav" class="hidden">
    <div class="nav-container">
        <div class="nav-logo">üé¨ Booking System</div>
        <ul class="nav-menu">
            <li><a href="#" onclick="goHome()">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
            <li id="nav-profile"><a href="#" onclick="showProfile()">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå & ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a></li>
            <li id="nav-admin-users" class="hidden"><a href="#" onclick="showUserManagement()">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a></li>
            
            <li id="nav-login-btn"><a href="#" onclick="showPage('page-auth')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></li>
            <li id="nav-logout-btn" class="hidden"><a href="#" onclick="doLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a></li>
        </ul>
    </div>
</nav>

<div class="container">

    <div id="page-auth" class="auth-container">
        <h2 id="auth-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <form id="auth-form" onsubmit="handleAuth(event)">
            <input type="email" id="auth-email" class="auth-input" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
            <input type="password" id="auth-pass" class="auth-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
            
            <div id="register-fields" class="hidden">
                <input type="text" id="reg-name" class="auth-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                <input type="tel" id="reg-phone" class="auth-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                <input type="text" id="reg-idcard" class="auth-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)" maxlength="13">
                <div class="admin-code-area">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
                    <input type="text" id="reg-admin-code" class="auth-input" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Admin" style="margin-top:5px;">
                    <small>* ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ "ADMIN999" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</small>
                </div>
            </div>

            <button type="submit" class="btn-primary" id="btn-auth-submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
        <span class="link-text" id="toggle-auth" onclick="toggleAuthMode()">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
    </div>

    <div id="page-home" class="hidden">
        <div id="admin-panel-home" class="admin-bar hidden">
            <span>üîß <b>Admin Dashboard</b></span>
            <div>
                <button class="btn-sm" style="background:#2ecc71; padding:8px 15px;" onclick="openAdminModal('movie')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á</button>
                <button class="btn-sm" style="background:#2ecc71; padding:8px 15px;" onclick="openAdminModal('event')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</button>
            </div>
        </div>

        <header><h1>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á</h1></header>
        <div id="movie-list" class="grid-container" style="margin-bottom: 30px;"></div>
        <div id="event-list" class="grid-container"></div>
    </div>

    <div id="page-profile" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
        <div class="card" style="margin-bottom:20px;">
            <form onsubmit="updateUserProfile(event)">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label> <input type="text" id="p-name" class="auth-input">
                <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</label> <input type="tel" id="p-phone" class="auth-input">
                <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</label> <input type="text" id="p-idcard" class="auth-input" readonly style="background:#eee; color:#777;">
                <button type="submit" class="btn-primary" style="width:auto; margin-top:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </form>
        </div>
        <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
        <table id="history-table">
            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead>
            <tbody id="history-list"></tbody>
        </table>
    </div>

    <div id="page-users" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
        <table>
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>Role</th></tr></thead>
            <tbody id="user-list-admin"></tbody>
        </table>
    </div>

    <div id="page-movie" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2 id="m-title" style="text-align:center;">Title</h2>
        <div class="screen">‡∏à‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</div>
        <div id="seat-map" class="seat-map"></div>
        <div class="legend">
            <div class="legend-item"><div class="dot" style="border:2px solid #28a745;"></div> ‡∏ß‡πà‡∏≤‡∏á</div>
            <div class="legend-item"><div class="dot" style="background:#ffc107;"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
            <div class="legend-item"><div class="dot" style="background:#dc3545;"></div> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
            <div class="legend-item"><div class="dot" style="background:#e2e6ea;"></div> ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á</div>
        </div>
    </div>

    <div id="page-event" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <div style="text-align:center; background:white; padding:30px; border-radius:12px;">
            <h2 id="e-title">Event Title</h2>
            <p>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="e-remaining" style="font-weight:bold; color:#d93025;">-</span> / <span id="e-capacity">-</span></p>
            <button id="btn-event-book" class="btn-primary" style="max-width: 200px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>
    </div>

</div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
        <p id="modal-subtitle" style="margin-bottom: 15px; font-weight: bold; color: #1a73e8;"></p>
        
        <div class="form-group">
            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input type="text" id="inp-conf-name" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠">
        </div>
        <div class="form-group">
            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input type="tel" id="inp-conf-phone" placeholder="08x-xxx-xxxx">
        </div>
        <div class="form-group">
            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</label>
            <input type="email" id="inp-conf-email" placeholder="email@example.com">
        </div>
        <div class="form-group">
            <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input type="text" id="inp-conf-idcard" placeholder="‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å">
        </div>

        <div class="modal-buttons">
            <button class="btn-secondary" onclick="cancelSelection()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn-primary" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        </div>
    </div>
</div>

<div id="admin-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAdminModal()">&times;</span>
        <h3 id="adm-title-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <form onsubmit="saveAdminItem(event)">
            <input type="hidden" id="adm-id">
            <input type="hidden" id="adm-type">
            
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label><input type="text" id="adm-title" class="auth-input" required>
            <label>‡πÄ‡∏£‡∏¥‡πà‡∏°:</label><input type="datetime-local" id="adm-start" class="auth-input" required>
            <label>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label><input type="datetime-local" id="adm-end" class="auth-input" required>

            <div id="adm-movie-fields" class="hidden">
                <div style="display:flex; gap:10px;">
                    <div style="width:50%"><label>‡πÅ‡∏ñ‡∏ß:</label><input type="number" id="adm-rows" class="auth-input"></div>
                    <div style="width:50%"><label>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡πÅ‡∏ñ‡∏ß:</label><input type="number" id="adm-cols" class="auth-input"></div>
                </div>
                <label>Blocked (ex: A1,A2):</label><input type="text" id="adm-blocked" class="auth-input">
            </div>

            <div id="adm-event-fields" class="hidden">
                <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ (-1=‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î):</label><input type="number" id="adm-cap" class="auth-input">
            </div>

            <button type="submit" class="btn-primary" style="background:#2ecc71;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </form>
    </div>
</div>

<div id="user-edit-modal" class="modal">
    <div class="modal-content">
        <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
        <input type="hidden" id="edit-u-uid">
        <div class="form-group">
            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input type="text" id="edit-u-name">
        </div>
        <div class="form-group">
            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
            <input type="text" id="edit-u-phone">
        </div>
        <div class="form-group">
            <label>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Role)</label>
            <select id="edit-u-role" style="width:100%; padding:10px; margin-top:5px;">
                <option value="user">User (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
                <option value="admin">Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</option>
            </select>
        </div>
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="document.getElementById('user-edit-modal').classList.remove('active')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn-primary" onclick="saveUserAdmin()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>
</div>

<div id="booking-list-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: <span id="bl-title"></span></h3>
        <div style="overflow-x:auto; max-height: 400px; overflow-y:auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡∏ö‡∏±‡∏ï‡∏£</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
                        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="bl-list">
                    </tbody>
            </table>
        </div>
        <div class="modal-buttons" style="margin-top:20px;">
            <button class="btn-secondary" onclick="document.getElementById('booking-list-modal').classList.remove('active')">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, push, set, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- ‡πÉ‡∏™‡πà Config ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
    const firebaseConfig = {
        apiKey: "AIzaSyAJGlD_kNVgRHVAdmUUgZAerrjX8nJbMJE",
        authDomain: "booking-system-c1ebd.firebaseapp.com",
        databaseURL: "https://booking-system-c1ebd-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "booking-system-c1ebd",
        storageBucket: "booking-system-c1ebd.firebasestorage.app",
        messagingSenderId: "140390358651",
        appId: "1:140390358651:web:cf9dc2624697c4d93f0cde"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- Global State ---
    let currentUser = null;
    let userRole = 'guest'; // default ‡∏Ñ‡∏∑‡∏≠ guest
    let userData = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏ñ‡πâ‡∏≤ Login
    let isRegistering = false;
    let allData = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á/Event ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• + ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏´‡πâ Guest (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô LocalStorage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Session ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á)
    let guestId = localStorage.getItem('guest_uid');
    if (!guestId) {
        guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('guest_uid', guestId);
    }

    let currentType = ''; 
    let currentId = '';
    let selectedTarget = '';
    let currentConfig = null;
    let tempSeatRef = null;

    // --- 1. Authentication & Initialization ---
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            // --- ‡∏Å‡∏£‡∏ì‡∏µ Login ‡πÅ‡∏•‡πâ‡∏ß ---
            onValue(ref(db, 'users/' + user.uid), (snap) => {
                userData = snap.val() || {};
                userRole = userData.role || 'user';
                updateNavbarUI(true);
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                if(!document.getElementById('page-auth').classList.contains('hidden')) goHome();
            });
        } else {
            // --- ‡∏Å‡∏£‡∏ì‡∏µ Guest (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login) ---
            userRole = 'guest';
            userData = {};
            updateNavbarUI(false);
            // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
            if(document.getElementById('page-auth').classList.contains('hidden')) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Auth ‡∏Å‡πá‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ
            } else {
                goHome(); // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Auth ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ Home (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ)
            }
        }
    });
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á/Event ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Guest ‡πÄ‡∏´‡πá‡∏ô Real-time)
    onValue(ref(db, '/'), (snapshot) => {
        allData = snapshot.val() || {};
        renderHomeList();
    });

    function updateNavbarUI(isLoggedIn) {
        document.getElementById('main-nav').classList.remove('hidden');
        
        // ‡∏õ‡∏∏‡πà‡∏° Admin
        if(userRole === 'admin') document.getElementById('nav-admin-users').classList.remove('hidden');
        else document.getElementById('nav-admin-users').classList.add('hidden');

        // ‡∏õ‡∏∏‡πà‡∏° Profile & Logout
        if(isLoggedIn) {
            document.getElementById('nav-profile').classList.remove('hidden');
            document.getElementById('nav-logout-btn').classList.remove('hidden');
            document.getElementById('nav-login-btn').classList.add('hidden');
        } else {
            document.getElementById('nav-profile').classList.add('hidden');
            document.getElementById('nav-logout-btn').classList.add('hidden');
            document.getElementById('nav-login-btn').classList.remove('hidden');
        }
    }

    window.handleAuth = (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;

        if(isRegistering) {
            createUserWithEmailAndPassword(auth, email, pass).then((cred) => {
                const code = document.getElementById('reg-admin-code').value;
                const role = (code === 'ADMIN999') ? 'admin' : 'user';
                set(ref(db, 'users/' + cred.user.uid), {
                    name: document.getElementById('reg-name').value,
                    phone: document.getElementById('reg-phone').value,
                    idCard: document.getElementById('reg-idcard').value,
                    email: email,
                    role: role
                });
            }).catch(err => alert("Error: " + err.message));
        } else {
            signInWithEmailAndPassword(auth, email, pass).then(()=>{
                goHome();
            }).catch(err => alert("Error: " + err.message));
        }
    };

    window.doLogout = () => {
        signOut(auth).then(() => {
            alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
            goHome();
        });
    };

    window.toggleAuthMode = () => {
        isRegistering = !isRegistering;
        document.getElementById('auth-title').innerText = isRegistering ? "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà" : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
        document.getElementById('btn-auth-submit').innerText = isRegistering ? "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
        document.getElementById('toggle-auth').innerText = isRegistering ? "‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
        document.getElementById('register-fields').classList.toggle('hidden');
    }

    function renderNavbar() {
        document.getElementById('main-nav').classList.remove('hidden');
        if(userRole === 'admin') document.getElementById('nav-admin-users').classList.remove('hidden');
        else document.getElementById('nav-admin-users').classList.add('hidden');
    }

    // --- 2. Views ---
    function showPage(pid) {
        ['page-auth', 'page-home', 'page-movie', 'page-event', 'page-profile', 'page-users'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(pid).classList.remove('hidden');
    }
    window.goHome = () => {
        if(currentType === 'movie' && tempSeatRef) cancelSelection();
        showPage('page-home');
        renderHomeList();
    }

    // --- 3. Admin & Listings ---
    function renderHomeList() {
        const mList = document.getElementById('movie-list');
        const eList = document.getElementById('event-list');
        mList.innerHTML = ''; eList.innerHTML = '';

        const adminPanel = document.getElementById('admin-panel-home');
        if(userRole === 'admin') adminPanel.classList.remove('hidden');
        else adminPanel.classList.add('hidden');

        if(allData.movies) Object.keys(allData.movies).forEach(k => mList.appendChild(createCard(k, allData.movies[k].config, 'movie')));
        if(allData.events) Object.keys(allData.events).forEach(k => eList.appendChild(createCard(k, allData.events[k].config, 'event')));
    }

    function createCard(id, data, type) {
        if(!data) return document.createElement('div');
        const div = document.createElement('div');
        div.className = 'card';
        
        let adminHtml = '';
        if(userRole === 'admin') {
            adminHtml = `
                <div class="admin-actions">
                    <button class="btn-sm" style="background:#8e44ad; color:white;" onclick="viewBookings('${id}','${type}')">üë• ‡∏î‡∏π‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á</button>
                    <button class="btn-sm btn-edit" onclick="editItem('${id}','${type}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn-sm btn-del" onclick="deleteItem('${id}','${type}')">‡∏•‡∏ö</button>
                </div>
            `;
        }

        div.innerHTML = `
            <span class="tag ${type}">${type==='movie'?'‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå':'‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå'}</span>
            <h3>${data.title}</h3>
            <p>üìÖ ${new Date(data.start).toLocaleString()}</p>
            ${adminHtml}
        `;
        div.onclick = (e) => {
            if(e.target.tagName !== 'BUTTON') {
                if(type === 'movie') openMoviePage(id);
                else openEventPage(id);
            }
        }
        return div;
    }

    // --- Feature: ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (Admin) ---
    window.viewBookings = (id, type) => {
        if(userRole !== 'admin') return;
        const targetData = type === 'movie' ? allData.movies[id] : allData.events[id];
        const bookings = targetData.bookings || {};
        document.getElementById('booking-list-modal').classList.add('active');
        document.getElementById('bl-title').innerText = targetData.config.title;
        const tbody = document.getElementById('bl-list');
        tbody.innerHTML = '';
        if(Object.keys(bookings).length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</td></tr>'; return;
        }
        Object.entries(bookings).forEach(([key, val]) => {
            const seatLabel = type === 'movie' ? key : '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
            const deletePath = `${type==='movie'?'movies':'events'}/${id}/bookings/${key}`;
            tbody.innerHTML += `<tr><td><span class="tag movie">${seatLabel}</span></td><td>${val.name}</td><td>${val.phone}</td><td>${new Date(val.timestamp).toLocaleDateString()}</td><td><button class="btn-sm btn-del" onclick="cancelBookingAdmin('${deletePath}', '${type}', '${id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></td></tr>`;
        });
    }

    window.cancelBookingAdmin = (path, type, id) => {
        if(confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ?")) {
            remove(ref(db, path)).then(() => {
                if(type === 'event') runTransaction(ref(db, `events/${id}/currentBooked`), (c) => (c || 1) - 1);
                alert("‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); document.getElementById('booking-list-modal').classList.remove('active');
            });
        }
    }

    // --- Feature: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (Admin) ---
    window.showUserManagement = () => {
        if(userRole !== 'admin') return;
        showPage('page-users');
        onValue(ref(db, 'users'), (snap) => {
            const list = document.getElementById('user-list-admin');
            list.innerHTML = '';
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Add User (‡πÅ‡∏ö‡∏ö Mock) ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            // document.getElementById('admin-user-actions').innerHTML = `<button class="btn-primary" onclick="alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Role ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>`;

            snap.forEach(child => {
                const u = child.val();
                const uid = child.key;
                
                list.innerHTML += `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td>${u.phone}</td>
                        <td><span class="tag ${u.role==='admin'?'event':'movie'}">${u.role}</span></td>
                        <td>
                            <button class="btn-sm btn-edit" onclick="editUserAdmin('${uid}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="btn-sm btn-del" onclick="deleteUserAdmin('${uid}')">‡∏•‡∏ö</button>
                        </td>
                    </tr>`;
            });
        });
    }

    window.editUserAdmin = (uid) => {
        onValue(ref(db, 'users/' + uid), (snap) => {
            const u = snap.val();
            document.getElementById('edit-u-uid').value = uid;
            document.getElementById('edit-u-name').value = u.name;
            document.getElementById('edit-u-phone').value = u.phone;
            document.getElementById('edit-u-role').value = u.role || 'user';
            document.getElementById('user-edit-modal').classList.add('active');
        }, { onlyOnce: true });
    }

    window.saveUserAdmin = () => {
        const uid = document.getElementById('edit-u-uid').value;
        const updates = {
            name: document.getElementById('edit-u-name').value,
            phone: document.getElementById('edit-u-phone').value,
            role: document.getElementById('edit-u-role').value
        };
        update(ref(db, 'users/' + uid), updates).then(() => {
            document.getElementById('user-edit-modal').classList.remove('active');
            alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        });
    }

    window.deleteUserAdmin = (uid) => {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ? (‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)")) {
            remove(ref(db, 'users/' + uid));
        }
    }

    // --- Admin CRUD (Movies/Events) ---
    window.openAdminModal = (type) => {
        if(userRole !== 'admin') return;
        document.getElementById('admin-modal').classList.add('active');
        document.getElementById('adm-id').value = '';
        document.getElementById('adm-type').value = type;
        document.getElementById('adm-title-text').innerText = `‡πÄ‡∏û‡∏¥‡πà‡∏° ${type}`;
        document.querySelectorAll('#admin-modal input:not([type=hidden])').forEach(i => i.value = '');
        
        if(type === 'movie') {
            document.getElementById('adm-movie-fields').classList.remove('hidden');
            document.getElementById('adm-event-fields').classList.add('hidden');
        } else {
            document.getElementById('adm-movie-fields').classList.add('hidden');
            document.getElementById('adm-event-fields').classList.remove('hidden');
        }
    }
    window.closeAdminModal = () => document.getElementById('admin-modal').classList.remove('active');
    
    window.editItem = (id, type) => {
        if(userRole !== 'admin') return;
        window.openAdminModal(type);
        document.getElementById('adm-title-text').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        document.getElementById('adm-id').value = id;
        const data = (type==='movie' ? allData.movies[id].config : allData.events[id].config);
        document.getElementById('adm-title').value = data.title;
        document.getElementById('adm-start').value = data.start;
        document.getElementById('adm-end').value = data.end;
        if(type==='movie') {
            document.getElementById('adm-rows').value = data.rows;
            document.getElementById('adm-cols').value = data.cols;
            document.getElementById('adm-blocked').value = data.blocked || '';
        } else {
            document.getElementById('adm-cap').value = data.capacity;
        }
    }
    
    window.deleteItem = (id, type) => {
        if(userRole !== 'admin') return;
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) remove(ref(db, `${type==='movie'?'movies':'events'}/${id}`));
    }

    window.saveAdminItem = (e) => {
        e.preventDefault();
        if(userRole !== 'admin') return;
        const id = document.getElementById('adm-id').value;
        const type = document.getElementById('adm-type').value;
        const isNew = (id === '');
        const payload = {
            title: document.getElementById('adm-title').value,
            start: document.getElementById('adm-start').value,
            end: document.getElementById('adm-end').value
        };
        if(type === 'movie') {
            payload.rows = parseInt(document.getElementById('adm-rows').value);
            payload.cols = parseInt(document.getElementById('adm-cols').value);
            payload.blocked = document.getElementById('adm-blocked').value;
        } else {
            payload.capacity = parseInt(document.getElementById('adm-cap').value);
        }
        const targetRef = isNew ? push(ref(db, type === 'movie' ? 'movies' : 'events')) : ref(db, `${type === 'movie' ? 'movies' : 'events'}/${id}`);
        const updateData = isNew ? { config: payload } : { config: payload };
        if(isNew && type === 'event') updateData.currentBooked = 0;
        (isNew ? set(targetRef, updateData) : update(targetRef, { config: payload })).then(() => closeAdminModal());
    }

    // --- Booking Logic ---
    window.openMoviePage = (id) => {
        currentType = 'movie'; currentId = id; showPage('page-movie');
        // ‡πÉ‡∏ä‡πâ onValue ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Config ‡πÅ‡∏ö‡∏ö Realtime
        onValue(ref(db, `movies/${id}/config`), (snap) => {
            currentConfig = snap.val();
            if(currentConfig) {
                document.getElementById('m-title').innerText = currentConfig.title;
                renderSeatsBase(currentConfig);
            }
        });
        // ‡πÉ‡∏ä‡πâ onValue ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        onValue(ref(db, `movies/${id}`), (snap) => {
            const data = snap.val() || {};
            updateSeatStatus(data.bookings || {}, data.temp_selections || {});
        });
    }

    function renderSeatsBase(conf) {
        const map = document.getElementById('seat-map');
        map.innerHTML = '';
        map.style.gridTemplateColumns = `repeat(${conf.cols}, 1fr)`;
        for(let r=0; r<conf.rows; r++) {
            const rowLabel = String.fromCharCode(65 + r);
            for(let c=1; c<=conf.cols; c++) {
                const seatId = `${rowLabel}${c}`;
                const seat = document.createElement('div');
                seat.className = 'seat available';
                seat.id = `seat-${seatId}`;
                seat.innerText = seatId;
                if(conf.blocked && conf.blocked.includes(seatId)) {
                    seat.classList.add('blocked'); seat.classList.remove('available');
                } else {
                    seat.onclick = () => selectSeat(seatId);
                }
                map.appendChild(seat);
            }
        }
    }

    function updateSeatStatus(bookings, temps) {
        document.querySelectorAll('.seat').forEach(s => {
            const sid = s.id.replace('seat-', '');
            if(s.classList.contains('blocked')) return;
            s.className = 'seat available'; s.onclick = () => selectSeat(sid);
            if(bookings[sid]) {
                s.className = 'seat booked'; s.onclick = null;
            } else if(temps[sid]) {
                if (Date.now() - temps[sid].timestamp < 5 * 60 * 1000) {
                    s.className = 'seat selecting'; s.onclick = null;
                }
            }
        });
    }

    window.selectSeat = (seatId) => {
        if(!checkTime(currentConfig.start, currentConfig.end)) return;
        const tempRef = ref(db, `movies/${currentId}/temp_selections/${seatId}`);
        
        // ‡πÉ‡∏ä‡πâ currentUser.uid ‡∏´‡∏£‡∏∑‡∏≠ guestId ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        const userIdToUse = currentUser ? currentUser.uid : guestId;

        runTransaction(tempRef, (curr) => {
            if (curr === null || Date.now() - curr.timestamp > 5 * 60 * 1000) {
                return { timestamp: Date.now(), user_uid: userIdToUse };
            }
            return;
        }).then((res) => {
            if (res.committed) {
                selectedTarget = seatId;
                tempSeatRef = tempRef;
                onDisconnect(tempRef).remove();
                openBookingModal(`‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: ${seatId}`);
            } else alert("‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
        });
    }

    window.openEventPage = (id) => {
        currentType = 'event'; currentId = id; showPage('page-event');
        onValue(ref(db, `events/${id}`), (snap) => {
            const d = snap.val(); if(!d) return;
            currentConfig = d.config;
            const cap = d.config.capacity;
            const cur = d.currentBooked || 0;
            document.getElementById('e-title').innerText = currentConfig.title;
            document.getElementById('e-remaining').innerText = cap==-1 ? '‚àû' : (cap - cur);
            document.getElementById('e-capacity').innerText = cap==-1 ? '‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î' : cap;
            const btn = document.getElementById('btn-event-book');
            if(cap!=-1 && cur>=cap) { btn.disabled=true; btn.innerText="‡πÄ‡∏ï‡πá‡∏°"; btn.style.background="#ccc"; }
            else { 
                btn.disabled=false; btn.innerText="‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô"; btn.style.background="#1a73e8"; 
                btn.onclick=()=> {
                    if(!checkTime(currentConfig.start, currentConfig.end)) return;
                    openBookingModal("‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô");
                }
            }
        });
    }

    function openBookingModal(detail) {
        document.getElementById('modal-subtitle').innerText = detail;
        const modal = document.getElementById('booking-modal');
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ: Guest ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á ---
        const fName = document.getElementById('conf-name');
        const fPhone = document.getElementById('conf-phone');
        const fEmail = document.getElementById('conf-email');
        const fIdCard = document.getElementById('conf-idcard'); // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° input ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô HTML Modal

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Input ID Card ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô HTML (‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô HTML Modal ‡∏Å‡πá‡πÑ‡∏î‡πâ)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ <span id="conf-idcard-val"> ‡∏´‡∏£‡∏∑‡∏≠ <input>
        // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏ú‡∏°‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö HTML ‡∏Ç‡∏≠‡∏á Modal ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Input ‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤ Login ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞ Disabled

        // Helper: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô span ‡πÄ‡∏õ‡πá‡∏ô input (‡∏ñ‡πâ‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î HTML ‡πÄ‡∏Å‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô span)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ HTML ‡∏Ç‡∏≠‡∏á Modal ‡πÄ‡∏õ‡πá‡∏ô <input> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö (‡∏î‡∏π‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ HTML ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏µ‡πâ)

        if(currentUser) {
            // Login ‡πÅ‡∏•‡πâ‡∏ß: ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤ + ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ
            document.getElementById('inp-conf-name').value = userData.name || '';
            document.getElementById('inp-conf-phone').value = userData.phone || '';
            document.getElementById('inp-conf-email').value = userData.email || currentUser.email;
            document.getElementById('inp-conf-idcard').value = userData.idCard || '';
            
            // ‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ
            document.getElementById('inp-conf-name').readOnly = true;
            document.getElementById('inp-conf-phone').readOnly = true;
            document.getElementById('inp-conf-email').readOnly = true;
            document.getElementById('inp-conf-idcard').readOnly = true;
            
            // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Readonly
            ['name','phone','email','idcard'].forEach(k => {
                document.getElementById(`inp-conf-${k}`).style.backgroundColor = '#f0f0f0';
            });

        } else {
            // Guest: ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
            document.getElementById('inp-conf-name').value = '';
            document.getElementById('inp-conf-phone').value = '';
            document.getElementById('inp-conf-email').value = '';
            document.getElementById('inp-conf-idcard').value = '';
            
            // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
            document.getElementById('inp-conf-name').readOnly = false;
            document.getElementById('inp-conf-phone').readOnly = false;
            document.getElementById('inp-conf-email').readOnly = false;
            document.getElementById('inp-conf-idcard').readOnly = false;

            ['name','phone','email','idcard'].forEach(k => {
                document.getElementById(`inp-conf-${k}`).style.backgroundColor = '#fff';
            });
        }
        
        modal.classList.add('active');
    }

    window.cancelSelection = () => {
        document.getElementById('booking-modal').classList.remove('active');
        if(currentType === 'movie' && tempSeatRef) {
            remove(tempSeatRef);
            onDisconnect(tempSeatRef).cancel();
            tempSeatRef = null; selectedTarget = '';
        }
    }

    window.submitBooking = () => {
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Input (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞ Login ‡∏´‡∏£‡∏∑‡∏≠ Guest ‡∏Å‡πá‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Input ‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô Modal)
        const bName = document.getElementById('inp-conf-name').value.trim();
        const bPhone = document.getElementById('inp-conf-phone').value.trim();
        const bEmail = document.getElementById('inp-conf-email').value.trim();
        const bIdCard = document.getElementById('inp-conf-idcard').value.trim();

        if(!bName || !bPhone || !bEmail) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); return;
        }

        const bookingData = {
            // ‡∏ñ‡πâ‡∏≤ Login ‡πÉ‡∏ä‡πâ uid ‡∏à‡∏£‡∏¥‡∏á, ‡∏ñ‡πâ‡∏≤ Guest ‡πÉ‡∏ä‡πâ 'guest' (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö uid ‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞)
            uid: currentUser ? currentUser.uid : 'guest', 
            name: bName,
            phone: bPhone,
            email: bEmail,
            idCard: bIdCard,
            timestamp: Date.now()
        };

        if(currentType === 'movie') {
            set(ref(db, `movies/${currentId}/bookings/${selectedTarget}`), bookingData)
                .then(() => {
                    finalizeBooking();
                });
        } else {
            const eventRef = ref(db, `events/${currentId}`);
            runTransaction(eventRef, (data) => {
                if(data) {
                    if(data.config.capacity != -1 && (data.currentBooked||0) >= data.config.capacity) return;
                    data.currentBooked = (data.currentBooked || 0) + 1;
                }
                return data;
            }).then((res) => {
                if(res.committed) {
                    push(ref(db, `events/${currentId}/bookings`), bookingData);
                    finalizeBooking();
                } else { alert("‚ùå ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß"); }
            });
        }
    }

    function saveHistory(title, detail) {
        push(ref(db, `users/${currentUser.uid}/history`), { itemTitle: title, detail: detail, timestamp: Date.now() });
    }

    window.updateUserProfile = (e) => {
        e.preventDefault();
        update(ref(db, `users/${currentUser.uid}`), {
            name: document.getElementById('p-name').value,
            phone: document.getElementById('p-phone').value
        }).then(() => alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
    }

    window.showProfile = () => {
        if(!currentUser) return; // Guest ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πà‡∏≠‡∏ô)
        
        showPage('page-profile');
        document.getElementById('p-name').value = userData.name || '';
        document.getElementById('p-phone').value = userData.phone || '';
        document.getElementById('p-idcard').value = userData.idCard || '';

        const hList = document.getElementById('history-list');
        hList.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</td></tr>';
        
        // Global Search Logic:
        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ Movies ‡πÅ‡∏•‡∏∞ Events ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (allData)
        // ‡∏´‡∏≤ Booking ‡∏ó‡∏µ‡πà email ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö currentUser.email
        
        const myHistory = [];
        const myEmail = currentUser.email; // ‡πÉ‡∏ä‡πâ Email ‡πÄ‡∏õ‡πá‡∏ô Key ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

        // 1. ‡∏´‡∏≤‡πÉ‡∏ô Movies
        if(allData.movies) {
            Object.values(allData.movies).forEach(m => {
                if(m.bookings) {
                    Object.entries(m.bookings).forEach(([seatId, b]) => {
                        if(b.email === myEmail) {
                            myHistory.push({
                                timestamp: b.timestamp,
                                itemTitle: m.config.title,
                                detail: `‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ${seatId}`
                            });
                        }
                    });
                }
            });
        }

        // 2. ‡∏´‡∏≤‡πÉ‡∏ô Events
        if(allData.events) {
            Object.values(allData.events).forEach(e => {
                if(e.bookings) {
                    Object.values(e.bookings).forEach(b => {
                        if(b.email === myEmail) {
                            myHistory.push({
                                timestamp: b.timestamp,
                                itemTitle: e.config.title,
                                detail: "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô"
                            });
                        }
                    });
                }
            });
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        myHistory.sort((a,b) => b.timestamp - a.timestamp);

        // Render
        hList.innerHTML = '';
        if(myHistory.length === 0) {
            hList.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ</td></tr>';
        } else {
            myHistory.forEach(h => {
                hList.innerHTML += `<tr>
                    <td>${new Date(h.timestamp).toLocaleDateString()} ${new Date(h.timestamp).toLocaleTimeString()}</td>
                    <td>${h.itemTitle}</td>
                    <td>${h.detail}</td>
                </tr>`;
            });
        }
    }

    function checkTime(s, e) {
        const n = new Date();
        if(n < new Date(s)) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á"); return false; }
        if(n > new Date(e)) { alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß"); return false; }
        return true;
    }

    function finalizeBooking() {
        if(tempSeatRef) remove(tempSeatRef);
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á saveHistory ‡∏•‡∏á users/... ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Guest ‡πÑ‡∏°‡πà‡∏°‡∏µ User Node
        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ Global Search ‡πÅ‡∏ó‡∏ô‡∏ï‡∏≠‡∏ô‡∏î‡∏π Profile
        cancelSelection(); 
        alert("‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏à‡∏≥‡∏•‡∏≠‡∏á)");
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Guest ‡∏≠‡∏≤‡∏à‡∏à‡∏∞ redirect ‡∏Å‡∏•‡∏±‡∏ö Home
        if(!currentUser) goHome(); 
    }
</script>

</body>
</html>
