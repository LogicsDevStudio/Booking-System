<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 900px; margin: 30px auto; padding: 20px; }
        
        /* Header */
        header { text-align: center; margin-bottom: 30px; }
        h1 { color: #1a73e8; margin: 0; }
        p.subtitle { color: #666; font-size: 0.9rem; }

        /* Card Grid (Home Page) */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .card h3 { margin-top: 0; color: #333; }
        .card .tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; }
        .tag.movie { background: #e8f0fe; color: #1a73e8; }
        .tag.event { background: #fce8e6; color: #d93025; }

        /* Navigation */
        .nav-back { display: none; margin-bottom: 20px; cursor: pointer; color: #555; font-weight: bold; }
        .nav-back:hover { color: #000; }

        /* Movie Seat Map */
        .screen { background: #444; color: white; text-align: center; padding: 5px; margin: 20px 0; border-radius: 5px; letter-spacing: 2px; box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
        .seat-map { display: grid; justify-content: center; gap: 10px; margin: 20px 0; overflow-x: auto; padding-bottom: 10px; }
        .seat { 
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white;
            transition: all 0.2s;
        }
        .seat.available { background-color: #ffffff; border: 2px solid #28a745; color: #28a745; }
        .seat.available:hover { background-color: #28a745; color: white; }
        .seat.booked { background-color: #dc3545; border: 2px solid #dc3545; cursor: not-allowed; opacity: 0.6; }
        .seat.blocked { background-color: #e2e6ea; border: 2px solid #ced4da; color: #adb5bd; cursor: not-allowed; }

        /* Event Detail */
        .event-detail { background: white; padding: 30px; border-radius: 12px; text-align: center; }
        .stat-box { display: flex; justify-content: center; gap: 40px; margin: 20px 0; }
        .stat-item h2 { margin: 0; color: #1a73e8; }
        
        /* Modal (Booking Form) */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        
        /* Form Elements */
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: 'Sarabun'; }
        .btn-confirm { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-confirm:hover { background: #218838; }
        .btn-cancel { background: #dc3545; margin-top: 10px; }

        .loading { text-align: center; padding: 50px; color: #666; }
        
        /* Pages Visibility */
        #page-home, #page-movie, #page-event { display: none; }
        .active-page { display: block !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üéüÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
        <p class="subtitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏ô‡πÉ‡∏à</p>
    </header>

    <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>

    <div id="page-home" class="active-page">
        <div id="loading-spinner" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div id="movie-list" class="grid-container" style="margin-bottom: 30px;"></div>
        <div id="event-list" class="grid-container"></div>
    </div>

    <div id="page-movie">
        <div class="event-detail">
            <h2 id="m-title">Title</h2>
            <p>‡∏£‡∏≠‡∏ö: <span id="m-time"></span></p>
            <div class="screen">‡∏à‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</div>
            <div id="seat-map" class="seat-map"></div>
            <div style="margin-top:20px; font-size: 0.9rem; color: #666;">
                <span style="color:#28a745">‚¨ú ‡∏ß‡πà‡∏≤‡∏á</span> &nbsp; 
                <span style="color:#dc3545">üü• ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span> &nbsp; 
                <span style="color:#adb5bd">‚¨ú ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á</span>
            </div>
        </div>
    </div>

    <div id="page-event">
        <div class="event-detail">
            <h2 id="e-title">Event Title</h2>
            <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="e-time"></span></p>
            <div class="stat-box">
                <div class="stat-item">
                    <h2 id="e-remaining">-</h2>
                    <span>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                </div>
                <div class="stat-item">
                    <h2 id="e-capacity">-</h2>
                    <span>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                </div>
            </div>
            <button id="btn-event-book" class="btn-confirm" style="max-width: 200px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
        </div>
    </div>
</div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modal-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
        <p id="modal-subtitle" style="color:#666; margin-bottom: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: -</p>
        
        <form id="booking-form" onsubmit="submitBooking(event)">
            <div class="form-group">
                <label>‡∏ä‡∏∑‡πà‡∏≠ (First Name)</label>
                <input type="text" id="fname" required>
            </div>
            <div class="form-group">
                <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Last Name)</label>
                <input type="text" id="lname" required>
            </div>
            <div class="form-group">
                <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (Phone)</label>
                <input type="tel" id="phone" required>
            </div>
            <div class="form-group">
                <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (ID Card)</label>
                <input type="text" id="idcard" maxlength="13" required>
            </div>
            
            <button type="submit" class="btn-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase (‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
    const firebaseConfig = {
        databaseURL: "https://booking-system-c1ebd-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global State
    let currentType = ''; // 'movie' or 'event'
    let currentId = '';
    let selectedTarget = ''; // seatId (for movie) or eventId
    let currentConfig = null;

    // --- 1. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå (‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å) ---
    const homeRef = ref(db, '/');
    onValue(homeRef, (snapshot) => {
        const data = snapshot.val();
        document.getElementById('loading-spinner').style.display = 'none';
        
        const movieList = document.getElementById('movie-list');
        const eventList = document.getElementById('event-list');
        movieList.innerHTML = '';
        eventList.innerHTML = '';

        if(data && data.movies) {
            Object.keys(data.movies).forEach(key => {
                const m = data.movies[key].config;
                if(!m) return;
                const card = createCard(key, m, 'movie');
                movieList.appendChild(card);
            });
        }

        if(data && data.events) {
            Object.keys(data.events).forEach(key => {
                const e = data.events[key].config;
                if(!e) return;
                const card = createCard(key, e, 'event');
                eventList.appendChild(card);
            });
        }
    });

    function createCard(id, data, type) {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <div>
                <span class="tag ${type}">${type === 'movie' ? '‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå' : '‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå'}</span>
                <h3>${data.title}</h3>
                <p style="color:#777; font-size:0.85rem;">üìÖ ${data.start}</p>
            </div>
            <div style="text-align:right; margin-top:10px; color:#1a73e8; font-weight:bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ></div>
        `;
        div.onclick = () => {
            if(type === 'movie') openMoviePage(id);
            else openEventPage(id);
        }
        return div;
    }

    // --- 2. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏á ---
    window.openMoviePage = (id) => {
        currentType = 'movie';
        currentId = id;
        switchPage('page-movie');

        // Load Config
        onValue(ref(db, `movies/${id}/config`), (snap) => {
            const conf = snap.val();
            currentConfig = conf;
            document.getElementById('m-title').innerText = conf.title;
            document.getElementById('m-time').innerText = `${conf.start} - ${conf.end}`;
            renderSeats(conf);
        });

        // Load Bookings (Realtime)
        onValue(ref(db, `movies/${id}/bookings`), (snap) => {
            updateSeatStatus(snap.val() || {});
        });
    }

    function renderSeats(conf) {
        const map = document.getElementById('seat-map');
        map.innerHTML = '';
        map.style.gridTemplateColumns = `repeat(${conf.cols}, 1fr)`;
        const blocked = conf.blocked || [];

        for(let r=0; r<conf.rows; r++) {
            const rowLabel = String.fromCharCode(65 + r);
            for(let c=1; c<=conf.cols; c++) {
                const seatId = `${rowLabel}${c}`;
                const seat = document.createElement('div');
                seat.className = 'seat available';
                seat.id = `seat-${seatId}`;
                seat.innerText = seatId;

                if(blocked.includes(seatId)) {
                    seat.classList.add('blocked');
                    seat.classList.remove('available');
                } else {
                    seat.onclick = () => {
                        if(!seat.classList.contains('booked') && !seat.classList.contains('blocked')) {
                            openBookingForm(seatId);
                        }
                    };
                }
                map.appendChild(seat);
            }
        }
    }

    function updateSeatStatus(bookings) {
        document.querySelectorAll('.seat').forEach(s => {
            const sid = s.id.replace('seat-', '');
            if(!s.classList.contains('blocked')) {
                if(bookings[sid]) {
                    s.className = 'seat booked';
                    s.onclick = null; // Disable click
                } else {
                    s.className = 'seat available';
                }
            }
        });
    }

    // --- 3. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå ---
    window.openEventPage = (id) => {
        currentType = 'event';
        currentId = id;
        switchPage('page-event');

        onValue(ref(db, `events/${id}`), (snap) => {
            const data = snap.val();
            if(!data) return;
            currentConfig = data.config;
            const booked = data.currentBooked || 0;
            const cap = data.config.capacity;

            document.getElementById('e-title').innerText = currentConfig.title;
            document.getElementById('e-time').innerText = currentConfig.start;
            document.getElementById('e-capacity').innerText = cap == -1 ? "‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î" : cap;
            document.getElementById('e-remaining').innerText = cap == -1 ? "‚àû" : (cap - booked);

            const btn = document.getElementById('btn-event-book');
            if(cap != -1 && booked >= cap) {
                btn.disabled = true;
                btn.innerText = "‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß";
                btn.style.background = "#ccc";
            } else {
                btn.disabled = false;
                btn.innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°";
                btn.style.background = "#28a745";
                btn.onclick = () => openBookingForm('ticket');
            }
        });
    }

    // --- 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    window.openBookingForm = (target) => {
        if(!checkTime(currentConfig.start, currentConfig.end)) return;

        selectedTarget = target;
        const modal = document.getElementById('booking-modal');
        const title = document.getElementById('modal-subtitle');
        
        if(currentType === 'movie') {
            title.innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: ${target}`;
        } else {
            title.innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå: ${currentConfig.title}`;
        }
        
        modal.classList.add('active');
    }

    window.closeModal = () => {
        document.getElementById('booking-modal').classList.remove('active');
        document.getElementById('booking-form').reset();
    }

    window.submitBooking = (e) => {
        e.preventDefault();
        
        const userData = {
            firstName: document.getElementById('fname').value,
            lastName: document.getElementById('lname').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            idCard: document.getElementById('idcard').value,
            timestamp: Date.now()
        };

        if(currentType === 'movie') {
            bookMovieSeat(selectedTarget, userData);
        } else {
            bookEventTicket(userData);
        }
    };

    function bookMovieSeat(seatId, userData) {
        const seatRef = ref(db, `movies/${currentId}/bookings/${seatId}`);
        runTransaction(seatRef, (currentData) => {
            if (currentData === null) {
                return userData; // Save User Data
            } else {
                return; // Abort
            }
        }).then((result) => {
            closeModal();
            if (result.committed) alert("‚úÖ ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            else alert("‚ùå ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
        });
    }

    function bookEventTicket(userData) {
        const eventRef = ref(db, `events/${currentId}`);
        
        runTransaction(eventRef, (eventData) => {
            if (eventData) {
                const max = eventData.config.capacity;
                const current = eventData.currentBooked || 0;
                if (max !== -1 && current >= max) return; // Full
                
                eventData.currentBooked = current + 1;
                return eventData;
            }
            return eventData;
        }).then((result) => {
            if (result.committed) {
                // Save Detail to sub-collection
                const bookingListRef = ref(db, `events/${currentId}/bookings`);
                push(bookingListRef, userData);
                
                closeModal();
                alert("‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } else {
                closeModal();
                alert("‚ùå ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            }
        });
    }

    // --- Helpers ---
    window.switchPage = (pageId) => {
        document.querySelectorAll('.active-page').forEach(el => el.classList.remove('active-page'));
        document.getElementById(pageId).classList.add('active-page');
        
        const backBtn = document.querySelector('.nav-back');
        if(pageId === 'page-home') backBtn.style.display = 'none';
        else backBtn.style.display = 'block';
    }

    window.goHome = () => {
        currentType = '';
        currentId = '';
        switchPage('page-home');
    }

    function checkTime(start, end) {
        const now = new Date();
        if (now < new Date(start)) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á"); return false; }
        if (now > new Date(end)) { alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß"); return false; }
        return true;
    }
</script>

</body>
</html>
