<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß Realtime (‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        /* Navbar */
        .navbar { background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; overflow-x: auto; }
        .brand { font-size: 1.2rem; font-weight: bold; color: #1a73e8; cursor: pointer; white-space: nowrap; margin-right: 20px; }
        .nav-menu { display: flex; gap: 15px; align-items: center; white-space: nowrap; }
        .nav-item { cursor: pointer; color: #555; font-size: 0.95rem; }
        .nav-item:hover { color: #1a73e8; }
        .btn-logout { color: #d93025; cursor: pointer; font-weight: bold; border: 1px solid #d93025; padding: 5px 10px; border-radius: 4px; }

        /* Auth Page */
        .auth-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: 'Sarabun'; }
        .link-text { color: #1a73e8; cursor: pointer; font-size: 0.9rem; margin-top: 15px; display: block; }
        .admin-code-area { background: #f9f9f9; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.8rem; color: #666; text-align: left; }

        /* General UI */
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #1a73e8; margin: 0; }
        .btn-primary { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-secondary { padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s;}
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; height: 250px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; background: #eee;}
        .tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; font-weight: bold;}
        .tag.movie { background: #e8f0fe; color: #1a73e8; }
        .tag.event { background: #fce8e6; color: #d93025; }

        /* Detail Header Section */
        .item-details { display: flex; gap: 20px; background: #fff; padding: 20px; border-radius: 12px; margin-top: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .item-details img { width: 220px; height: 320px; object-fit: cover; border-radius: 8px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1);}
        .item-info { flex: 1; min-width: 250px; }
        .item-info p { margin: 8px 0; }

        /* Admin Controls */
        .admin-actions { display: flex; gap: 5px; margin-top: auto; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: none; color: white; flex: 1; margin-right: 2px;}
        .btn-edit { background: #f39c12; } .btn-del { background: #e74c3c; } 
        .admin-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #e8f0fe; padding: 15px; border-radius: 8px; flex-wrap: wrap; gap: 10px;}

        /* Schedule List Styles */
        .schedule-item { background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .schedule-info { flex: 1; }
        .schedule-stats { font-size: 0.9em; color: #666; background: #f8f9fa; padding: 5px 10px; border-radius: 4px; margin-right: 10px; display:inline-block; margin-bottom:5px;}
        .stat-val { font-weight: bold; color: #333; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: 600; }

        /* Seat Styles */
        .screen { background: #444; color: white; text-align: center; padding: 5px; margin: 20px 0; border-radius: 5px; box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
        .seat-map { display: grid; justify-content: center; gap: 10px; margin: 20px 0; overflow-x: auto; padding-bottom: 10px; }
        .seat { 
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white;
            transition: all 0.2s; position: relative;
        }
        .seat.available { background-color: #fff; border: 2px solid #28a745; color: #28a745; }
        .seat.available:hover { background-color: #28a745; color: white; }
        .seat.booked { background-color: #dc3545; border: 2px solid #dc3545; cursor: not-allowed; opacity: 0.6; }
        .seat.selecting { background-color: #ffc107; border: 2px solid #ffc107; color: #333; cursor: not-allowed; animation: pulse 1.5s infinite; }
        .seat.blocked { background-color: #e2e6ea; border: 2px solid #ced4da; color: #adb5bd; cursor: not-allowed; }
        .seat.pending { background-color: #f39c12; border: 2px solid #e67e22; color: white; cursor: pointer; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Modal & Helpers */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .hidden { display: none !important; }
        .nav-back { margin-bottom: 20px; cursor: pointer; color: #555; font-weight: bold; }
        .legend { display: flex; gap: 15px; font-size: 0.9rem; justify-content: center; margin-top: 20px; flex-wrap: wrap;}
        .legend-item { display: flex; align-items: center; gap: 5px; } .dot { width: 15px; height: 15px; border-radius: 3px; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: 'Sarabun'; }
        .modal-buttons { margin-top: 20px; text-align: right; }

        /* Payment & Ticket UI */
        .payment-qr-container { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 15px; }
        .payment-qr-container img { width: 200px; height: 200px; object-fit: contain; margin: 10px 0; }
        .timer-text { font-size: 1.5rem; font-weight: bold; color: #e74c3c; margin: 5px 0; animation: pulse 1s infinite; }

        .ticket-card { background: #fff; border: 2px dashed #1a73e8; border-radius: 12px; padding: 20px; text-align: center; margin-top: 15px; position: relative; }
        .ticket-card::before, .ticket-card::after { content: ''; position: absolute; top: 50%; width: 20px; height: 20px; background: white; border-radius: 50%; transform: translateY(-50%); border: 2px solid #1a73e8; }
        .ticket-card::before { left: -12px; border-left: transparent; border-top: transparent; border-bottom: transparent; }
        .ticket-card::after { right: -12px; border-right: transparent; border-top: transparent; border-bottom: transparent; }
        .ticket-title { font-size: 1.3rem; font-weight: bold; color: #1a73e8; margin-bottom: 10px; }
        .ticket-info { text-align: left; background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 0.95rem; margin-top: 15px; }
        .ticket-info p { margin: 8px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .ticket-qr { margin-top: 15px; }
        .ticket-qr img { width: 150px; height: 150px; }
    </style>
</head>
<body>

<nav class="navbar hidden" id="main-nav">
    <div class="brand" onclick="goHome()">üéüÔ∏è TicketSystem</div>
    <div class="nav-menu">
        <span class="nav-item" onclick="goHome()">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        <span id="nav-profile" class="nav-item hidden" onclick="showProfile()">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
        <span id="nav-admin-orders" class="nav-item hidden" onclick="showOrderManagement()" style="color:#d93025;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
        <span id="nav-admin-users" class="nav-item hidden" onclick="showUserManagement()" style="color:#d93025;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
        <span id="nav-admin-tickets" class="nav-item hidden" onclick="showTicketTypesManagement()" style="color:#d93025;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</span>
        
        <span id="nav-login" class="nav-item" onclick="showPage('page-auth')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
        <span id="nav-logout" class="btn-logout hidden" onclick="doLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
    </div>
</nav>

<div class="container">

    <div id="page-auth" class="auth-container">
        <h2 id="auth-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <form id="auth-form" onsubmit="handleAuth(event)">
            <input type="email" id="auth-email" class="auth-input" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
            <input type="password" id="auth-pass" class="auth-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
            <div id="register-fields" class="hidden">
                <input type="text" id="reg-name" class="auth-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                <input type="tel" id="reg-phone" class="auth-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                <input type="text" id="reg-idcard" class="auth-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)" maxlength="13">
                <div class="admin-code-area">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
                    <input type="text" id="reg-admin-code" class="auth-input" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Admin" style="margin-top:5px;">
                    <small>* ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ "ADMIN999" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</small>
                </div>
            </div>
            <button type="submit" class="btn-primary" id="btn-auth-submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
        <span class="link-text" id="toggle-auth" onclick="toggleAuthMode()">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
    </div>

    <div id="page-home" class="hidden">
        <div id="admin-panel-home" class="admin-bar hidden">
            <span>üîß <b>Admin Dashboard</b></span>
            <div>
                <button class="btn-sm" style="background:#2ecc71; padding:8px 15px;" onclick="openAdminModal('movie')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á</button>
                <button class="btn-sm" style="background:#2ecc71; padding:8px 15px;" onclick="openAdminModal('event')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</button>
            </div>
        </div>
        <header><h1>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á</h1></header>
        <div id="movie-list" class="grid-container" style="margin-bottom: 30px;"></div>
        <div id="event-list" class="grid-container"></div>
    </div>

    <div id="page-profile" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
        <div class="card" style="margin-bottom:20px; cursor:default;">
            <form onsubmit="updateUserProfile(event)">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label> <input type="text" id="p-name" class="auth-input">
                <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</label> <input type="tel" id="p-phone" class="auth-input">
                <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</label> <input type="text" id="p-idcard" class="auth-input" readonly style="background:#eee; color:#777;">
                <button type="submit" class="btn-primary" style="width:auto; margin-top:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </form>
        </div>
        <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
        <table id="history-table">
            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody id="history-list"></tbody>
        </table>
    </div>

    <div id="page-orders" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2>üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</th>
                        <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
                        <th>‡∏™‡∏•‡∏¥‡∏õ</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody id="all-orders-list"></tbody>
            </table>
        </div>
    </div>

    <div id="page-users" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>ID Card</th><th>Role</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="user-list-admin"></tbody>
            </table>
        </div>
    </div>

    <div id="page-ticket-types" class="hidden">
        <div class="nav-back" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</div>
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <h2 style="margin:0;">üé´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</h2>
            <button class="btn-sm" style="background:#2ecc71; padding:10px 20px; font-size:1rem;" onclick="openTicketTypeModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</button>
        </div>
        <div style="overflow-x:auto; margin-top:20px;">
            <table>
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="ticket-types-list"></tbody>
            </table>
        </div>
    </div>

    <div id="page-movie" class="hidden">
        <button class="btn-secondary" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        
        <div class="item-details">
            <img id="m-group-img" alt="Poster" style="display:none;">
            <div class="item-info">
                <h2 id="m-group-title" style="margin-top:0; color:#1a73e8;">‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</h2>
                <p>üìç <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="m-group-location">-</span></p>
                <p>üéüÔ∏è <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£:</strong> <span id="m-group-ticket-type">-</span></p>
                <p>üí∞ <strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> <span id="m-group-price">-</span> ‡∏ö‡∏≤‡∏ó</p>
                <p id="m-group-detail" style="color:#555; white-space:pre-wrap; font-size:0.95rem; margin-top:10px;"></p>
                <div id="m-group-minimap" style="margin-top:15px; background:#f8f9fa; padding:10px; border-radius:8px;"></div>
            </div>
        </div>

        <div id="movie-schedule-section">
            <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏â‡∏≤‡∏¢</h3>
            <div class="schedule-list" id="movie-schedule-list"></div>
        </div>
        
        <div id="movie-seat-section" class="hidden">
            <div style="margin: 10px 0; display:flex; align-items:center; gap:15px;">
                <button class="btn-sm" onclick="backToSchedule()" style="background:#6c757d">‚¨Ö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏∑‡πà‡∏ô</button>
                <span style="font-weight:bold; font-size:1.1rem;">‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤: <span id="m-round-time" style="color:#1a73e8;"></span></span>
            </div>
            <div class="screen">‡∏à‡∏≠‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå</div>
            <div class="seat-map" id="seat-map"></div>
            <div class="legend">
                <div class="legend-item"><div class="dot" style="border:2px solid #28a745;"></div> ‡∏ß‡πà‡∏≤‡∏á</div>
                <div class="legend-item"><div class="dot" style="background:#f39c12;"></div> ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
                <div class="legend-item"><div class="dot" style="background:#dc3545;"></div> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
                <div class="legend-item"><div class="dot" style="background:#e2e6ea;"></div> ‡∏õ‡∏¥‡∏î</div>
            </div>
        </div>
    </div>

    <div id="page-event" class="hidden">
        <button class="btn-secondary" onclick="goHome()">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        
        <div class="item-details">
            <img id="e-group-img" alt="Poster" style="display:none;">
            <div class="item-info">
                <h2 id="e-group-title" style="margin-top:0; color:#d93025;">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</h2>
                <p>üìç <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="e-group-location">-</span></p>
                <p>üéüÔ∏è <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£:</strong> <span id="e-group-ticket-type">-</span></p>
                <p>üí∞ <strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> <span id="e-group-price">-</span> ‡∏ö‡∏≤‡∏ó</p>
                <p id="e-group-detail" style="color:#555; white-space:pre-wrap; font-size:0.95rem; margin-top:10px;"></p>
            </div>
        </div>

        <div id="event-schedule-section">
            <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
            <div class="schedule-list" id="event-schedule-list"></div>
        </div>

        <div id="event-booking-section" class="hidden">
             <div style="margin: 10px 0; display:flex; align-items:center; gap:15px;">
                <button class="btn-sm" onclick="backToSchedule()" style="background:#6c757d">‚¨Ö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏∑‡πà‡∏ô</button>
                <span style="font-weight:bold; font-size:1.1rem;">‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤: <span id="e-round-time" style="color:#d93025;"></span></span>
            </div>
            <div class="card" style="cursor:default; text-align:center;">
                <h3 style="margin-top:0;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                <p style="font-size:1.1rem;">‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="e-remaining" style="color:#d93025; font-weight:bold; font-size:1.3rem;"></span> / <span id="e-capacity"></span></p>
                <button id="btn-event-book" class="btn-primary" style="width:100%; max-width:300px; margin-top:15px;">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
            </div>
        </div>
    </div>

</div>

<div id="booking-modal" class="modal">
    <div class="modal-content">
        <div id="booking-form-section">
            <span class="close-btn" onclick="cancelSelection()">&times;</span>
            <h3>1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</h3>
            <p id="modal-subtitle" style="margin-bottom: 15px; font-weight: bold; color: #1a73e8; font-size:1.1rem;"></p>
            <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="inp-conf-name" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠"></div>
            <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" id="inp-conf-phone" placeholder="08x-xxx-xxxx"></div>
            <div class="form-group"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</label><input type="email" id="inp-conf-email" placeholder="email@example.com"></div>
            <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" id="inp-conf-idcard" placeholder="‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å"></div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="cancelSelection()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-primary" onclick="proceedToPayment()" style="width:auto; margin-left:10px;">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
        </div>

        <div id="payment-section" class="hidden">
            <h3 style="color: #1a73e8; text-align: center;">2. ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡πÅ‡∏Å‡∏ô QR Code)</h3>
            <div class="payment-qr-container">
                <p style="font-size: 1.2rem; margin:0;">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
                <p style="font-size: 2rem; color:#28a745; font-weight:bold; margin:5px 0;">‡∏ø<span id="pay-amount">0</span></p>
                <img id="pay-qrcode" alt="PromptPay QR">
                <p style="color:#e74c3c; font-weight:bold; margin-top:10px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</p>
                <div class="timer-text" id="pay-countdown">10:00</div>
            </div>

            <div class="form-group">
                <label>‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)</label>
                <input type="url" id="inp-slip-url" placeholder="https://...">
            </div>

            <div class="modal-buttons" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <button class="btn-secondary" onclick="cancelSelection()" style="background:#dc3545;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <div>
                    <button class="btn-secondary" onclick="payLater()" style="background:#f39c12; color:white; border:none; margin-right:5px;">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</button>
                    <button class="btn-primary" onclick="confirmPayment()" style="width:auto; margin:0;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏•‡∏¥‡∏õ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pay-later-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('pay-later-modal').classList.remove('active')">&times;</span>
        <h3 style="color: #f39c12; text-align: center;">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
        <div class="payment-qr-container">
            <p style="font-size: 1.2rem; margin:0;">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
            <p style="font-size: 2rem; color:#28a745; font-weight:bold; margin:5px 0;">‡∏ø<span id="pl-amount">0</span></p>
            <img id="pl-qrcode" alt="PromptPay QR">
            <p style="color:#e74c3c; font-weight:bold; margin-top:10px;">*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏ô‡∏≤‡∏ó‡∏µ*</p>
        </div>
        <div class="form-group">
            <label>‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)</label>
            <input type="url" id="pl-slip-url" placeholder="https://...">
        </div>
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="document.getElementById('pay-later-modal').classList.remove('active')">‡∏õ‡∏¥‡∏î</button>
            <button class="btn-primary" onclick="submitPayLater()" style="width:auto;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏•‡∏¥‡∏õ</button>
        </div>
    </div>
</div>

<div id="eticket-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('eticket-modal').classList.remove('active')">&times;</span>
        
        <div id="ticket-content" class="ticket-card">
            <div class="ticket-title">üéüÔ∏è E-TICKET</div>
            <h3 id="t-title" style="margin-bottom:5px;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</h3>
            
            <div class="ticket-qr">
                <img id="t-qrcode" alt="Ticket QR">
                <div style="font-size:0.8rem; color:#888; margin-top:5px;">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div>
            </div>

            <div class="ticket-info">
                <p>üë§ <strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="t-name"></span></p>
                <p>üìç <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="t-location"></span></p>
                <p>üìÖ <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤:</strong> <span id="t-datetime"></span></p>
                <p>üí∫ <strong>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡∏ö‡∏±‡∏ï‡∏£:</strong> <span id="t-seat"></span></p>
            </div>
        </div>

        <div class="modal-buttons" style="display:flex; justify-content:center; gap:15px; margin-top:20px;">
            <button class="btn-primary" onclick="downloadTicketPDF()" style="background:#8e44ad; width:100%;">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡πã‡∏ß PDF</button>
        </div>
    </div>
</div>

<div id="admin-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAdminModal()">&times;</span>
        <h3 id="adm-title-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <form onsubmit="saveAdminItem(event)">
            <input type="hidden" id="adm-id">
            <input type="hidden" id="adm-type">
            
            <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label><input type="text" id="adm-title" required></div>
            <div class="form-group"><label>URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÇ‡∏õ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå):</label><input type="text" id="adm-image" placeholder="https://..."></div>
            <div class="form-group"><label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</label><textarea id="adm-detail" rows="3" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå"></textarea></div>
            <div class="form-group"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà / ‡πÇ‡∏£‡∏á‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå:</label><input type="text" id="adm-location" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏±‡πâ‡∏ô 5 ‡πÇ‡∏ã‡∏ô A"></div>
            
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£:</label>
                    <select id="adm-ticket-type" class="auth-input" onchange="updatePriceFromType()" required>
                        <option value="">-- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1"><label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó):</label><input type="number" id="adm-price" placeholder="0" required></div>
            </div>

            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á:</label><input type="datetime-local" id="adm-start" required></div>
                <div class="form-group" style="flex:1"><label>‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á:</label><input type="datetime-local" id="adm-end" required></div>
            </div>

            <div id="adm-movie-fields" class="hidden" style="background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:15px;">
                <div style="display:flex; gap:10px;">
                    <div class="form-group" style="flex:1"><label>‡πÅ‡∏ñ‡∏ß:</label><input type="number" id="adm-rows"></div>
                    <div class="form-group" style="flex:1"><label>‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡πÅ‡∏ñ‡∏ß:</label><input type="number" id="adm-cols"></div>
                </div>
                <div class="form-group"><label>‡∏õ‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (Blocked ex: A1,A2):</label><input type="text" id="adm-blocked"></div>
            </div>

            <div id="adm-event-fields" class="hidden" style="background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:15px;">
                <div class="form-group"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ (-1=‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î):</label><input type="number" id="adm-cap"></div>
            </div>

            <button type="submit" class="btn-primary" style="background:#2ecc71;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>
    </div>
</div>

<div id="ticket-type-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('ticket-type-modal').classList.remove('active')">&times;</span>
        <h3 id="tt-modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</h3>
        <form onsubmit="saveTicketType(event)">
            <input type="hidden" id="tt-id">
            <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£ (‡πÄ‡∏ä‡πà‡∏ô VIP, Normal):</label><input type="text" id="tt-name" required></div>
            <div class="form-group"><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó):</label><input type="number" id="tt-price" required min="0"></div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="document.getElementById('ticket-type-modal').classList.remove('active')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="btn-primary" style="width:auto;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </form>
    </div>
</div>

<div id="user-edit-modal" class="modal">
    <div class="modal-content">
        <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
        <input type="hidden" id="edit-u-uid">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="edit-u-name"></div>
        <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" id="edit-u-phone"></div>
        <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input type="text" id="edit-u-idcard"></div>
        <div class="form-group">
            <label>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Role)</label>
            <select id="edit-u-role" style="width:100%; padding:10px; margin-top:5px; border-radius:6px; border:1px solid #ddd; font-family:'Sarabun';">
                <option value="user">User (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
                <option value="admin">Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</option>
            </select>
        </div>
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="document.getElementById('user-edit-modal').classList.remove('active')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn-primary" onclick="saveUserAdmin()" style="width:auto; margin-left:10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>
</div>

<div id="admin-user-history-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: <span id="admin-uh-name" style="color: #1a73e8;"></span></h3>
        <div style="overflow-x:auto; max-height: 400px; overflow-y:auto; margin-top: 15px;">
            <table>
                <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏™‡∏•‡∏¥‡∏õ</th></tr></thead>
                <tbody id="admin-user-history-list"></tbody>
            </table>
        </div>
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="document.getElementById('admin-user-history-modal').classList.remove('active')">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, push, set, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAJGlD_kNVgRHVAdmUUgZAerrjX8nJbMJE",
        authDomain: "booking-system-c1ebd.firebaseapp.com",
        databaseURL: "https://booking-system-c1ebd-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "booking-system-c1ebd",
        storageBucket: "booking-system-c1ebd.firebasestorage.app",
        messagingSenderId: "140390358651",
        appId: "1:140390358651:web:cf9dc2624697c4d93f0cde"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- Global State ---
    let currentUser = null;
    let userRole = 'guest';
    let userData = {};
    let isRegistering = false;
    let allData = {}; 
    let guestId = localStorage.getItem('guest_uid');
    if (!guestId) {
        guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('guest_uid', guestId);
    }

    let currentType = ''; 
    let currentId = ''; 
    let selectedTarget = '';
    let currentConfig = null;
    let tempSeatRef = null;
    let paymentTimerInterval = null; 
    let payLaterData = null; 

    const PROMPTPAY_NUMBER = "0812345678"; 

    // --- Auth & Init ---
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            onValue(ref(db, 'users/' + user.uid), (snap) => {
                userData = snap.val() || {};
                userRole = userData.role || 'user';
                updateNavbarUI(true);
                if(!document.getElementById('page-auth').classList.contains('hidden')) window.goHome();
                if(!document.getElementById('page-users').classList.contains('hidden')) window.showUserManagement();
                if(!document.getElementById('page-ticket-types').classList.contains('hidden')) window.showTicketTypesManagement();
                if(!document.getElementById('page-orders').classList.contains('hidden')) window.showOrderManagement();
            });
        } else {
            userRole = 'guest'; userData = {}; updateNavbarUI(false);
            if(!document.getElementById('page-auth').classList.contains('hidden')) {} else { window.goHome(); }
        }
    });

    onValue(ref(db, '/'), (snapshot) => {
        allData = snapshot.val() || {};
        window.renderHomeList();
        
        if(!document.getElementById('page-movie').classList.contains('hidden') && currentType === 'movie') {
           const titleEl = document.getElementById('m-group-title');
           if(titleEl && document.getElementById('movie-seat-section').classList.contains('hidden')) {
               window.openGroupPage(titleEl.innerText, 'movie', false);
           }
        }
        if(!document.getElementById('page-event').classList.contains('hidden') && currentType === 'event') {
            const titleEl = document.getElementById('e-group-title');
            if(titleEl && document.getElementById('event-booking-section').classList.contains('hidden')) {
                window.openGroupPage(titleEl.innerText, 'event', false);
            }
        }
        if(!document.getElementById('page-profile').classList.contains('hidden')) window.showProfile();
        if(!document.getElementById('page-ticket-types').classList.contains('hidden')) window.showTicketTypesManagement();
        if(!document.getElementById('page-orders').classList.contains('hidden')) window.showOrderManagement();
    });

    setInterval(() => {
        const now = Date.now();
        const expireTime = 10 * 60 * 1000; 

        if(allData.movies) {
            Object.entries(allData.movies).forEach(([mId, m]) => {
                if(m.bookings) {
                    Object.entries(m.bookings).forEach(([seatId, b]) => {
                        if(b.paymentStatus === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' && (now - b.timestamp > expireTime)) {
                            remove(ref(db, `movies/${mId}/bookings/${seatId}`));
                        }
                    });
                }
                if(m.temp_selections) {
                    Object.entries(m.temp_selections).forEach(([seatId, t]) => {
                        if(now - t.timestamp > expireTime) {
                            remove(ref(db, `movies/${mId}/temp_selections/${seatId}`));
                        }
                    });
                }
            });
        }
        if(allData.events) {
            Object.entries(allData.events).forEach(([eId, e]) => {
                if(e.bookings) {
                    Object.entries(e.bookings).forEach(([bId, b]) => {
                        if(b.paymentStatus === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' && (now - b.timestamp > expireTime)) {
                            remove(ref(db, `events/${eId}/bookings/${bId}`)).then(() => {
                                runTransaction(ref(db, `events/${eId}/currentBooked`), (c) => (c || 1) - 1);
                            });
                        }
                    });
                }
            });
        }
        if(!document.getElementById('page-profile').classList.contains('hidden')) window.showProfile();
        if(!document.getElementById('page-orders').classList.contains('hidden')) window.showOrderManagement();
    }, 15000);

    function updateNavbarUI(isLoggedIn) {
        document.getElementById('main-nav').classList.remove('hidden');
        if(userRole === 'admin') {
            document.getElementById('nav-admin-orders').classList.remove('hidden');
            document.getElementById('nav-admin-users').classList.remove('hidden');
            document.getElementById('nav-admin-tickets').classList.remove('hidden');
        } else {
            document.getElementById('nav-admin-orders').classList.add('hidden');
            document.getElementById('nav-admin-users').classList.add('hidden');
            document.getElementById('nav-admin-tickets').classList.add('hidden');
        }

        if(isLoggedIn) {
            document.getElementById('nav-profile').classList.remove('hidden');
            document.getElementById('nav-logout').classList.remove('hidden');
            document.getElementById('nav-login').classList.add('hidden');
        } else {
            document.getElementById('nav-profile').classList.add('hidden');
            document.getElementById('nav-logout').classList.add('hidden');
            document.getElementById('nav-login').classList.remove('hidden');
        }
    }

    // --- Views ---
    window.showPage = (pid) => {
        ['page-auth', 'page-home', 'page-movie', 'page-event', 'page-profile', 'page-users', 'page-ticket-types', 'page-orders'].forEach(id => {
            const el = document.getElementById(id); if(el) el.classList.add('hidden');
        });
        const target = document.getElementById(pid); if(target) target.classList.remove('hidden');
    }

    window.goHome = () => {
        if(currentType === 'movie' && tempSeatRef) cancelSelection();
        window.showPage('page-home');
        window.renderHomeList();
    }

    // --- Home List ---
    window.renderHomeList = () => {
        const mList = document.getElementById('movie-list');
        const eList = document.getElementById('event-list');
        mList.innerHTML = ''; eList.innerHTML = '';

        const adminPanel = document.getElementById('admin-panel-home');
        if(adminPanel) {
            if(userRole === 'admin') adminPanel.classList.remove('hidden');
            else adminPanel.classList.add('hidden');
        }

        const moviesGrouped = {};
        if(allData.movies) {
            Object.entries(allData.movies).forEach(([id, m]) => {
                if(m.config && m.config.title) {
                    const title = m.config.title;
                    if(!moviesGrouped[title]) moviesGrouped[title] = [];
                    moviesGrouped[title].push({id, ...m});
                }
            });
        }

        const eventsGrouped = {};
        if(allData.events) {
            Object.entries(allData.events).forEach(([id, e]) => {
                if(e.config && e.config.title) {
                    const title = e.config.title;
                    if(!eventsGrouped[title]) eventsGrouped[title] = [];
                    eventsGrouped[title].push({id, ...e});
                }
            });
        }

        Object.keys(moviesGrouped).forEach(title => {
            const rounds = moviesGrouped[title]; 
            const rep = rounds[0];
            mList.appendChild(createCard(title, rep.config, 'movie', rounds.length));
        });

        Object.keys(eventsGrouped).forEach(title => {
            const rounds = eventsGrouped[title];
            const rep = rounds[0];
            eList.appendChild(createCard(title, rep.config, 'event', rounds.length));
        });
    }

    function createCard(title, config, type, count) {
        const div = document.createElement('div');
        div.className = 'card';
        const imgUrl = config.image || 'https://via.placeholder.com/300x400?text=No+Image';
        div.innerHTML = `
            <img src="${imgUrl}" alt="${title}">
            <span class="tag ${type}">${type==='movie'?'‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå':'‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå'}</span>
            <h3 style="margin:5px 0;">${title}</h3>
            <p style="font-size:0.9rem; color:#555; margin:5px 0;">üìç ${config.location || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'}</p>
            <p style="font-size:1rem; color:#d93025; font-weight:bold; margin:5px 0;">‡∏ø${config.price || 0}</p>
            <p style="margin-top:auto; padding-top:10px; font-size:0.9rem; color:#666;">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>${count}</strong> ‡∏£‡∏≠‡∏ö</p>
        `;
        div.onclick = () => window.openGroupPage(title, type, true);
        return div;
    }

    // --- Group Details & Schedule List ---
    window.openGroupPage = (title, type, switchPage = true) => {
        currentType = type;
        if(switchPage) window.showPage(type === 'movie' ? 'page-movie' : 'page-event');

        const now = Date.now();

        if(type === 'movie') {
            document.getElementById('movie-schedule-section').classList.remove('hidden');
            document.getElementById('movie-seat-section').classList.add('hidden');
            
            const list = document.getElementById('movie-schedule-list');
            list.innerHTML = '';
            
            const items = [];
            if(allData.movies) {
                Object.entries(allData.movies).forEach(([id, m]) => {
                    if(m.config.title === title) items.push({id, ...m});
                });
            }
            items.sort((a,b) => new Date(a.config.start) - new Date(b.config.start));

            if(items.length > 0) {
                const rep = items[0].config;
                document.getElementById('m-group-title').innerText = rep.title;
                const imgEl = document.getElementById('m-group-img');
                if(rep.image) { imgEl.src = rep.image; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; }
                document.getElementById('m-group-location').innerText = rep.location || '-';
                document.getElementById('m-group-ticket-type').innerText = rep.ticketType || '-';
                document.getElementById('m-group-price').innerText = rep.price || '0';
                document.getElementById('m-group-detail').innerText = rep.detail || '';

                const minimap = document.getElementById('m-group-minimap');
                minimap.innerHTML = '<strong style="font-size:0.9rem; color:#333;">‡∏ú‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å):</strong><br>';
                const grid = document.createElement('div');
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = `repeat(${rep.cols}, 12px)`;
                grid.style.gap = '2px';
                grid.style.marginTop = '8px';
                
                let blocked = [];
                if (rep.blocked) {
                    blocked = Array.isArray(rep.blocked) ? rep.blocked : String(rep.blocked).split(',').map(s => s.trim());
                }

                for(let r=0; r<rep.rows; r++) {
                    const rowL = String.fromCharCode(65+r);
                    for(let c=1; c<=rep.cols; c++) {
                        const sid = `${rowL}${c}`;
                        const s = document.createElement('div');
                        s.style.width = '12px'; s.style.height = '12px'; s.style.borderRadius = '2px';
                        if(blocked.includes(sid)) s.style.background = '#e2e6ea';
                        else s.style.background = '#28a745';
                        grid.appendChild(s);
                    }
                }
                minimap.appendChild(grid);
            }

            items.forEach(item => {
                let bArr = [];
                if (item.config.blocked) {
                    bArr = Array.isArray(item.config.blocked) ? item.config.blocked : String(item.config.blocked).split(',').filter(x => x.trim() !== '');
                }
                const total = (item.config.rows * item.config.cols) - bArr.length;
                
                const booked = item.bookings ? Object.keys(item.bookings).length : 0;
                let selecting = 0;
                if(item.temp_selections) {
                    Object.values(item.temp_selections).forEach(t => {
                        if(Date.now() - t.timestamp < 10 * 60 * 1000) selecting++;
                    });
                }
                const available = total - booked - selecting;
                const startTime = new Date(item.config.start).getTime();
                const endTime = new Date(item.config.end).getTime();
                const timeStr = new Date(item.config.start).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });

                let btnDisabled = '';
                let btnText = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ';
                let btnStyle = '';

                if (userRole !== 'admin') { 
                    if (now < startTime) { btnDisabled = 'disabled'; btnText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î'; btnStyle = 'background:#ccc; cursor:not-allowed;'; } 
                    else if (now > endTime) { btnDisabled = 'disabled'; btnText = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤'; btnStyle = 'background:#ccc; cursor:not-allowed;'; }
                } else {
                    if (now < startTime) btnText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î (Admin)';
                    else if (now > endTime) btnText = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (Admin)';
                }

                list.innerHTML += `
                    <div class="schedule-item">
                        <div class="schedule-info">
                            <strong style="font-size:1.1rem; color:#1a73e8;">üïí ${timeStr}</strong>
                            <div style="margin-top:8px;">
                                <span class="schedule-stats"><span class="stat-val" style="color:green">${available}</span> ‡∏ß‡πà‡∏≤‡∏á</span>
                                <span class="schedule-stats"><span class="stat-val" style="color:red">${booked}</span> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                                <span class="schedule-stats"><span class="stat-val" style="color:orange">${selecting}</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á</span>
                            </div>
                        </div>
                        <button class="btn-primary" ${btnDisabled} style="max-width:150px; ${btnStyle}" onclick="selectShowtime('${item.id}', 'movie')">${btnText}</button>
                    </div>
                `;
            });

        } else {
            document.getElementById('event-schedule-section').classList.remove('hidden');
            document.getElementById('event-booking-section').classList.add('hidden');
            
            const list = document.getElementById('event-schedule-list');
            list.innerHTML = '';
            
            const items = [];
            if(allData.events) {
                Object.entries(allData.events).forEach(([id, e]) => {
                    if(e.config.title === title) items.push({id, ...e});
                });
            }
            items.sort((a,b) => new Date(a.config.start) - new Date(b.config.start));

            if(items.length > 0) {
                const rep = items[0].config;
                document.getElementById('e-group-title').innerText = rep.title;
                const imgEl = document.getElementById('e-group-img');
                if(rep.image) { imgEl.src = rep.image; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; }
                document.getElementById('e-group-location').innerText = rep.location || '-';
                document.getElementById('e-group-ticket-type').innerText = rep.ticketType || '-';
                document.getElementById('e-group-price').innerText = rep.price || '0';
                document.getElementById('e-group-detail').innerText = rep.detail || '';
            }

            items.forEach(item => {
                const cap = item.config.capacity;
                const cur = item.currentBooked || 0;
                const remain = cap === -1 ? '‚àû' : (cap - cur);
                const startTime = new Date(item.config.start).getTime();
                const endTime = new Date(item.config.end).getTime();
                const timeStr = new Date(item.config.start).toLocaleString();
                
                const isFull = (cap !== -1 && cur >= cap);
                let btnDisabled = '';
                let btnText = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ';
                let btnStyle = '';

                if (userRole !== 'admin') {
                    if (now < startTime) { btnDisabled = 'disabled'; btnText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î'; btnStyle = 'background:#ccc; cursor:not-allowed;'; } 
                    else if (now > endTime) { btnDisabled = 'disabled'; btnText = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤'; btnStyle = 'background:#ccc; cursor:not-allowed;'; } 
                    else if (isFull) { btnDisabled = 'disabled'; btnText = '‡πÄ‡∏ï‡πá‡∏°'; btnStyle = 'background:#ccc; cursor:not-allowed;'; }
                } else {
                    if (now < startTime) btnText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î (Admin)';
                    else if (now > endTime) btnText = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (Admin)';
                    else if (isFull) { btnText = '‡∏à‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏ô (Admin)'; btnStyle = 'background:#f39c12'; }
                }

                list.innerHTML += `
                     <div class="schedule-item">
                        <div class="schedule-info">
                            <strong style="font-size:1.1rem; color:#d93025;">üïí ${timeStr}</strong>
                            <div style="margin-top:8px;">
                                <span class="schedule-stats">‡∏ß‡πà‡∏≤‡∏á: <span class="stat-val">${remain}</span></span>
                                <span class="schedule-stats">‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${cap === -1 ? '‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î' : cap}</span>
                            </div>
                        </div>
                        <button class="btn-primary" ${btnDisabled} style="max-width:150px; ${btnStyle}" onclick="selectShowtime('${item.id}', 'event')">${btnText}</button>
                    </div>
                `;
            });
        }
    }

    window.checkTime = (s, e) => {
        if(userRole === 'admin') return true; 
        const n = new Date();
        if(n < new Date(s)) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á"); return false; }
        if(n > new Date(e)) { alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß"); return false; }
        return true;
    }

    // --- Select Specific Showtime ---
    window.selectShowtime = (id, type) => {
        currentId = id;
        currentType = type;
        
        if(type === 'movie') {
            document.getElementById('movie-schedule-section').classList.add('hidden');
            document.getElementById('movie-seat-section').classList.remove('hidden');

            onValue(ref(db, `movies/${id}/config`), (snap) => {
                currentConfig = snap.val();
                if(!currentConfig) return;
                document.getElementById('m-round-time').innerText = new Date(currentConfig.start).toLocaleString();
                renderSeatsBase(currentConfig);
            }, { onlyOnce: true });

            onValue(ref(db, `movies/${id}`), (snap) => {
                const data = snap.val() || {};
                if(currentId === id && !document.getElementById('movie-seat-section').classList.contains('hidden')) {
                     updateSeatStatus(data.bookings || {}, data.temp_selections || {});
                }
            });

        } else {
            document.getElementById('event-schedule-section').classList.add('hidden');
            document.getElementById('event-booking-section').classList.remove('hidden');
            
            onValue(ref(db, `events/${id}`), (snap) => {
                const d = snap.val(); if(!d) return;
                currentConfig = d.config;
                const cap = d.config.capacity;
                const cur = d.currentBooked || 0;
                
                document.getElementById('e-round-time').innerText = new Date(currentConfig.start).toLocaleString();
                document.getElementById('e-remaining').innerText = cap==-1 ? '‚àû' : (cap - cur);
                document.getElementById('e-capacity').innerText = cap==-1 ? '‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î' : cap;

                const btn = document.getElementById('btn-event-book');
                const isFull = (cap!=-1 && cur>=cap);
                
                if(isFull && userRole !== 'admin') { 
                    btn.disabled=true; btn.innerText="‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß"; btn.style.background="#ccc"; 
                } else { 
                    btn.disabled=false; 
                    btn.innerText = (isFull && userRole==='admin') ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏ô (Admin)" : "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£";
                    btn.style.background = (isFull && userRole==='admin') ? "#f39c12" : "#1a73e8"; 
                    
                    btn.onclick=()=> {
                         if(!window.checkTime(currentConfig.start, currentConfig.end) && userRole !== 'admin') return;
                         window.openBookingModal("‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô");
                    }
                }
            });
        }
    }

    window.backToSchedule = () => {
        if(tempSeatRef) cancelSelection();
        const title = currentConfig ? currentConfig.title : document.getElementById('m-group-title').innerText;
        window.openGroupPage(title, currentType, false);
    }

    function renderSeatsBase(conf) {
        const map = document.getElementById('seat-map');
        map.innerHTML = '';
        map.style.gridTemplateColumns = `repeat(${conf.cols}, 1fr)`;
        
        let blockedList = [];
        if (conf.blocked) {
            blockedList = Array.isArray(conf.blocked) ? conf.blocked : String(conf.blocked).split(',').map(x => x.trim());
        }

        for(let r=0; r<conf.rows; r++) {
            const rowLabel = String.fromCharCode(65 + r);
            for(let c=1; c<=conf.cols; c++) {
                const seatId = `${rowLabel}${c}`;
                const seat = document.createElement('div');
                seat.className = 'seat available';
                seat.id = `seat-${seatId}`;
                seat.innerText = seatId;
                
                if(blockedList.includes(seatId)) {
                    seat.classList.add('blocked'); seat.classList.remove('available');
                } else {
                    seat.onclick = () => window.selectSeat(seatId);
                }
                map.appendChild(seat);
            }
        }
    }

    function updateSeatStatus(bookings, temps) {
        const myUid = currentUser ? currentUser.uid : guestId;
        
        document.querySelectorAll('.seat').forEach(s => {
            const sid = s.id.replace('seat-', '');
            if(s.classList.contains('blocked')) return;
            
            s.className = 'seat available'; 
            s.onclick = () => window.selectSeat(sid);

            if(bookings[sid]) {
                if(bookings[sid].paymentStatus === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' && bookings[sid].uid === myUid) {
                    s.className = 'seat pending';
                    s.onclick = () => { window.openPayLaterModal('movie', currentId, sid, currentConfig.price || 0); };
                } else {
                    s.className = 'seat booked'; s.onclick = null;
                }
            } else if(temps[sid]) {
                if (Date.now() - temps[sid].timestamp < 10 * 60 * 1000) { 
                    s.className = 'seat selecting'; s.onclick = null;
                }
            }
        });
    }

    window.selectSeat = (seatId) => {
        if(!window.checkTime(currentConfig.start, currentConfig.end) && userRole !== 'admin') return;
        
        const tempRef = ref(db, `movies/${currentId}/temp_selections/${seatId}`);
        const userIdToUse = currentUser ? currentUser.uid : guestId;
        runTransaction(tempRef, (curr) => {
            if (curr === null || Date.now() - curr.timestamp > 10 * 60 * 1000) {
                return { timestamp: Date.now(), user_uid: userIdToUse };
            }
            return;
        }).then((res) => {
            if (res.committed) {
                selectedTarget = seatId;
                tempSeatRef = tempRef;
                onDisconnect(tempRef).remove();
                window.openBookingModal(`‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: ${seatId}`);
            } else alert("‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö");
        });
    }

    window.openBookingModal = (detail) => {
        document.getElementById('booking-form-section').classList.remove('hidden');
        document.getElementById('payment-section').classList.add('hidden');
        document.getElementById('inp-slip-url').value = '';
        clearInterval(paymentTimerInterval);

        document.getElementById('modal-subtitle').innerText = detail;
        const modal = document.getElementById('booking-modal');
        if(currentUser) {
            document.getElementById('inp-conf-name').value = userData.name || '';
            document.getElementById('inp-conf-phone').value = userData.phone || '';
            document.getElementById('inp-conf-email').value = userData.email || currentUser.email;
            document.getElementById('inp-conf-idcard').value = userData.idCard || '';
            
            document.getElementById('inp-conf-name').readOnly = true;
            document.getElementById('inp-conf-phone').readOnly = true;
            document.getElementById('inp-conf-email').readOnly = true;
            document.getElementById('inp-conf-idcard').readOnly = true;
             ['name','phone','email','idcard'].forEach(k => document.getElementById(`inp-conf-${k}`).style.backgroundColor = '#f0f0f0');
        } else {
            document.getElementById('inp-conf-name').value = '';
            document.getElementById('inp-conf-phone').value = '';
            document.getElementById('inp-conf-email').value = '';
            document.getElementById('inp-conf-idcard').value = '';
             ['name','phone','email','idcard'].forEach(k => {
                 const el = document.getElementById(`inp-conf-${k}`);
                 el.readOnly = false;
                 el.style.backgroundColor = '#fff';
             });
        }
        modal.classList.add('active');
    }

    window.cancelSelection = () => {
        clearInterval(paymentTimerInterval);
        document.getElementById('booking-modal').classList.remove('active');
        if(currentType === 'movie' && tempSeatRef) {
            remove(tempSeatRef);
            onDisconnect(tempSeatRef).cancel();
            tempSeatRef = null; selectedTarget = '';
        }
    }

    window.proceedToPayment = () => {
        const bName = document.getElementById('inp-conf-name').value.trim();
        const bPhone = document.getElementById('inp-conf-phone').value.trim();
        const bEmail = document.getElementById('inp-conf-email').value.trim();
        if(!bName || !bPhone || !bEmail) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£, ‡∏≠‡∏µ‡πÄ‡∏°‡∏•)"); return; }

        let existingBookings = {};
        if(currentType === 'movie') existingBookings = (allData.movies[currentId] && allData.movies[currentId].bookings) || {};
        else existingBookings = (allData.events[currentId] && allData.events[currentId].bookings) || {};

        let isDup = false;
        Object.values(existingBookings).forEach(b => {
            if(b.email === bEmail) isDup = true;
            if(currentUser && b.uid === currentUser.uid && b.uid !== 'guest') isDup = true;
        });

        if(isDup) {
            if(userRole === 'admin') {
                if(!confirm("‚ö†Ô∏è ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏à‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß (Admin Override) ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            } else {
                alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏≥‡∏Å‡∏±‡∏î 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö)");
                return;
            }
        }

        const price = parseInt(currentConfig.price) || 0;
        if(price === 0) {
            processFinalBooking("");
            return;
        }

        document.getElementById('booking-form-section').classList.add('hidden');
        document.getElementById('payment-section').classList.remove('hidden');
        document.getElementById('pay-amount').innerText = price;
        document.getElementById('pay-qrcode').src = `https://promptpay.io/${PROMPTPAY_NUMBER}/${price}.png`;

        startPaymentTimer(10 * 60); 
    }

    function startPaymentTimer(durationInSeconds) {
        clearInterval(paymentTimerInterval);
        let timer = durationInSeconds, minutes, seconds;
        const display = document.getElementById('pay-countdown');
        
        paymentTimerInterval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            display.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(paymentTimerInterval);
                alert("‚è≥ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
                window.cancelSelection();
            }
        }, 1000);
    }

    window.confirmPayment = () => {
        const slipUrl = document.getElementById('inp-slip-url').value.trim();
        if(!slipUrl) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (URL)"); return; }
        processFinalBooking(slipUrl);
    }

    window.payLater = () => {
        processFinalBooking("", "‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");
    }

    function processFinalBooking(slipUrl, customStatus = null) {
        clearInterval(paymentTimerInterval);

        const bName = document.getElementById('inp-conf-name').value.trim();
        const bPhone = document.getElementById('inp-conf-phone').value.trim();
        const bEmail = document.getElementById('inp-conf-email').value.trim();
        const bIdCard = document.getElementById('inp-conf-idcard').value.trim();

        let status = customStatus;
        if(!status) status = slipUrl ? '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : '‡∏ü‡∏£‡∏µ';

        const bookingData = {
            uid: currentUser ? currentUser.uid : 'guest', 
            name: bName, phone: bPhone, email: bEmail, idCard: bIdCard, timestamp: Date.now(),
            slipUrl: slipUrl, 
            paymentStatus: status
        };

        if(currentType === 'movie') {
            set(ref(db, `movies/${currentId}/bookings/${selectedTarget}`), bookingData).then(() => {
                if(tempSeatRef) remove(tempSeatRef);
                window.cancelSelection(); 
                if(status === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô') alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ");
                else alert("‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π E-Ticket ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á");
                window.backToSchedule(); 
            });
        } else {
            const eventRef = ref(db, `events/${currentId}`);
            runTransaction(eventRef, (data) => {
                if(data) {
                    if(data.config.capacity != -1 && (data.currentBooked||0) >= data.config.capacity) return;
                    data.currentBooked = (data.currentBooked || 0) + 1;
                } return data;
            }).then((res) => {
                if(res.committed) {
                    push(ref(db, `events/${currentId}/bookings`), bookingData);
                    window.cancelSelection(); 
                    if(status === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô') alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ");
                    else alert("‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π E-Ticket ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á");
                    window.backToSchedule(); 
                } else alert("‚ùå ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            });
        }
    }

    // --- PAY LATER & E-TICKET ---
    window.openPayLaterModal = (type, itemId, bookingKey, price) => {
        payLaterData = { type, itemId, bookingKey };
        document.getElementById('pl-amount').innerText = price;
        document.getElementById('pl-qrcode').src = `https://promptpay.io/${PROMPTPAY_NUMBER}/${price}.png`;
        document.getElementById('pl-slip-url').value = '';
        document.getElementById('pay-later-modal').classList.add('active');
    };

    window.submitPayLater = () => {
        const slipUrl = document.getElementById('pl-slip-url').value.trim();
        if(!slipUrl) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏™‡∏•‡∏¥‡∏õ"); return; }

        const { type, itemId, bookingKey } = payLaterData;
        const path = `${type === 'movie' ? 'movies' : 'events'}/${itemId}/bookings/${bookingKey}`;

        update(ref(db, path), {
            slipUrl: slipUrl,
            paymentStatus: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
            timestamp: Date.now() // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ
        }).then(() => {
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö");
            document.getElementById('pay-later-modal').classList.remove('active');
            if(!document.getElementById('page-profile').classList.contains('hidden')) window.showProfile();
        });
    };

    window.viewTicket = (title, location, dateStr, timeStr, seatLabel, userName, qrData) => {
        document.getElementById('t-title').innerText = title;
        document.getElementById('t-location').innerText = location || '-';
        document.getElementById('t-datetime').innerText = `${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr}`;
        document.getElementById('t-seat').innerText = seatLabel;
        document.getElementById('t-name').innerText = userName;
        document.getElementById('t-qrcode').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;
        document.getElementById('eticket-modal').classList.add('active');
    };

    window.downloadTicketPDF = () => {
        const element = document.getElementById('ticket-content');
        const opt = {
            margin:       0.5,
            filename:     'E-Ticket.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    };
    
    // --- Profile & History ---
    window.showProfile = () => {
        if(!currentUser) return; 
        window.showPage('page-profile');
        document.getElementById('p-name').value = userData.name || '';
        document.getElementById('p-phone').value = userData.phone || '';
        document.getElementById('p-idcard').value = userData.idCard || '';

        const hList = document.getElementById('history-list');
        hList.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</td></tr>';
        
        const myHistory = [];
        const myEmail = currentUser.email;

        if(allData.movies) {
            Object.entries(allData.movies).forEach(([mId, m]) => {
                if(m.bookings) {
                    Object.entries(m.bookings).forEach(([seatId, b]) => {
                        if(b.email === myEmail) {
                            myHistory.push({ 
                                timestamp: b.timestamp, itemTitle: m.config.title, detail: `‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á ${seatId}`, 
                                slip: b.slipUrl, status: b.paymentStatus, type: 'movie', itemId: mId, bookingKey: seatId, 
                                price: m.config.price || 0, location: m.config.location, userName: b.name, eventDate: m.config.start
                            });
                        }
                    });
                }
            });
        }

        if(allData.events) {
            Object.entries(allData.events).forEach(([eId, e]) => {
                if(e.bookings) {
                    Object.entries(e.bookings).forEach(([bId, b]) => {
                        if(b.email === myEmail) {
                            myHistory.push({ 
                                timestamp: b.timestamp, itemTitle: e.config.title, detail: "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô", 
                                slip: b.slipUrl, status: b.paymentStatus, type: 'event', itemId: eId, bookingKey: bId, 
                                price: e.config.price || 0, location: e.config.location, userName: b.name, eventDate: e.config.start 
                            });
                        }
                    });
                }
            });
        }

        myHistory.sort((a,b) => b.timestamp - a.timestamp);

        hList.innerHTML = '';
        if(myHistory.length === 0) {
            hList.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ</td></tr>';
        } else {
            myHistory.forEach(h => {
                let actionHtml = '';
                
                if (h.status === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô') {
                    const timeLeftMin = Math.floor((10 * 60 * 1000 - (Date.now() - h.timestamp)) / 60000);
                    if (timeLeftMin >= 0) {
                        actionHtml = `<button class="btn-sm" style="background:#f39c12; color:white; margin-top:5px; font-weight:bold;" onclick="openPayLaterModal('${h.type}', '${h.itemId}', '${h.bookingKey}', ${h.price})">üí∞ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (${timeLeftMin} ‡∏ô‡∏≤‡∏ó‡∏µ)</button>`;
                    } else {
                        actionHtml = `<span style="color:red; font-size:0.8rem; display:block; margin-top:5px;">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>`;
                    }
                } else {
                    const qrDataStr = `TICKET|${h.type}|${h.itemId}|${h.bookingKey}|${h.userName}`;
                    const dateStr = new Date(h.eventDate).toLocaleDateString();
                    const timeStr = new Date(h.eventDate).toLocaleTimeString([], {timeStyle: 'short'});
                    
                    actionHtml = `
                        <button class="btn-sm" style="background:#8e44ad; color:white; margin-top:5px; font-weight:bold;" 
                        onclick="viewTicket('${h.itemTitle}', '${h.location || ''}', '${dateStr}', '${timeStr}', '${h.detail}', '${h.userName}', '${qrDataStr}')">
                        üé´ ‡∏î‡∏π E-Ticket</button>
                    `;
                    if (h.slip) {
                        actionHtml += `<a href="${h.slip}" target="_blank" style="font-size:0.8rem; color:#1a73e8; display:block; margin-top:5px;">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>`;
                    }
                }

                let badgeColor = h.status === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' ? '#f39c12' : (h.status === '‡∏ü‡∏£‡∏µ' ? '#2ecc71' : '#17a2b8');

                hList.innerHTML += `<tr>
                    <td>${new Date(h.timestamp).toLocaleDateString()} <br><small>${new Date(h.timestamp).toLocaleTimeString()}</small></td>
                    <td>${h.itemTitle} <br><small style="color:#666;">${h.detail}</small></td>
                    <td>
                        <span style="background:${badgeColor}; color:white; padding:3px 8px; border-radius:10px; font-size:0.8rem;">${h.status || '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß'}</span>
                        <div style="margin-top:5px;">${actionHtml}</div>
                    </td>
                </tr>`;
            });
        }
    }

    // --- Admin: Order Management ---
    window.showOrderManagement = () => {
        if(userRole !== 'admin') return;
        window.showPage('page-orders');
        const tbody = document.getElementById('all-orders-list');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
        
        let allBookings = [];
        
        if(allData.movies) {
            Object.entries(allData.movies).forEach(([mId, m]) => {
                if(m.bookings) {
                    Object.entries(m.bookings).forEach(([seatId, b]) => {
                        allBookings.push({
                            path: `movies/${mId}/bookings/${seatId}`,
                            type: 'movie', itemId: mId, seat: seatId,
                            title: m.config.title, data: b
                        });
                    });
                }
            });
        }
        if(allData.events) {
            Object.entries(allData.events).forEach(([eId, e]) => {
                if(e.bookings) {
                    Object.entries(e.bookings).forEach(([bId, b]) => {
                        allBookings.push({
                            path: `events/${eId}/bookings/${bId}`,
                            type: 'event', itemId: eId, seat: '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°',
                            title: e.config.title, data: b
                        });
                    });
                }
            });
        }
        
        allBookings.sort((a,b) => b.data.timestamp - a.data.timestamp);
        
        tbody.innerHTML = '';
        if(allBookings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
            return;
        }
        
        allBookings.forEach(order => {
            const b = order.data;
            const dDate = new Date(b.timestamp).toLocaleString();
            const slipLink = b.slipUrl ? `<a href="${b.slipUrl}" target="_blank" style="color:#1a73e8; font-weight:bold;">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>` : '-';
            
            const statusOpts = ['‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß', '‡∏ü‡∏£‡∏µ', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'];
            let selectHtml = `<select onchange="updateOrderStatus('${order.path}', this.value, '${order.type}', '${order.itemId}')" style="padding:5px; border-radius:4px; border:1px solid #ddd; font-family:'Sarabun';">`;
            statusOpts.forEach(opt => {
                selectHtml += `<option value="${opt}" ${b.paymentStatus === opt ? 'selected' : ''}>${opt}</option>`;
            });
            selectHtml += `</select>`;
            
            tbody.innerHTML += `<tr>
                <td>${dDate}</td>
                <td><b>${order.title}</b><br><small style="color:#666;">${order.type==='movie'?'‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: '+order.seat : order.seat}</small></td>
                <td>${b.name}<br><small>${b.phone} | ${b.email}</small></td>
                <td>${slipLink}</td>
                <td>
                    ${selectHtml}
                </td>
            </tr>`;
        });
    };

    window.updateOrderStatus = (path, newStatus, type, itemId) => {
        if(userRole !== 'admin') return;
        
        if(newStatus === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') {
            if(confirm("‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á/‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                remove(ref(db, path)).then(() => {
                    if(type === 'event') runTransaction(ref(db, `events/${itemId}/currentBooked`), (c) => (c || 1) - 1);
                    alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                });
            } else {
                if(!document.getElementById('page-orders').classList.contains('hidden')) window.showOrderManagement();
            }
        } else {
            const updates = { paymentStatus: newStatus };
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 10 ‡∏ô‡∏≤‡∏ó‡∏µ
            if (newStatus === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô') {
                updates.timestamp = Date.now();
                alert("‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà 10 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß");
            }
            update(ref(db, path), updates).then(() => {
                // UI ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å onValue
            });
        }
    };

    // --- Admin Ticket Types Management ---
    window.showTicketTypesManagement = () => {
        if(userRole !== 'admin') return;
        window.showPage('page-ticket-types');
        const list = document.getElementById('ticket-types-list');
        list.innerHTML = '';
        
        if (allData.ticketTypes) {
            Object.entries(allData.ticketTypes).forEach(([id, t]) => {
                list.innerHTML += `<tr>
                    <td>${t.name}</td>
                    <td>‡∏ø${t.price}</td>
                    <td>
                        <button class="btn-sm btn-edit" onclick="openTicketTypeModal('${id}', '${t.name}', ${t.price})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="btn-sm btn-del" onclick="deleteTicketType('${id}')">‡∏•‡∏ö</button>
                    </td>
                </tr>`;
            });
        } else {
            list.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</td></tr>';
        }
    }

    window.openTicketTypeModal = (id = '', name = '', price = '') => {
        if(userRole !== 'admin') return;
        document.getElementById('tt-modal-title').innerText = id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£';
        document.getElementById('tt-id').value = id;
        document.getElementById('tt-name').value = name;
        document.getElementById('tt-price').value = price;
        document.getElementById('ticket-type-modal').classList.add('active');
    }

    window.saveTicketType = (e) => {
        e.preventDefault();
        if(userRole !== 'admin') return;
        const id = document.getElementById('tt-id').value;
        const name = document.getElementById('tt-name').value;
        const price = parseInt(document.getElementById('tt-price').value);

        const targetRef = id ? ref(db, `ticketTypes/${id}`) : push(ref(db, 'ticketTypes'));
        
        set(targetRef, { name: name, price: price }).then(() => {
            document.getElementById('ticket-type-modal').classList.remove('active');
        });
    }

    window.deleteTicketType = (id) => {
        if(userRole !== 'admin') return;
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ?")) {
            remove(ref(db, `ticketTypes/${id}`));
        }
    }

    window.updatePriceFromType = () => {
        const select = document.getElementById('adm-ticket-type');
        const selectedOption = select.options[select.selectedIndex];
        const price = selectedOption.getAttribute('data-price');
        if(price !== null && price !== "") {
            document.getElementById('adm-price').value = price;
        }
    }

    function populateTicketTypeDropdown(selectedValue = '') {
        const select = document.getElementById('adm-ticket-type');
        select.innerHTML = '<option value="" data-price="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£ --</option>';
        if(allData.ticketTypes) {
            Object.values(allData.ticketTypes).forEach(t => {
                const isSelected = (t.name === selectedValue) ? 'selected' : '';
                select.innerHTML += `<option value="${t.name}" data-price="${t.price}" ${isSelected}>${t.name} (‡∏ø${t.price})</option>`;
            });
        }
        if(selectedValue && !select.querySelector(`option[value="${selectedValue}"]`)) {
            select.innerHTML += `<option value="${selectedValue}" data-price="" selected>${selectedValue} (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)</option>`;
        }
    }


    // --- Other Handlers ---
    window.handleAuth = (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;

        if(isRegistering) {
            createUserWithEmailAndPassword(auth, email, pass).then((cred) => {
                const code = document.getElementById('reg-admin-code').value;
                const role = (code === 'ADMIN999') ? 'admin' : 'user';
                set(ref(db, 'users/' + cred.user.uid), {
                    name: document.getElementById('reg-name').value,
                    phone: document.getElementById('reg-phone').value,
                    idCard: document.getElementById('reg-idcard').value,
                    email: email,
                    role: role
                });
            }).catch(err => alert("Error: " + err.message));
        } else {
            signInWithEmailAndPassword(auth, email, pass).then(()=>{
                window.goHome();
            }).catch(err => alert("Error: " + err.message));
        }
    };
    
    window.doLogout = () => { signOut(auth).then(()=>window.goHome()); };
    window.toggleAuthMode = () => {
        isRegistering = !isRegistering;
        document.getElementById('auth-title').innerText = isRegistering ? "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà" : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
        document.getElementById('btn-auth-submit').innerText = isRegistering ? "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
        document.getElementById('toggle-auth').innerText = isRegistering ? "‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
        document.getElementById('register-fields').classList.toggle('hidden');
    }
    window.updateUserProfile = (e) => {
        e.preventDefault();
        update(ref(db, `users/${currentUser.uid}`), {
            name: document.getElementById('p-name').value,
            phone: document.getElementById('p-phone').value
        }).then(() => alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
    }
    
    window.showUserManagement = () => {
        if(userRole !== 'admin') return;
        window.showPage('page-users');
        onValue(ref(db, 'users'), (snap) => {
            const list = document.getElementById('user-list-admin');
            list.innerHTML = '';
            snap.forEach(child => {
                const u = child.val();
                const uid = child.key;
                list.innerHTML += `<tr>
                    <td>${u.name || '-'}</td>
                    <td>${u.email}</td>
                    <td>${u.phone || '-'}</td>
                    <td>${u.idCard || '-'}</td>
                    <td><span class="tag ${u.role==='admin'?'event':'movie'}">${u.role}</span></td>
                    <td>
                        <button class="btn-sm" style="background:#17a2b8; color:white;" onclick="viewUserHistoryAdmin('${u.email}', '${u.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                        <button class="btn-sm btn-edit" onclick="editUserAdmin('${uid}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="btn-sm btn-del" onclick="deleteUserAdmin('${uid}')">‡∏•‡∏ö</button>
                    </td>
                </tr>`;
            });
        });
    }

    window.editUserAdmin = (uid) => {
        onValue(ref(db, 'users/' + uid), (snap) => {
            const u = snap.val();
            document.getElementById('edit-u-uid').value = uid;
            document.getElementById('edit-u-name').value = u.name || '';
            document.getElementById('edit-u-phone').value = u.phone || '';
            document.getElementById('edit-u-idcard').value = u.idCard || '';
            document.getElementById('edit-u-role').value = u.role || 'user';
            document.getElementById('user-edit-modal').classList.add('active');
        }, { onlyOnce: true });
    }
    window.saveUserAdmin = () => {
        const uid = document.getElementById('edit-u-uid').value;
        const updates = { 
            name: document.getElementById('edit-u-name').value, 
            phone: document.getElementById('edit-u-phone').value, 
            idCard: document.getElementById('edit-u-idcard').value,
            role: document.getElementById('edit-u-role').value 
        };
        update(ref(db, 'users/' + uid), updates).then(() => { 
            document.getElementById('user-edit-modal').classList.remove('active'); 
            alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); 
        });
    }
    window.deleteUserAdmin = (uid) => {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) remove(ref(db, 'users/' + uid));
    }

    window.openAdminModal = (type) => {
        if(userRole !== 'admin') return;
        document.getElementById('admin-modal').classList.add('active');
        document.getElementById('adm-id').value = '';
        document.getElementById('adm-type').value = type;
        document.getElementById('adm-title-text').innerText = `‡πÄ‡∏û‡∏¥‡πà‡∏° ${type}`;
        document.querySelectorAll('#admin-modal input:not([type=hidden]), #admin-modal textarea').forEach(i => i.value = '');
        
        populateTicketTypeDropdown('');

        if(type === 'movie') { document.getElementById('adm-movie-fields').classList.remove('hidden'); document.getElementById('adm-event-fields').classList.add('hidden'); } 
        else { document.getElementById('adm-movie-fields').classList.add('hidden'); document.getElementById('adm-event-fields').classList.remove('hidden'); }
    }
    window.closeAdminModal = () => document.getElementById('admin-modal').classList.remove('active');
    
    window.editItem = (id, type) => {
        if(userRole !== 'admin') return;
        window.openAdminModal(type);
        document.getElementById('adm-title-text').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        document.getElementById('adm-id').value = id;
        const data = (type==='movie' ? allData.movies[id].config : allData.events[id].config);
        
        document.getElementById('adm-title').value = data.title || '';
        document.getElementById('adm-start').value = data.start || '';
        document.getElementById('adm-end').value = data.end || '';
        document.getElementById('adm-image').value = data.image || '';
        document.getElementById('adm-detail').value = data.detail || '';
        document.getElementById('adm-location').value = data.location || '';
        document.getElementById('adm-price').value = data.price || '';

        populateTicketTypeDropdown(data.ticketType || '');

        if(type==='movie') { 
            document.getElementById('adm-rows').value = data.rows || ''; 
            document.getElementById('adm-cols').value = data.cols || ''; 
            document.getElementById('adm-blocked').value = data.blocked || ''; 
        } else { 
            document.getElementById('adm-cap').value = data.capacity || ''; 
        }
    }
    window.deleteItem = (id, type) => {
        if(userRole !== 'admin') return;
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) remove(ref(db, `${type==='movie'?'movies':'events'}/${id}`));
    }
    window.saveAdminItem = (e) => {
        e.preventDefault();
        if(userRole !== 'admin') return;
        const id = document.getElementById('adm-id').value;
        const type = document.getElementById('adm-type').value;
        const isNew = (id === '');
        
        const payload = { 
            title: document.getElementById('adm-title').value, 
            start: document.getElementById('adm-start').value, 
            end: document.getElementById('adm-end').value,
            image: document.getElementById('adm-image').value,
            detail: document.getElementById('adm-detail').value,
            location: document.getElementById('adm-location').value,
            ticketType: document.getElementById('adm-ticket-type').value,
            price: document.getElementById('adm-price').value
        };

        if(type === 'movie') { 
            payload.rows = parseInt(document.getElementById('adm-rows').value); 
            payload.cols = parseInt(document.getElementById('adm-cols').value); 
            payload.blocked = document.getElementById('adm-blocked').value; 
        } else { 
            payload.capacity = parseInt(document.getElementById('adm-cap').value); 
        }
        
        const targetRef = isNew ? push(ref(db, type === 'movie' ? 'movies' : 'events')) : ref(db, `${type === 'movie' ? 'movies' : 'events'}/${id}`);
        const updateData = isNew ? { config: payload } : { config: payload };
        if(isNew && type === 'event') updateData.currentBooked = 0;
        
        (isNew ? set(targetRef, updateData) : update(targetRef, { config: payload })).then(() => window.closeAdminModal());
    }
</script>

</body>
</html>
